<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>FA DB | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó.</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#060818;
    --card:#11152b;
    --muted:#a3acc7;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:"Segoe UI",Arial;background:var(--bg);color:#fff;}
  header{
    padding:18px 10px;
    text-align:center;
    background:linear-gradient(120deg,#0d47a1,#20c997);
    box-shadow:0 4px 14px rgba(0,0,0,.6);
  }
  header h1{margin:0;font-size:22px;font-weight:800;}
  header p{margin:4px 0 0;font-size:13px;color:var(--muted);}
  .wrap{max-width:1000px;margin:18px auto 30px;padding:0 16px;}
  .top-row{
    display:flex;justify-content:space-between;flex-wrap:wrap;
    gap:8px;font-size:13px;color:var(--muted);margin-bottom:10px;
  }
  .card{
    background:var(--card);
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    padding:14px 14px 10px;
    margin-bottom:14px;
    box-shadow:0 8px 20px rgba(0,0,0,.55);
  }
  h2{margin:0 0 10px;font-size:18px;}
  label{display:block;font-size:13px;margin-top:6px;}
  input,textarea{
    width:100%;margin-top:4px;padding:7px 8px;
    border-radius:8px;border:1px solid rgba(255,255,255,.18);
    background:#05081a;color:#fff;font-size:13px;
  }
  textarea{min-height:60px;resize:vertical;}
  input:focus,textarea:focus{
    outline:none;border-color:#20c997;
  }
  .form-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:8px 12px;
  }
  .btn-row{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;}
  button,.btn-link{
    border:none;border-radius:999px;
    padding:8px 14px;font-size:13px;cursor:pointer;
  }
  .btn-primary{background:#20c997;color:#000;font-weight:700;}
  .btn-secondary{background:#374151;color:#e5e7eb;}
  .btn-danger{background:#b91c1c;color:#fff;}
  table{
    width:100%;border-collapse:collapse;font-size:12px;margin-top:6px;
  }
  th,td{
    border:1px solid rgba(148,163,184,.4);
    padding:6px 5px;
  }
  th{background:#020617;font-weight:600;}
  tr:nth-child(even){background:rgba(15,23,42,.8);}
  .actions button{margin-right:4px;margin-bottom:2px;}
  .stat-box span{margin-right:10px;}
  a.nav{
    display:inline-block;margin-top:10px;margin-right:8px;
    color:#e0e7ff;text-decoration:none;font-size:13px;
  }
  input[type="file"]{padding:4px 0;}
</style>
</head>
<body>

<header>
  <h1>üèòÔ∏è FA DB ‚Äì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó.</h1>
  <p>Local Government Entities Database</p>
</header>

<div class="wrap">

  <div class="top-row">
    <div>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <strong id="userEmail">-</strong></div>
    <div class="stat-box">
      üëÅ ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: <strong id="statCurrent">0</strong>
      üîÑ ‡∏™‡∏∞‡∏™‡∏°: <strong id="statTotal">0</strong>
    </div>
  </div>

  <div class="card">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó.</h2>
    <form id="dataForm">
      <div class="form-grid">
        <div>
          <label>‡∏£‡∏´‡∏±‡∏™ ‡∏≠‡∏õ‡∏ó. (code)</label>
          <input type="text" id="f-code" required>
        </div>
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠ ‡∏≠‡∏õ‡∏ó. (name)</label>
          <input type="text" id="f-name" required>
        </div>
        <div>
          <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (province)</label>
          <input type="text" id="f-province">
        </div>
        <div>
          <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (district)</label>
          <input type="text" id="f-district">
        </div>
        <div>
          <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡∏≠‡∏õ‡∏ó. (type)</label>
          <input type="text" id="f-type" placeholder="‡∏≠‡∏ö‡∏ï./‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•/‡∏≠‡∏ö‡∏à. ‡∏Ø‡∏•‡∏Ø">
        </div>
      </div>
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (remark)</label>
      <textarea id="f-remark"></textarea>

      <div class="btn-row">
        <button type="submit" class="btn-primary" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button type="button" class="btn-secondary" id="btnClear">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó.</h2>
    <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">
      * ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå (localStorage: fa-db-data-local) ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ Export ‡πÄ‡∏õ‡πá‡∏ô CSV ‡πÑ‡∏î‡πâ
    </div>

    <div class="btn-row">
      <label style="font-size:12px;">
        üì• Import CSV:
        <input type="file" id="csvFile" accept=".csv">
      </label>
      <button type="button" class="btn-secondary" id="btnExport">üì§ Export CSV</button>
      <button type="button" class="btn-danger" id="btnDeleteAll">üóë ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>‡∏£‡∏´‡∏±‡∏™</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠ ‡∏≠‡∏õ‡∏ó.</th>
          <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
          <th>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</th>
          <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
          <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="dataBody"></tbody>
    </table>
  </div>

  <a href="fa-database-menu.html" class="nav">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
  <a href="index.html" class="nav">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>

</div>

<script>
const MODULE_KEY   = "local";
const STORAGE_KEY  = "fa-db-data-" + MODULE_KEY;
const TOTAL_KEY    = "fa-db-total-" + MODULE_KEY;
const SESSION_KEY  = "fa-db-session-" + MODULE_KEY;

let data = [];
let editIndex = -1;

/* ===== session check ===== */
function checkSession(){
  const raw = localStorage.getItem("fas-session");
  if(!raw){ location.href="fa-database-login.html"; return; }
  try{
    const s = JSON.parse(raw);
    if(Date.now()>s.expiresAt){
      localStorage.removeItem("fas-session");
      location.href="fa-database-login.html";
      return;
    }
    document.getElementById("userEmail").textContent = s.email || "-";
  }catch{
    location.href="fa-database-login.html";
  }
}

/* ===== stats ===== */
function updateStatsOnLoad(){
  const total = Number(localStorage.getItem(TOTAL_KEY) || "0") + 1;
  const curr  = Number(sessionStorage.getItem(SESSION_KEY) || "0") + 1;
  localStorage.setItem(TOTAL_KEY, String(total));
  sessionStorage.setItem(SESSION_KEY, String(curr));
  document.getElementById("statTotal").textContent = total;
  document.getElementById("statCurrent").textContent = curr;
}

/* ===== storage ===== */
function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    data = raw ? JSON.parse(raw) : [];
  }catch{ data=[]; }
}
function saveData(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

/* ===== render table ===== */
function renderTable(){
  const tbody = document.getElementById("dataBody");
  tbody.innerHTML = "";
  data.forEach((row,idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${row.code||""}</td>
      <td>${row.name||""}</td>
      <td>${row.province||""}</td>
      <td>${row.district||""}</td>
      <td>${row.type||""}</td>
      <td>${row.remark||""}</td>
      <td class="actions">
        <button type="button" onclick="editRow(${idx})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button type="button" onclick="deleteRow(${idx})">‡∏•‡∏ö</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* ===== form helpers ===== */
function clearForm(){
  document.getElementById("f-code").value="";
  document.getElementById("f-name").value="";
  document.getElementById("f-province").value="";
  document.getElementById("f-district").value="";
  document.getElementById("f-type").value="";
  document.getElementById("f-remark").value="";
  editIndex = -1;
  document.getElementById("btnSave").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
}

/* ===== CRUD ===== */
document.getElementById("dataForm").addEventListener("submit", e=>{
  e.preventDefault();
  const row = {
    code:     document.getElementById("f-code").value.trim(),
    name:     document.getElementById("f-name").value.trim(),
    province: document.getElementById("f-province").value.trim(),
    district: document.getElementById("f-district").value.trim(),
    type:     document.getElementById("f-type").value.trim(),
    remark:   document.getElementById("f-remark").value.trim(),
    updatedAt: new Date().toISOString()
  };
  if(editIndex === -1){
    row.createdAt = row.updatedAt;
    data.push(row);
  }else{
    data[editIndex] = {...data[editIndex], ...row};
  }
  saveData();
  renderTable();
  clearForm();
});

document.getElementById("btnClear").addEventListener("click", clearForm);

window.editRow = function(idx){
  const row = data[idx];
  document.getElementById("f-code").value     = row.code||"";
  document.getElementById("f-name").value     = row.name||"";
  document.getElementById("f-province").value = row.province||"";
  document.getElementById("f-district").value = row.district||"";
  document.getElementById("f-type").value     = row.type||"";
  document.getElementById("f-remark").value   = row.remark||"";
  editIndex = idx;
  document.getElementById("btnSave").textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
};

window.deleteRow = function(idx){
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
  data.splice(idx,1);
  saveData();
  renderTable();
};

document.getElementById("btnDeleteAll").addEventListener("click", ()=>{
  if(!confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ?")) return;
  data = [];
  saveData();
  renderTable();
});

/* ===== CSV Import/Export ===== */
function toCSV(){
  const header = ["code","name","province","district","type","remark"];
  const lines = [header.join(",")];
  data.forEach(r=>{
    const row = header.map(k=>{
      const v = (r[k]||"").toString().replace(/"/g,'""');
      return `"${v}"`;
    });
    lines.push(row.join(","));
  });
  return lines.join("\r\n");
}

document.getElementById("btnExport").addEventListener("click", ()=>{
  const csv = toCSV();
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "fa-db-local.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

document.getElementById("csvFile").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = evt=>{
    const text = evt.target.result;
    importCSV(text);
  };
  reader.readAsText(file,"utf-8");
});

function importCSV(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");
  if(lines.length<2){ alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•"); return; }
  const header = lines[0].split(",").map(h=>h.replace(/(^"|"$)/g,"").trim());
  const idxs = {
    code: header.indexOf("code"),
    name: header.indexOf("name"),
    province: header.indexOf("province"),
    district: header.indexOf("district"),
    type: header.indexOf("type"),
    remark: header.indexOf("remark")
  };
  for(const k in idxs){
    if(idxs[k]===-1){
      alert("‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: code,name,province,district,type,remark");
      return;
    }
  }
  const imported = [];
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(",").map(c=>c.replace(/(^"|"$)/g,""));
    if(cols.length===0) continue;
    imported.push({
      code: cols[idxs.code]||"",
      name: cols[idxs.name]||"",
      province: cols[idxs.province]||"",
      district: cols[idxs.district]||"",
      type: cols[idxs.type]||"",
      remark: cols[idxs.remark]||"",
      createdAt:new Date().toISOString(),
      updatedAt:new Date().toISOString()
    });
  }
  data = data.concat(imported);
  saveData();
  renderTable();
  alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: "+imported.length+" ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
}

/* ===== init ===== */
checkSession();
updateStatsOnLoad();
loadData();
renderTable();
</script>

</body>
</html>
