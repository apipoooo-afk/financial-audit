<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>FA DB | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#060818;
    --card:#11152b;
    --muted:#a3acc7;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:"Segoe UI",Arial;background:var(--bg);color:#fff;}
  header{
    padding:18px 10px;
    text-align:center;
    background:linear-gradient(120deg,#0d47a1,#6f42c1);
    box-shadow:0 4px 14px rgba(0,0,0,.6);
  }
  header h1{margin:0;font-size:22px;font-weight:800;}
  header p{margin:4px 0 0;font-size:13px;color:var(--muted);}
  .wrap{max-width:1000px;margin:18px auto 30px;padding:0 16px;}
  .top-row{
    display:flex;justify-content:space-between;flex-wrap:wrap;
    gap:8px;font-size:13px;color:var(--muted);margin-bottom:10px;
  }
  .card{
    background:var(--card);
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    padding:14px 14px 10px;
    margin-bottom:14px;
    box-shadow:0 8px 20px rgba(0,0,0,.55);
  }
  h2{margin:0 0 10px;font-size:18px;}
  label{display:block;font-size:13px;margin-top:6px;}
  input,textarea{
    width:100%;margin-top:4px;padding:7px 8px;
    border-radius:8px;border:1px solid rgba(255,255,255,.18);
    background:#05081a;color:#fff;font-size:13px;
  }
  textarea{min-height:60px;resize:vertical;}
  input:focus,textarea:focus{outline:none;border-color:#20c997;}
  .form-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:8px 12px;
  }
  .btn-row{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;}
  button,.nav{
    border:none;border-radius:999px;
    padding:8px 14px;font-size:13px;cursor:pointer;
  }
  .btn-primary{background:#20c997;color:#000;font-weight:700;}
  .btn-secondary{background:#374151;color:#e5e7eb;}
  .btn-danger{background:#b91c1c;color:#fff;}
  table{
    width:100%;border-collapse:collapse;font-size:12px;margin-top:6px;
  }
  th,td{
    border:1px solid rgba(148,163,184,.4);
    padding:6px 5px;
  }
  th{background:#020617;font-weight:600;}
  tr:nth-child(even){background:rgba(15,23,42,.8);}
  .actions button{margin-right:4px;margin-bottom:2px;}
  .stat-box span{margin-right:10px;}
  a.nav{
    display:inline-block;margin-top:10px;margin-right:8px;
    color:#e0e7ff;text-decoration:none;font-size:13px;
  }
  input[type="file"]{padding:4px 0;}

  /* search zone */
  .search-grid{
    margin-top:6px;
  }
  .search-grid label{
    font-size:12px;
    margin-top:0;
  }
  .search-grid input{
    font-size:12px;
    padding:5px 8px;
  }
</style>
</head>
<body>

<header>
  <h1>üèõÔ∏è FA DB ‚Äì ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</h1>
  <p>Central Government Agencies Database (Linked to All FA Systems)</p>
</header>

<div class="wrap">

  <div class="top-row">
    <div>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <strong id="userEmail">-</strong></div>
    <div class="stat-box">
      üëÅ ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: <strong id="statCurrent">0</strong>
      üîÑ ‡∏™‡∏∞‡∏™‡∏°: <strong id="statTotal">0</strong>
    </div>
  </div>

  <div class="card">
    <h2>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ + ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à</h2>
    <form id="dataForm">
      <div class="form-grid">
        <div>
          <label>‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (code)</label>
          <input type="text" id="f-code" required>
        </div>
        <div>
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (name)</label>
          <input type="text" id="f-name" required>
        </div>
        <div>
          <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à (audit unit)</label>
          <input type="text" id="f-unit" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏•‡∏±‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• / ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏• ‡∏Ø‡∏•‡∏Ø">
        </div>
        <div>
          <label>‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á (ministry)</label>
          <input type="text" id="f-ministry">
        </div>
        <div>
          <label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (level)</label>
          <input type="text" id="f-level" placeholder="‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á/‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ/‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡∏Ø‡∏•‡∏Ø">
        </div>
        <div>
          <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î (province)</label>
          <input type="text" id="f-province">
        </div>
        <div>
          <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡πÄ‡∏Ç‡∏ï (district)</label>
          <input type="text" id="f-district">
        </div>
        <div>
          <label>‡∏ï‡∏≥‡∏ö‡∏• / ‡πÅ‡∏Ç‡∏ß‡∏á (subdistrict)</label>
          <input type="text" id="f-subdistrict">
        </div>
        <div>
          <label>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô / ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô (village)</label>
          <input type="text" id="f-village">
        </div>
      </div>
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (remark)</label>
      <textarea id="f-remark"></textarea>

      <div class="btn-row">
        <button type="submit" class="btn-primary" id="btnSave">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        <button type="button" class="btn-secondary" id="btnClear">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
    </form>
  </div>

  <div class="card">
    <h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à</h2>
    <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">
      * ‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage: <strong>fa-db-data-gov</strong><br>
      * ‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á (Master) ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö FA, Tracking, Review, Learning, Cash Board ‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô key ‡∏ô‡∏µ‡πâ<br>
      * ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á CSV: <code>code,name,unit,ministry,level,province,district,subdistrict,village,remark</code>
    </div>

    <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
    <div style="font-size:12px;color:var(--muted);margin-top:4px;">
      üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏° ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à / ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡∏ï‡∏≥‡∏ö‡∏• / ‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô
    </div>
    <div class="form-grid search-grid">
      <div>
        <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à</label>
        <input type="text" id="s-unit" class="search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à">
      </div>
      <div>
        <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
        <input type="text" id="s-province" class="search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î">
      </div>
      <div>
        <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ / ‡πÄ‡∏Ç‡∏ï</label>
        <input type="text" id="s-district" class="search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï">
      </div>
      <div>
        <label>‡∏ï‡∏≥‡∏ö‡∏• / ‡πÅ‡∏Ç‡∏ß‡∏á</label>
        <input type="text" id="s-subdistrict" class="search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á">
      </div>
      <div>
        <label>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô / ‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</label>
        <input type="text" id="s-village" class="search-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô/‡∏ä‡∏∏‡∏°‡∏ä‡∏ô">
      </div>
    </div>
    <div class="btn-row">
      <button type="button" class="btn-secondary" id="btnSearchReset">‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>

    <div class="btn-row">
      <label style="font-size:12px;">
        üì• Import CSV:
        <input type="file" id="csvFile" accept=".csv">
      </label>
      <button type="button" class="btn-secondary" id="btnExport">üì§ Export CSV</button>
      <button type="button" class="btn-danger" id="btnDeleteAll">üóë ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>‡∏£‡∏´‡∏±‡∏™</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</th>
          <th>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à</th>
          <th>‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á</th>
          <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
          <th>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
          <th>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</th>
          <th>‡∏ï‡∏≥‡∏ö‡∏•</th>
          <th>‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</th>
          <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
        </tr>
      </thead>
      <tbody id="dataBody"></tbody>
    </table>
  </div>

  <a href="fa-database-menu.html" class="nav">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
  <a href="index.html" class="nav">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>

</div>

<script>
const MODULE_KEY   = "gov";
const STORAGE_KEY  = "fa-db-data-" + MODULE_KEY;
const TOTAL_KEY    = "fa-db-total-" + MODULE_KEY;
const SESSION_KEY  = "fa-db-session-" + MODULE_KEY;

let data = [];
let editIndex = -1;

/* element refs */
const fCode        = document.getElementById("f-code");
const fName        = document.getElementById("f-name");
const fUnit        = document.getElementById("f-unit");
const fMinistry    = document.getElementById("f-ministry");
const fLevel       = document.getElementById("f-level");
const fProvince    = document.getElementById("f-province");
const fDistrict    = document.getElementById("f-district");
const fSubdistrict = document.getElementById("f-subdistrict");
const fVillage     = document.getElementById("f-village");
const fRemark      = document.getElementById("f-remark");

function checkSession(){
  const raw = localStorage.getItem("fas-session");
  if(!raw){ location.href="fa-database-login.html"; return; }
  try{
    const s = JSON.parse(raw);
    if(Date.now()>s.expiresAt){
      localStorage.removeItem("fas-session");
      location.href="fa-database-login.html";
      return;
    }
    document.getElementById("userEmail").textContent = s.email || "-";
  }catch{
    location.href="fa-database-login.html";
  }
}

function updateStatsOnLoad(){
  const total = Number(localStorage.getItem(TOTAL_KEY) || "0") + 1;
  const curr  = Number(sessionStorage.getItem(SESSION_KEY) || "0") + 1;
  localStorage.setItem(TOTAL_KEY, String(total));
  sessionStorage.setItem(SESSION_KEY, String(curr));
  document.getElementById("statTotal").textContent = total;
  document.getElementById("statCurrent").textContent = curr;
}

function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    data = raw ? JSON.parse(raw) : [];
  }catch{ data=[]; }
}
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

function getFilters(){
  const fu = (document.getElementById("s-unit").value || "").trim().toLowerCase();
  const fp = (document.getElementById("s-province").value || "").trim().toLowerCase();
  const fd = (document.getElementById("s-district").value || "").trim().toLowerCase();
  const fsd= (document.getElementById("s-subdistrict").value || "").trim().toLowerCase();
  const fv = (document.getElementById("s-village").value || "").trim().toLowerCase();
  return {fu,fp,fd,fsd,fv};
}
function matchField(value, filter){
  if(!filter) return true;
  if(!value) return false;
  return value.toString().toLowerCase().includes(filter);
}

function renderTable(){
  const tbody = document.getElementById("dataBody");
  tbody.innerHTML = "";

  const f = getFilters();
  const rows = data.filter(row=>
    matchField(row.unit,        f.fu) &&
    matchField(row.province,    f.fp) &&
    matchField(row.district,    f.fd) &&
    matchField(row.subdistrict, f.fsd) &&
    matchField(row.village,     f.fv)
  );

  rows.forEach((row,idx)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${row.code||""}</td>
      <td>${row.name||""}</td>
      <td>${row.unit||""}</td>
      <td>${row.ministry||""}</td>
      <td>${row.level||""}</td>
      <td>${row.province||""}</td>
      <td>${row.district||""}</td>
      <td>${row.subdistrict||""}</td>
      <td>${row.village||""}</td>
      <td>${row.remark||""}</td>
      <td class="actions">
        <button type="button" onclick="editRow(${data.indexOf(row)})">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button type="button" onclick="deleteRow(${data.indexOf(row)})">‡∏•‡∏ö</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

function clearForm(){
  fCode.value="";
  fName.value="";
  fUnit.value="";
  fMinistry.value="";
  fLevel.value="";
  fProvince.value="";
  fDistrict.value="";
  fSubdistrict.value="";
  fVillage.value="";
  fRemark.value="";
  editIndex=-1;
  btnSave.textContent="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
}

document.getElementById("dataForm").addEventListener("submit", e=>{
  e.preventDefault();
  const row = {
    code:       fCode.value.trim(),
    name:       fName.value.trim(),
    unit:       fUnit.value.trim(),
    ministry:   fMinistry.value.trim(),
    level:      fLevel.value.trim(),
    province:   fProvince.value.trim(),
    district:   fDistrict.value.trim(),
    subdistrict:fSubdistrict.value.trim(),
    village:    fVillage.value.trim(),
    remark:     fRemark.value.trim(),
    updatedAt:new Date().toISOString()
  };
  if(editIndex===-1){
    row.createdAt=row.updatedAt;
    data.push(row);
  }else{
    data[editIndex]={...data[editIndex],...row};
  }
  saveData(); renderTable(); clearForm();
});
btnClear.addEventListener("click", clearForm);

window.editRow=function(idx){
  const r=data[idx];
  fCode.value       = r.code||"";
  fName.value       = r.name||"";
  fUnit.value       = r.unit||"";
  fMinistry.value   = r.ministry||"";
  fLevel.value      = r.level||"";
  fProvince.value   = r.province||"";
  fDistrict.value   = r.district||"";
  fSubdistrict.value= r.subdistrict||"";
  fVillage.value    = r.village||"";
  fRemark.value     = r.remark||"";
  editIndex=idx;
  btnSave.textContent="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç";
};
window.deleteRow=function(idx){
  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?")) return;
  data.splice(idx,1);
  saveData(); renderTable();
};

btnDeleteAll.addEventListener("click", ()=>{
  if(!confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏ô‡∏µ‡πâ?")) return;
  data=[]; saveData(); renderTable();
});

function toCSV(){
  const header=["code","name","unit","ministry","level","province","district","subdistrict","village","remark"];
  const lines=[header.join(",")];
  data.forEach(r=>{
    const row=header.map(k=>{
      const v=(r[k]||"").toString().replace(/"/g,'""');
      return `"${v}"`;
    });
    lines.push(row.join(","));
  });
  return lines.join("\r\n");
}
btnExport.addEventListener("click", ()=>{
  const csv=toCSV();
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;a.download="fa-db-gov.csv";
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

csvFile.addEventListener("change", e=>{
  const file=e.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=evt=>importCSV(evt.target.result);
  reader.readAsText(file,"utf-8");
});

function importCSV(text){
  const lines=text.split(/\r?\n/).filter(l=>l.trim()!=="");
  if(lines.length<2){alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");return;}
  const header=lines[0].split(",").map(h=>h.replace(/(^"|"$)/g,"").trim());
  const idxs={
    code:header.indexOf("code"),
    name:header.indexOf("name"),
    unit:header.indexOf("unit"),
    ministry:header.indexOf("ministry"),
    level:header.indexOf("level"),
    province:header.indexOf("province"),
    district:header.indexOf("district"),
    subdistrict:header.indexOf("subdistrict"),
    village:header.indexOf("village"),
    remark:header.indexOf("remark")
  };
  for(const k in idxs){
    if(idxs[k]===-1){
      alert("‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ: code,name,unit,ministry,level,province,district,subdistrict,village,remark");
      return;
    }
  }
  const imported=[];
  for(let i=1;i<lines.length;i++){
    const cols=lines[i].split(",").map(c=>c.replace(/(^"|"$)/g,""));
    if(cols.length===0) continue;
    imported.push({
      code:       cols[idxs.code]||"",
      name:       cols[idxs.name]||"",
      unit:       cols[idxs.unit]||"",
      ministry:   cols[idxs.ministry]||"",
      level:      cols[idxs.level]||"",
      province:   cols[idxs.province]||"",
      district:   cols[idxs.district]||"",
      subdistrict:cols[idxs.subdistrict]||"",
      village:    cols[idxs.village]||"",
      remark:     cols[idxs.remark]||"",
      createdAt:new Date().toISOString(),
      updatedAt:new Date().toISOString()
    });
  }
  data=data.concat(imported);
  saveData(); renderTable();
  alert("‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: "+imported.length+" ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£");
}

/* search events */
document.querySelectorAll(".search-input").forEach(el=>{
  el.addEventListener("input", renderTable);
});
document.getElementById("btnSearchReset").addEventListener("click", ()=>{
  document.getElementById("s-unit").value="";
  document.getElementById("s-province").value="";
  document.getElementById("s-district").value="";
  document.getElementById("s-subdistrict").value="";
  document.getElementById("s-village").value="";
  renderTable();
});

/* init */
checkSession();
updateStatsOnLoad();
loadData();
renderTable();
</script>

</body>
</html>
