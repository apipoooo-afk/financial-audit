<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>FA DB | ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó. (Import)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{
    --bg:#060818;
    --card:#11152b;
    --border:#262b46;
    --accent:#42a5f5;
    --success:#22c55e;
    --danger:#ef4444;
    --muted:#a3acc7;
    --text:#f5f7ff;
  }
  *{box-sizing:border-box;}

  body{
    margin:0;
    padding:0;
    font-family:"Segoe UI", Tahoma, sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  header{
    padding:18px 12px;
    text-align:center;
    background:linear-gradient(120deg,#0d47a1,#6f42c1,#22c55e);
    box-shadow:0 4px 16px rgba(0,0,0,.7);
  }

  header h1{
    margin:0;
    font-size:22px;
    font-weight:800;
  }
  header p{
    margin:4px 0 0;
    font-size:13px;
    color:var(--muted);
  }

  .wrap{
    max-width:1100px;
    margin:20px auto;
    padding:0 16px;
  }

  .card{
    background:var(--card);
    border-radius:16px;
    padding:16px;
    border:1px solid rgba(255,255,255,.12);
    margin-bottom:18px;
    box-shadow:0 8px 22px rgba(0,0,0,.65);
  }

  h2{
    margin:0 0 10px;
    font-size:18px;
    font-weight:700;
  }

  input,button{
    font-family:"Segoe UI", Tahoma;
    font-size:14px;
  }

  #importBox{
    border:2px dashed var(--accent);
    padding:25px;
    text-align:center;
    border-radius:16px;
    background:rgba(255,255,255,0.05);
  }

  #importBtn{
    padding:10px 20px;
    background:var(--accent);
    border:none;
    color:#000;
    border-radius:999px;
    cursor:pointer;
    font-weight:700;
  }

  #progress{
    margin-top:10px;
    font-size:13px;
    color:var(--muted);
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:12px;
  }
  th,td{
    border:1px solid #374151;
    padding:6px 8px;
  }
  th{
    background:#020617;
  }
  tr:nth-child(even){
    background:#111827;
  }

  .nav{
    display:inline-block;
    padding:8px 14px;
    margin-right:8px;
    border-radius:999px;
    background:#374151;
    color:#fff;
    text-decoration:none;
    font-size:13px;
  }

  .tag-green{
    color:#22c55e;
  }
</style>
</head>

<body>

<header>
  <h1>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó. (Import to Master Database)</h1>
  <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CSV ¬∑ Excel ¬∑ JSON URL ‚Äì ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á fa-db-data-gov</p>
</header>

<div class="wrap">

  <!-- ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ -->
  <div style="font-size:13px; color:var(--muted); margin-bottom:10px;">
    ‚è± ‡πÄ‡∏ß‡∏•‡∏≤: <span id="nowTime">-</span>
  </div>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á Import -->
  <div class="card">
    <h2>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó.</h2>

    <div id="importBox">
      <button id="importBtn">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå / ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå URL</button>
      <br><br>

      <input type="file" id="fileInput" accept=".csv,.xls,.xlsx,.json" style="display:none;">

      <div style="margin-top:10px;">
        <input type="text" id="urlInput" placeholder="‡∏ß‡∏≤‡∏á URL JSON ‡πÄ‡∏ä‡πà‡∏ô https://..." 
               style="width:80%; padding:8px; border-radius:6px; background:#05081a; border:1px solid #374151; color:#fff;">
      </div>

      <button id="importUrlBtn" style="margin-top:10px; padding:8px 16px; border:none; background:#22c55e; border-radius:999px; cursor:pointer;">
        üåê ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å URL
      </button>

      <div id="progress"></div>
    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ -->
  <div class="card">
    <h2>‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h2>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå / URL</th>
          <th>‡∏Ç‡∏ô‡∏≤‡∏î</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</th>
        </tr>
      </thead>
      <tbody id="fileBoard"></tbody>
    </table>
  </div>

  <a class="nav" href="fa-db-local.html">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó.</a>
  <a class="nav" href="fa-db-data-gov.html">üìä ‡∏î‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á</a>

</div>

<script>
/* ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ */
function updateClock(){
  document.getElementById("nowTime").textContent =
    new Date().toLocaleString("th-TH");
}
setInterval(updateClock,1000);
updateClock();

/* ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á */
function saveToMasterDB(records){
  const KEY = "fa-db-data-gov";

  const old = JSON.parse(localStorage.getItem(KEY) || "[]");
  const merged = [...old, ...records];

  localStorage.setItem(KEY, JSON.stringify(merged));
}

/* ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå */
function addFileBoard(name,size){
  const list = JSON.parse(localStorage.getItem("fa-db-fileboard") || "[]");
  list.push({
    name:name,
    size:size,
    date:new Date().toLocaleString("th-TH")
  });
  localStorage.setItem("fa-db-fileboard", JSON.stringify(list));
  renderFileBoard();
}

/* ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ */
function renderFileBoard(){
  const list = JSON.parse(localStorage.getItem("fa-db-fileboard") || "[]");
  const tb = document.getElementById("fileBoard");
  tb.innerHTML = "";

  list.forEach((f,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${f.name}</td>
      <td>${f.size}</td>
      <td>${f.date}</td>
    `;
    tb.appendChild(tr);
  });
}

renderFileBoard();

/* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå */
document.getElementById("importBtn").addEventListener("click",()=>{
  document.getElementById("fileInput").click();
});

/* ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå CSV/Excel */
document.getElementById("fileInput").addEventListener("change", async(e)=>{
  const file = e.target.files[0];
  if(!file){ return; }

  document.getElementById("progress").textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...";

  const ext = file.name.split(".").pop().toLowerCase();

  let records = [];

  if(ext === "csv"){
    const text = await file.text();
    records = parseCSV(text);

  } else if(ext === "xls" || ext === "xlsx"){
    records = await parseExcel(file);

  } else {
    alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö");
    return;
  }

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
  saveToMasterDB(records);

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡∏ö‡∏≠‡∏£‡πå‡∏î
  addFileBoard(file.name, formatSize(file.size));

  document.getElementById("progress").innerHTML =
    `<span class='tag-green'>‚úî ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß ${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>`;
});

/* ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å URL JSON */
document.getElementById("importUrlBtn").addEventListener("click",async()=>{
  const url = document.getElementById("urlInput").value.trim();
  if(!url){ alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL"); return;}

  document.getElementById("progress").textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL...";

  try{
    const res = await fetch(url);
    const json = await res.json();

    if(!Array.isArray(json)){
      alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Array ‡∏Ç‡∏≠‡∏á Object");
      return;
    }

    saveToMasterDB(json);
    addFileBoard(url, "-");

    document.getElementById("progress").innerHTML =
      `<span class='tag-green'>‚úî ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å URL ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${json.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span>`;

  }catch(e){
    alert("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
  }
});

/* CSV Parser */
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const header = lines[0].split(",").map(h=>h.trim());
  const rows = [];

  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(",");
    const obj = {};
    header.forEach((h,idx)=>{
      obj[h] = cols[idx] ? cols[idx].trim() : "";
    });
    rows.push(obj);
  }

  return rows;
}

/* Excel Parser */
async function parseExcel(file){
  return new Promise((resolve)=>{
    const reader = new FileReader();
    reader.onload = function(e){
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data,{type:"array"});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet);
      resolve(json);
    };
    reader.readAsArrayBuffer(file);
  });
}

/* ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå */
function formatSize(size){
  if(size < 1024) return size+" B";
  if(size < 1024*1024) return (size/1024).toFixed(1)+" KB";
  return (size/(1024*1024)).toFixed(1)+" MB";
}
</script>

<!-- Excel Library -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</body>
</html>
