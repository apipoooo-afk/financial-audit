<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>FA DB | ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó. (Import ‚Üí fa-db-data-gov)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  :root{
    --bg:#060818;
    --card:#11152b;
    --border:#262b46;
    --accent:#42a5f5;
    --success:#22c55e;
    --danger:#ef4444;
    --muted:#a3acc7;
    --text:#f5f7ff;
  }
  *{box-sizing:border-box;}

  body{
    margin:0;
    padding:0;
    font-family:"Segoe UI", Tahoma, sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  header{
    padding:18px 12px;
    text-align:center;
    background:linear-gradient(120deg,#0d47a1,#6f42c1,#22c55e);
    box-shadow:0 4px 16px rgba(0,0,0,.7);
  }

  header h1{
    margin:0;
    font-size:22px;
    font-weight:800;
  }
  header p{
    margin:4px 0 0;
    font-size:13px;
    color:var(--muted);
  }

  .wrap{
    max-width:1100px;
    margin:20px auto;
    padding:0 16px;
  }

  .card{
    background:var(--card);
    border-radius:16px;
    padding:16px;
    border:1px solid rgba(255,255,255,.12);
    margin-bottom:18px;
    box-shadow:0 8px 22px rgba(0,0,0,.65);
  }

  h2{
    margin:0 0 10px;
    font-size:18px;
    font-weight:700;
  }

  #importBox{
    border:2px dashed var(--accent);
    padding:25px;
    text-align:center;
    border-radius:16px;
    background:rgba(255,255,255,0.05);
  }

  #importBtn{
    padding:10px 20px;
    background:var(--accent);
    border:none;
    color:#000;
    border-radius:999px;
    cursor:pointer;
    font-weight:700;
  }

  #progress{
    margin-top:10px;
    font-size:13px;
    color:var(--muted);
  }

  input,button{
    font-family:"Segoe UI", Tahoma;
    font-size:14px;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:12px;
  }
  th,td{
    border:1px solid #374151;
    padding:6px 8px;
  }
  th{
    background:#020617;
  }
  tr:nth-child(even){
    background:#111827;
  }

  .nav{
    display:inline-block;
    padding:8px 14px;
    margin-right:8px;
    border-radius:999px;
    background:#374151;
    color:#fff;
    text-decoration:none;
    font-size:13px;
  }

  .tag-green{
    color:#22c55e;
  }
</style>
</head>

<body>

<header>
  <h1>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó. (Import ‚Üí ‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á fa-db-data-gov)</h1>
  <p>‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CSV ¬∑ Excel ¬∑ JSON URL ‚Äì ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏•‡∏á localStorage["fa-db-data-gov"] ‡πÉ‡∏´‡πâ fa-db-data-gov.html ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
</header>

<div class="wrap">

  <!-- ‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤ -->
  <div style="font-size:13px; color:var(--muted); margin-bottom:10px;">
    ‚è± ‡πÄ‡∏ß‡∏•‡∏≤: <span id="nowTime">-</span>
  </div>

  <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á Import -->
  <div class="card">
    <h2>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó. ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á</h2>

    <div id="importBox">
      <button id="importBtn">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå / ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ (CSV, Excel)</button>
      <br><br>

      <input type="file" id="fileInput" accept=".csv,.xls,.xlsx,.json" style="display:none;">

      <div style="margin-top:10px;">
        <input type="text" id="urlInput" placeholder="‡∏ß‡∏≤‡∏á URL JSON ‡πÄ‡∏ä‡πà‡∏ô https://..."
               style="width:80%; padding:8px; border-radius:6px; background:#05081a; border:1px solid #374151; color:#fff;">
      </div>

      <button id="importUrlBtn" style="margin-top:10px; padding:8px 16px; border:none; background:#22c55e; border-radius:999px; cursor:pointer;">
        üåê ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å URL (JSON Array)
      </button>

      <div id="progress"></div>
    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ -->
  <div class="card">
    <h2>‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h2>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå / URL</th>
          <th>‡∏Ç‡∏ô‡∏≤‡∏î</th>
          <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</th>
        </tr>
      </thead>
      <tbody id="fileBoard"></tbody>
    </table>
  </div>

  <a class="nav" href="fa-db-local.html">‚¨Ö ‡πÄ‡∏°‡∏ô‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏≠‡∏õ‡∏ó.</a>
  <a class="nav" href="fa-db-data-gov.html">üìä ‡∏î‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á</a>
  <a class="nav" href="fa-lg-search.html">üîç ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>

</div>

<script>
/* ===== CLOCK ===== */
function updateClock(){
  document.getElementById("nowTime").textContent =
    new Date().toLocaleString("th-TH");
}
setInterval(updateClock,1000);
updateClock();

/* ===== KEY ‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á ===== */
const MASTER_KEY = "fa-db-data-gov";       // fa-db-data-gov.html ‡πÉ‡∏ä‡πâ‡∏≠‡πà‡∏≤‡∏ô KEY ‡∏ô‡∏µ‡πâ
const FILEBOARD_KEY = "fa-db-fileboard";   // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤

/* ===== ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢: ‡πÅ‡∏õ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‚Üí key ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô ===== */
function normalizeHeaderName(name){
  return name.toString().trim().toLowerCase()
    .replace(/\s+/g,"")
    .replace(/[().]/g,"");
}

/* mapping: header (‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©) ‚Üí field ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà fa-db-data-gov ‡πÉ‡∏ä‡πâ */
const HEADER_MAP = {
  code: [
    "code","‡∏£‡∏´‡∏±‡∏™","‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô","‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏õ‡∏ó","‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏õ‡∏ó","‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏õ‡∏ó"
  ],
  name: [
    "name","‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô","‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏õ‡∏ó","‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏õ‡∏ó","‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏õ‡∏ó","‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏õ‡∏ó"
  ],
  unit: [
    "unit","‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à"
  ],
  type: [
    "type","‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó","‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏≠‡∏õ‡∏ó","‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô"
  ],
  ministry: [
    "ministry","‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á","‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á"
  ],
  level: [
    "level","‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô","‡∏£‡∏∞‡∏î‡∏±‡∏ö"
  ],
  province: [
    "province","‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î"
  ],
  district: [
    "district","‡∏≠‡∏≥‡πÄ‡∏†‡∏≠","‡πÄ‡∏Ç‡∏ï","‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÄ‡∏Ç‡∏ï"
  ],
  subdistrict: [
    "subdistrict","‡∏ï‡∏≥‡∏ö‡∏•","‡πÅ‡∏Ç‡∏ß‡∏á","‡∏ï‡∏≥‡∏ö‡∏•‡πÅ‡∏Ç‡∏ß‡∏á"
  ],
  village: [
    "village","‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô","‡∏ä‡∏∏‡∏°‡∏ä‡∏ô","‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô‡∏ä‡∏∏‡∏°‡∏ä‡∏ô"
  ],
  address: [
    "address","‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà","‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà","‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏π‡πà‡∏ó‡∏µ‡πà","‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏π‡πà","‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà"
  ],
  zipcode: [
    "zipcode","‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå","‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå","postcode","zip"
  ],
  lat: [
    "lat","latitude","‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î","‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡∏∞‡∏ï‡∏¥‡∏à‡∏π‡∏î"
  ],
  long: [
    "long","lng","longitude","‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î","‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏•‡∏≠‡∏á‡∏à‡∏¥‡∏à‡∏π‡∏î"
  ],
  website: [
    "website","‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå","‡πÄ‡∏ß‡πá‡∏õ‡πÑ‡∏ã‡∏ï‡πå","url","websiteurl","‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏î‡πå"
  ],
  remark: [
    "remark","‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏","note","notes"
  ]
};

/* ‡∏™‡∏£‡πâ‡∏≤‡∏á mapping ‡∏Ç‡∏≠‡∏á header ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå ‚Üí field ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô */
function buildHeaderIndex(headerArray){
  const indexMap = {}; // canonicalKey ‚Üí index‡πÉ‡∏ô headerArray
  const normalized = headerArray.map(h=>normalizeHeaderName(h));

  for(const canonical in HEADER_MAP){
    const candidates = HEADER_MAP[canonical];
    for(let i=0;i<normalized.length;i++){
      if(candidates.includes(normalized[i])){
        indexMap[canonical] = i;
        break;
      }
    }
  }
  return indexMap;
}

/* ‡πÅ‡∏õ‡∏•‡∏á raw row (array ‡∏´‡∏£‡∏∑‡∏≠ object) ‚Üí object ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô */
function normalizeRecordFromArray(headerArray, rowArray){
  const idxMap = buildHeaderIndex(headerArray);
  const obj = {};

  for(const key in idxMap){
    const colIndex = idxMap[key];
    obj[key] = (rowArray[colIndex] || "").toString().trim();
  }

  // ‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ header ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å ‚Üí ‡πÑ‡∏°‡πà‡∏ó‡∏¥‡πâ‡∏á ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á
  // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ô‡∏ö‡πÑ‡∏õ‡πÉ‡∏ô remark ‡πÑ‡∏î‡πâ (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡πá‡πÄ‡∏û‡∏¥‡πà‡∏° logic ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)

  return obj;
}

function normalizeRecordFromObject(raw){
  const keys = Object.keys(raw);
  const normalizedKeys = keys.map(k=>normalizeHeaderName(k));
  const idxMap = buildHeaderIndex(keys.map(k=>k)); // ‡πÉ‡∏ä‡πâ header ‡πÄ‡∏î‡∏¥‡∏°

  const obj = {};

  for(const canonical in idxMap){
    const originalIndex = idxMap[canonical];
    const originalKey   = keys[originalIndex];
    obj[canonical] = (raw[originalKey] || "").toString().trim();
  }

  // ‡∏ñ‡πâ‡∏≤ code / name ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏•‡∏¢ ‡∏•‡∏≠‡∏á‡πÄ‡∏î‡∏≤‡∏à‡∏≤‡∏Å key ‡πÄ‡∏î‡∏¥‡∏° (‡∏Å‡∏±‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏≤‡∏¢)
  if(!obj.code && raw.code) obj.code = String(raw.code);
  if(!obj.name && raw.name) obj.name = String(raw.name);

  return obj;
}

/* ===== ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á MASTER_KEY ===== */
/* ‡∏ñ‡πâ‡∏≤ code ‡∏ã‡πâ‡∏≥ ‚Üí update ‡∏ó‡∏±‡∏ö, ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ code ‚Üí push ‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢ */
function saveToMasterDB(records){
  if(!Array.isArray(records) || records.length===0) return;

  let old;
  try{
    old = JSON.parse(localStorage.getItem(MASTER_KEY) || "[]");
    if(!Array.isArray(old)) old = [];
  }catch(e){
    old = [];
  }

  let insertCount = 0;
  let updateCount = 0;

  records.forEach(rec=>{
    const code = (rec.code || "").toString().trim();
    if(code){
      const idx = old.findIndex(r=> String(r.code||"").trim() === code);
      if(idx >= 0){
        // update
        old[idx] = {...old[idx], ...rec};
        updateCount++;
      }else{
        old.push(rec);
        insertCount++;
      }
    }else{
      // ‡πÑ‡∏°‡πà‡∏°‡∏µ code ‚Üí ‡πÅ‡∏ó‡∏£‡∏Å‡∏ï‡πà‡∏≠‡∏ó‡πâ‡∏≤‡∏¢
      old.push(rec);
      insertCount++;
    }
  });

  localStorage.setItem(MASTER_KEY, JSON.stringify(old));

  console.log("MASTER_DB updated:", {insertCount, updateCount, total: old.length});
  document.getElementById("progress").innerHTML =
    `<span class="tag-green">‚úî ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà ${insertCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ${updateCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${old.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô)</span>`;
}

/* ===== FILE BOARD (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤) ===== */
function addFileBoard(name,size){
  let list;
  try{
    list = JSON.parse(localStorage.getItem(FILEBOARD_KEY) || "[]");
    if(!Array.isArray(list)) list = [];
  }catch(e){
    list = [];
  }

  list.push({
    name:name,
    size:size,
    date:new Date().toLocaleString("th-TH")
  });

  localStorage.setItem(FILEBOARD_KEY, JSON.stringify(list));
  renderFileBoard();
}

function renderFileBoard(){
  let list;
  try{
    list = JSON.parse(localStorage.getItem(FILEBOARD_KEY) || "[]");
    if(!Array.isArray(list)) list = [];
  }catch(e){
    list = [];
  }

  const tb = document.getElementById("fileBoard");
  tb.innerHTML = "";

  if(list.length===0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="4" style="text-align:center;color:#9ca3af;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>`;
    tb.appendChild(tr);
    return;
  }

  list.forEach((f,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${f.name}</td>
      <td>${f.size}</td>
      <td>${f.date}</td>
    `;
    tb.appendChild(tr);
  });
}

renderFileBoard();

/* ===== ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å input file ===== */
document.getElementById("importBtn").addEventListener("click",()=>{
  document.getElementById("fileInput").click();
});

/* ===== ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå CSV / Excel ===== */
document.getElementById("fileInput").addEventListener("change", async(e)=>{
  const file = e.target.files[0];
  if(!file){ return; }

  const progress = document.getElementById("progress");
  progress.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...";

  const ext = file.name.split(".").pop().toLowerCase();
  let records = [];

  try{
    if(ext === "csv"){
      const text = await file.text();
      records = parseCSVToRecords(text);
    }else if(ext === "xls" || ext === "xlsx"){
      records = await parseExcelToRecords(file);
    }else if(ext === "json"){
      const text = await file.text();
      const raw = JSON.parse(text);
      if(Array.isArray(raw)){
        records = raw.map(r=>normalizeRecordFromObject(r));
      }else{
        alert("‡πÑ‡∏ü‡∏•‡πå JSON ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô Array ‡∏Ç‡∏≠‡∏á Object");
        progress.textContent = "";
        return;
      }
    }else{
      alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô CSV / XLSX / JSON)");
      progress.textContent = "";
      return;
    }

    progress.textContent = `‚è≥ ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß ${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á...`;

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á
    saveToMasterDB(records);

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏ü‡∏•‡πå
    addFileBoard(file.name, formatSize(file.size));

  }catch(err){
    console.error(err);
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
    progress.textContent = "";
  }
});

/* ===== ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å URL JSON ===== */
document.getElementById("importUrlBtn").addEventListener("click", async()=>{
  const url = document.getElementById("urlInput").value.trim();
  const progress = document.getElementById("progress");

  if(!url){
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å URL ‡∏Å‡πà‡∏≠‡∏ô");
    return;
  }

  progress.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL...";

  try{
    const res = await fetch(url);
    const json = await res.json();

    if(!Array.isArray(json)){
      alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô JSON Array ‡∏Ç‡∏≠‡∏á Object");
      progress.textContent = "";
      return;
    }

    const records = json.map(r=>normalizeRecordFromObject(r));

    progress.textContent = `‚è≥ ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß ${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á...`;

    saveToMasterDB(records);

    addFileBoard(url, "-");

  }catch(err){
    console.error(err);
    alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å URL ‡πÑ‡∏î‡πâ");
    progress.textContent = "";
  }
});

/* ===== CSV ‚Üí records (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô) ===== */
function parseCSVToRecords(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim()!=="");
  if(lines.length < 2){
    return [];
  }

  const header = lines[0].split(",").map(h=>h.replace(/(^"|"$)/g,"").trim());
  const records = [];

  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(",").map(c=>c.replace(/(^"|"$)/g,""));
    if(cols.length === 0) continue;

    const rec = normalizeRecordFromArray(header, cols);
    records.push(rec);
  }

  console.log("CSV parsed records:", records.length);
  return records;
}

/* ===== Excel ‚Üí records (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô) ===== */
async function parseExcelToRecords(file){
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data,{type:"array"});
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet, {defval:""});

        const records = json.map(r=>normalizeRecordFromObject(r));
        console.log("Excel parsed records:", records.length);
        resolve(records);
      }catch(err){
        reject(err);
      }
    };
    reader.onerror = reject;
    reader.readAsArrayBuffer(file);
  });
}

/* ===== format size ===== */
function formatSize(size){
  if(typeof size !== "number") return "-";
  if(size < 1024) return size + " B";
  if(size < 1024*1024) return (size/1024).toFixed(1)+" KB";
  return (size/(1024*1024)).toFixed(1)+" MB";
}
</script>

<!-- Excel Library -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</body>
</html>
