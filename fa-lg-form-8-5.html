<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>‡∏≠‡∏õ‡∏ó.8.5 ‚Äì ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô | FA ‚Äì Fieldwork</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- TinyMCE: Rich Text Editor (‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á) -->
<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js"
        referrerpolicy="origin"></script>

<style>
  :root{
    --bg:#060818;
    --card:#11152b;
    --border:#262b46;
    --accent:#42a5f5;
    --accent2:#26c6da;
    --muted:#a3acc7;
    --text:#f5f7ff;
    --danger:#ef5350;
    --warning:#ffc107;
    --success:#66bb6a;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:"Segoe UI",Tahoma,sans-serif;
    background:
      radial-gradient(circle at 10% 0%, rgba(123,30,60,0.36) 0, transparent 55%),
      radial-gradient(circle at 90% 100%, rgba(66,165,245,0.32) 0, transparent 55%),
      var(--bg);
    color:var(--text);
  }

  header{
    padding:14px 16px;
    background:linear-gradient(120deg,#7b1e3c,#0d47a1,#f48fb1);
    box-shadow:0 4px 18px rgba(0,0,0,0.5);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    position:sticky;
    top:0;
    z-index:20;
  }
  header .title-block{
    display:flex;
    flex-direction:column;
  }
  header h1{
    margin:0;
    font-size:20px;
    font-weight:700;
  }
  header p{
    margin:2px 0 0 0;
    font-size:12px;
    color:var(--muted);
  }
  .nav-buttons button{
    margin-left:6px;
  }

  main{
    max-width:1200px;
    margin:16px auto 32px;
    padding:0 12px 32px;
    display:grid;
    grid-template-columns:minmax(0,3fr) minmax(260px,1.1fr);
    gap:16px;
  }

  .section-card{
    background:var(--card);
    border-radius:12px;
    border:1px solid var(--border);
    padding:14px 16px 16px;
    margin-bottom:14px;
    box-shadow:0 10px 26px rgba(0,0,0,0.4);
  }
  .section-card h2{
    margin:0 0 8px;
    font-size:17px;
    border-bottom:1px solid rgba(255,255,255,0.08);
    padding-bottom:4px;
  }
  .section-card h3{
    margin:6px 0 6px;
    font-size:14px;
  }

  .form-row{
    margin-bottom:8px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  .form-row label{
    min-width:130px;
    font-size:13px;
    color:var(--muted);
  }
  select,input[type=text],input[type=date],input[type=number]{
    background:#0b1024;
    border:1px solid var(--border);
    border-radius:6px;
    padding:4px 8px;
    color:var(--text);
    font-size:13px;
  }

  table{
    width:100%;
    border-collapse:collapse;
    margin-top:6px;
    font-size:13px;
  }
  th,td{
    border:1px solid var(--border);
    padding:4px 6px;
  }
  th{background:#0b1024;}

  .btn{
    cursor:pointer;
    padding:6px 10px;
    border:none;
    border-radius:999px;
    font-size:12px;
    display:inline-flex;
    align-items:center;
    gap:4px;
  }
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-secondary{background:#303754;color:#fff;}
  .btn-danger{background:var(--danger);color:#fff;}
  .btn-warning{background:var(--warning);color:#000;}
  .btn-success{background:var(--success);color:#000;}
  .btn-ghost{background:transparent;color:var(--muted);border:1px dashed var(--border);}
  .btn-sm{padding:4px 8px;font-size:11px;}

  .attachments ul{
    list-style:none;
    padding-left:0;
    margin:4px 0;
  }
  .attachments li{
    margin-bottom:3px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:6px;
    font-size:12px;
  }

  /* ‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ (Checklist + QA Panel + Route) */
  aside{
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .checklist label{
    display:block;
    font-size:12px;
    margin-bottom:4px;
  }
  .badge{
    display:inline-block;
    padding:2px 6px;
    border-radius:999px;
    font-size:11px;
  }
  .badge-warning{background:rgba(255,193,7,0.12);color:var(--warning);}
  .badge-success{background:rgba(76,175,80,0.12);color:var(--success);}
  .badge-danger{background:rgba(239,83,80,0.12);color:var(--danger);}

  /* QA Panel (Spellcheck / AI ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö) */
  #qa-panel{
    max-height:280px;
    overflow-y:auto;
    font-size:12px;
  }
  #qa-panel h3{font-size:13px;}

  /* Modal ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏¥‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô & ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.6);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:99;
  }
  .modal{
    background:var(--card);
    border-radius:12px;
    border:1px solid var(--border);
    padding:16px;
    max-width:420px;
    width:90%;
    box-shadow:0 16px 38px rgba(0,0,0,0.7);
    font-size:13px;
  }
  .modal h3{margin-top:0;font-size:15px;}
  .modal-actions{
    margin-top:12px;
    text-align:right;
  }

  /* ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö */
  .system-search input{
    width:100%;
  }
  .system-search-list{
    margin-top:6px;
    font-size:12px;
  }
  .system-search-list button{
    display:block;
    width:100%;
    margin-bottom:4px;
    text-align:left;
  }

  /* Responsive */
  @media (max-width:900px){
    main{grid-template-columns:1fr;}
  }
</style>
</head>

<body>

<header>
  <div class="title-block">
    <h1>‡∏≠‡∏õ‡∏ó.8.5 ‚Äì ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô</h1>
    <p>FA ‚Äì Fieldwork | ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á fa-lg-fieldwork, a-lg-notes-2y, fa-db-wp</p>
  </div>
  <div class="nav-buttons">
    <!-- 18. ‡∏õ‡∏∏‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö / ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ / ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å -->
    <button class="btn btn-secondary btn-sm" onclick="window.history.back()">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
    <button class="btn btn-secondary btn-sm" onclick="goNextForm()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûú</button>
    <button class="btn btn-primary btn-sm" onclick="goHome()">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
  </div>
</header>

<main>
  <!-- ====== ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏´‡∏•‡∏±‡∏Å ====== -->
  <section>

    <!-- 14. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à + ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì -->
    <div class="section-card" id="section-basic">
      <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</h2>
      <div class="form-row">
        <label for="unit-select">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à</label>
        <select id="unit-select"></select>
      </div>
      <div class="form-row">
        <label for="year-select">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
        <select id="year-select"></select>
      </div>
      <div class="form-row">
        <label>‡∏á‡∏ß‡∏î‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
        <input type="text" id="period-display" disabled
               value="30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô 2565-2582" />
      </div>
      <div class="form-row">
        <button class="btn btn-primary btn-sm" id="btn-load">
          üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <button class="btn btn-secondary btn-sm" id="btn-new">
          üÜï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>
      <div class="form-row">
        <span class="badge badge-warning" id="status-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
      </div>
    </div>

    <!-- 1‚Äì2‚Äì3: ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå + ‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
    <div class="section-card" id="section-objective">
      <h2>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h2>
      <textarea id="objective-editor"></textarea>

      <div class="attachments" data-section="objective">
        <h3>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</h3>
        <ul id="att-objective"></ul>
        <!-- 2 & 3 & 12. ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå -->
        <button class="btn btn-secondary btn-sm"
                onclick="addAttachment('objective')">
          üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå/‡∏•‡∏¥‡∏á‡∏Å‡πå
        </button>
        <button class="btn btn-ghost btn-sm"
                onclick="autoAttachFromWP('objective')">
          üîó ‡πÅ‡∏ô‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        </button>
      </div>
    </div>

    <!-- 2‚Äì3: ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö + ‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ -->
    <div class="section-card" id="section-procedures">
      <h2>‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h2>
      <textarea id="procedures-editor"></textarea>

      <div class="attachments" data-section="procedures">
        <h3>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</h3>
        <ul id="att-procedures"></ul>
        <button class="btn btn-secondary btn-sm"
                onclick="addAttachment('procedures')">
          üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå/‡∏•‡∏¥‡∏á‡∏Å‡πå
        </button>
        <button class="btn btn-ghost btn-sm"
                onclick="autoAttachFromWP('procedures')">
          üîó ‡πÅ‡∏ô‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        </button>
      </div>
    </div>

    <!-- 3 + 17: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô + ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ -->
    <div class="section-card" id="section-table">
      <h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô</h2>
      <button class="btn btn-secondary btn-sm" onclick="addTableRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
      <table id="data-table">
        <thead>
          <tr>
            <th>‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
            <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
            <th>‡∏¢‡∏≠‡∏î‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
            <th>‡∏¢‡∏≠‡∏î‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô</th>
            <th>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á</th>
            <th>% ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</th>
            <th>‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á WP (fa-db-wp)</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏/‡∏≠‡∏∑‡πà‡∏ô‡πÜ</th>
            <th>‡∏•‡∏ö</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div class="attachments" data-section="table">
        <h3>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
        <ul id="att-table"></ul>
        <button class="btn btn-secondary btn-sm"
                onclick="addAttachment('table')">
          üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå/‡∏•‡∏¥‡∏á‡∏Å‡πå
        </button>
        <button class="btn btn-ghost btn-sm"
                onclick="autoAttachFromWP('table')">
          üîó ‡πÅ‡∏ô‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        </button>
      </div>
    </div>

    <!-- 4: Notes / Conclusion + AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ -->
    <div class="section-card" id="section-notes">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• / ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</h2>
      <textarea id="notes-editor"></textarea>

      <div class="form-row" style="margin-top:6px;">
        <button class="btn btn-warning btn-sm" id="btn-ai-summary">
          ü§ñ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° / ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£
        </button>
        <span style="font-size:11px;color:var(--muted);">
          *‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ
        </span>
      </div>

      <div class="attachments" data-section="notes">
        <h3>‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•</h3>
        <ul id="att-notes"></ul>
        <button class="btn btn-secondary btn-sm"
                onclick="addAttachment('notes')">
          üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏ü‡∏•‡πå/‡∏•‡∏¥‡∏á‡∏Å‡πå
        </button>
        <button class="btn btn-ghost btn-sm"
                onclick="autoAttachFromWP('notes')">
          üîó ‡πÅ‡∏ô‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
        </button>
      </div>
    </div>

    <!-- 13: ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ -->
    <div class="section-card" id="section-sign">
      <h2>‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠</h2>
      <div class="form-row">
        <label>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥</label>
        <input type="text" id="sign-prep-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" />
        <input type="text" id="sign-prep-pos" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" />
        <input type="date" id="sign-prep-date" />
      </div>
      <div class="form-row">
        <label>‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô</label>
        <input type="text" id="sign-review-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•" />
        <input type="text" id="sign-review-pos" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" />
        <input type="date" id="sign-review-date" />
      </div>
      <p style="font-size:11px;color:var(--muted);margin-top:6px;">
        *‡πÄ‡∏ß‡∏•‡∏≤ export / print ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ã‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏≤‡∏¢‡∏°‡∏∑‡∏≠
      </p>
    </div>

    <!-- 6,7,9,11: ‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å / ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î / Export / ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ -->
    <div class="section-card" id="section-actions">
      <h2>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h2>
      <div class="form-row">
        <!-- 5. ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î -->
        <button class="btn btn-warning btn-sm" id="btn-spellcheck">
          üîç ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        </button>
        <!-- 10. ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ -->
        <button class="btn btn-secondary btn-sm" id="btn-consult">
          üí¨ ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç
        </button>
      </div>

      <div class="form-row">
        <!-- 11. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏ô‡∏¥‡∏î export -->
        <label>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</label>
        <select id="export-type">
          <option value="print">‡∏û‡∏¥‡∏°‡∏û‡πå (Print/PDF)</option>
          <option value="json">JSON (‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</option>
          <option value="docx">‡πÑ‡∏ü‡∏•‡πå Word (.docx)</option>
          <option value="xlsx">‡πÑ‡∏ü‡∏•‡πå Excel (.xlsx)</option>
        </select>
      </div>

      <div class="form-row">
        <!-- 6. ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô -->
        <button class="btn btn-primary btn-sm" id="btn-save">
          üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö
        </button>
        <button class="btn btn-success btn-sm" id="btn-confirm-export">
          ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Checklist & Export / ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
        </button>
      </div>
    </div>

  </section>

  <!-- ====== ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: Checklist + QA + Route ====== -->
  <aside>

    <!-- 6. Checklist -->
    <div class="section-card" id="section-checklist">
      <h2>Checklist ‚Äì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</h2>
      <div class="checklist">
        <label><input type="checkbox" id="chk1"> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à / ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
        <label><input type="checkbox" id="chk2"> ‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
        <label><input type="checkbox" id="chk3"> ‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
        <label><input type="checkbox" id="chk4"> ‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß</label>
        <label><input type="checkbox" id="chk5"> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• / ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞</label>
        <label><input type="checkbox" id="chk6"> ‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</label>
        <label><input type="checkbox" id="chk7"> ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß</label>
      </div>
      <p style="font-size:11px;color:var(--muted);margin-top:6px;">
        ‡πÄ‡∏°‡∏∑‡πà‡∏≠ checklist ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠ ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Checklist & Export / ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‚Äù ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö  
        ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡πÉ‡∏î‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‚Äù ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‚Äù
      </p>
    </div>

    <!-- 5. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î / QA -->
    <div class="section-card" id="section-qa">
      <h2>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h2>
      <div id="qa-panel">
        <p style="font-size:12px;color:var(--muted);">
          ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î/‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‚Äù ‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≥‡∏™‡∏∞‡∏Å‡∏î‡∏ú‡∏¥‡∏î ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°  
          ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
        </p>
      </div>
    </div>

    <!-- 9,15,16,17: ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô + ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö -->
    <div class="section-card" id="section-route">
      <h2>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô</h2>
      <div class="system-search">
        <input type="text" id="system-search-input"
               placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (‡∏û‡∏¥‡∏°‡∏û‡πå: fieldwork, notes, wp, cashboard, review ... )" />
        <div class="system-search-list" id="system-search-list">
          <button class="btn btn-secondary btn-sm"
                  onclick="goFieldwork()">üìÇ FA ‚Äì Fieldwork (fa-lg-fieldwork.html)</button>
          <button class="btn btn-secondary btn-sm"
                  onclick="goNotes()">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏á‡∏ö 2 ‡∏õ‡∏µ (a-lg-notes-2y.html)</button>
          <button class="btn btn-secondary btn-sm"
                  onclick="goWorkpaper()">üìë ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (fa-db-wp.html)</button>
          <button class="btn btn-secondary btn-sm"
                  onclick="goCashboard()">üìä Cash Board (fa-db-data-gov / ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏ß‡πâ)</button>
          <button class="btn btn-secondary btn-sm"
                  onclick="goReview()">üîé ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô (fa-review-*.html)</button>
        </div>
      </div>
    </div>

  </aside>
</main>

<!-- 7 & 10: Modal ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏¥‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô / ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ -->
<div class="modal-backdrop" id="modal-warning">
  <div class="modal">
    <h3 id="modal-warning-title">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</h3>
    <div id="modal-warning-body">
      <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô -->
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary btn-sm" onclick="closeWarningModal()">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <button class="btn btn-warning btn-sm" onclick="askForGuidance()">‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
      <button class="btn btn-primary btn-sm" onclick="overrideAndContinue()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="modal-consult">
  <div class="modal">
    <h3>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</h3>
    <p>
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà ‚Äú‡∏Ç‡∏±‡∏î‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö‚Äù ‡∏ã‡πâ‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á  
      ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° / ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
    </p>
    <div class="modal-actions">
      <button class="btn btn-secondary btn-sm" onclick="closeConsultModal()">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</button>
      <button class="btn btn-primary btn-sm" onclick="confirmConsult()">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</button>
    </div>
  </div>
</div>

<script>
/* ==============================
   ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á (currentData)
   ============================== */
const DATA_TEMPLATE = {
  unit_id: '',
  fiscal_year: '',
  period_end: '',
  objective: '',
  procedures: '',
  table_rows: [],
  notes: '',
  attachments: {
    objective: [],
    procedures: [],
    table: [],
    notes: []
  },
  checklist: {},
  sign: {
    prep: {name:'', pos:'', date:''},
    review: {name:'', pos:'', date:''}
  }
};

let currentData = structuredClone(DATA_TEMPLATE);
let errorOverrideCount = 0;   // ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠ 7 + 10

/* ==============================
   TinyMCE init
   ============================== */
tinymce.init({
  selector: '#objective-editor,#procedures-editor,#notes-editor',
  height: 220,
  menubar: false,
  skin:'oxide-dark',
  content_css:'dark',
  plugins: [
    'advlist autolink lists link charmap preview anchor',
    'searchreplace visualblocks code fullscreen',
    'insertdatetime table code help wordcount'
    // ‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏° spellchecker / export / ai ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
  ],
  toolbar:
    'undo redo | formatselect | bold italic underline | ' +
    'alignleft aligncenter alignright alignjustify | ' +
    'bullist numlist | removeformat | code'
});

/* ==============================
   ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° dropdown ‡∏´‡∏ô‡πà‡∏ß‡∏¢ + ‡∏õ‡∏µ (‡∏Ç‡πâ‡∏≠ 14)
   ============================== */
function populateUnitYear(){
  const unitSelect = document.getElementById('unit-select');
  const yearSelect = document.getElementById('year-select');

  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å fa-db-data-gov ‡∏Å‡πá‡πÑ‡∏î‡πâ
  const units = [
    {id:'SSK-001', name:'‡∏≠‡∏ö‡∏à.‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©'},
    {id:'SSK-002', name:'‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©'},
    {id:'SSK-003', name:'‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ï‡∏≥‡∏ö‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á'}
  ];
  units.forEach(u=>{
    const opt = document.createElement('option');
    opt.value=u.id; opt.textContent=u.name;
    unitSelect.appendChild(opt);
  });

  for(let y=2565;y<=2582;y++){
    const opt = document.createElement('option');
    opt.value=y; opt.textContent=y;
    yearSelect.appendChild(opt);
  }

  yearSelect.addEventListener('change', ()=>{
    const y = yearSelect.value || '2565-2582';
    document.getElementById('period-display').value = `30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô ${y}`;
  });
}

/* ==============================
   ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô / ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏Ç‡πâ‡∏≠ 1,2,14)
   ============================== */
document.getElementById('btn-load').addEventListener('click', async ()=>{
  const unit = document.getElementById('unit-select').value;
  const year = document.getElementById('year-select').value;
  if(!unit || !year){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì'); return; }

  // TODO: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ backend ‡∏à‡∏£‡∏¥‡∏á
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: const res = await fetch(`/api/fa/lg/8_5?unit=${unit}&year=${year}`);
  // currentData = res.ok ? await res.json() : structuredClone(DATA_TEMPLATE);

  currentData = structuredClone(DATA_TEMPLATE);
  currentData.unit_id = unit;
  currentData.fiscal_year = year;
  currentData.period_end = `30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô ${year}`;

  document.getElementById('status-label').textContent = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${unit} ‡∏õ‡∏µ ${year} (‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‚Äì ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ê‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á)`;

  renderAll();
});

document.getElementById('btn-new').addEventListener('click', ()=>{
  currentData = structuredClone(DATA_TEMPLATE);
  document.getElementById('status-label').textContent = '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)';
  renderAll();
});

/* ==============================
   render ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏à‡∏≤‡∏Å currentData
   ============================== */
function renderAll(){
  // editor
  tinymce.get('objective-editor')?.setContent(currentData.objective || '');
  tinymce.get('procedures-editor')?.setContent(currentData.procedures || '');
  tinymce.get('notes-editor')?.setContent(currentData.notes || '');

  // table
  renderTable();

  // attachments
  renderAttachments('objective');
  renderAttachments('procedures');
  renderAttachments('table');
  renderAttachments('notes');

  // sign
  document.getElementById('sign-prep-name').value = currentData.sign.prep.name || '';
  document.getElementById('sign-prep-pos').value  = currentData.sign.prep.pos  || '';
  document.getElementById('sign-prep-date').value = currentData.sign.prep.date|| '';
  document.getElementById('sign-review-name').value = currentData.sign.review.name||'';
  document.getElementById('sign-review-pos').value  = currentData.sign.review.pos ||'';
  document.getElementById('sign-review-date').value = currentData.sign.review.date||'';

  // checklist
  const ck = currentData.checklist || {};
  ['chk1','chk2','chk3','chk4','chk5','chk6','chk7'].forEach(id=>{
    document.getElementById(id).checked = !!ck[id];
  });
}

/* ==============================
   ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ (‡∏Ç‡πâ‡∏≠ 3 + 17)
   ============================== */
function renderTable(){
  const tbody = document.querySelector('#data-table tbody');
  tbody.innerHTML = '';
  currentData.table_rows.forEach((row,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${row.code||''}" onchange="updateRow(${idx},'code',this.value)" /></td>
      <td><input type="text" value="${row.item||''}" onchange="updateRow(${idx},'item',this.value)" /></td>
      <td><input type="number" value="${row.current||''}" onchange="updateRow(${idx},'current',this.value)" /></td>
      <td><input type="number" value="${row.prior||''}" onchange="updateRow(${idx},'prior',this.value)" /></td>
      <td>${calcDiff(row)}</td>
      <td>${calcPct(row)}</td>
      <td>
        <input type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô WP-AR-O-01"
               value="${row.wp_ref||''}"
               onchange="updateRow(${idx},'wp_ref',this.value)" />
      </td>
      <td><input type="text" value="${row.note||''}" onchange="updateRow(${idx},'note',this.value)" /></td>
      <td><button class="btn btn-danger btn-sm" onclick="deleteRow(${idx})">‡∏•‡∏ö</button></td>
    `;
    tbody.appendChild(tr);
  });
}
function addTableRow(){
  currentData.table_rows.push({code:'',item:'',current:'',prior:'',wp_ref:'',note:''});
  renderTable();
}
function updateRow(idx,field,value){
  currentData.table_rows[idx][field] = value;
  renderTable();
}
function deleteRow(idx){
  currentData.table_rows.splice(idx,1);
  renderTable();
}
function calcDiff(row){
  const c=Number(row.current)||0, p=Number(row.prior)||0;
  return c-p;
}
function calcPct(row){
  const diff = calcDiff(row);
  const p = Number(row.prior)||0;
  if(!p) return '';
  return ((diff/p)*100).toFixed(2)+'%';
}

/* ==============================
   Attachments (‡∏Ç‡πâ‡∏≠ 2,3,12)
   ============================== */
function renderAttachments(section){
  const ul = document.getElementById(`att-${section}`);
  ul.innerHTML = '';
  (currentData.attachments[section] || []).forEach((att,idx)=>{
    const li = document.createElement('li');
    li.innerHTML = `
      <span><a href="${att.url}" target="_blank">${att.name}</a></span>
      <button class="btn btn-danger btn-sm"
              onclick="removeAttachment('${section}',${idx})">‡∏•‡∏ö</button>
    `;
    ul.appendChild(li);
  });
}
function addAttachment(section){
  const url = prompt('‡∏ß‡∏≤‡∏á URL ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå:');
  if(!url) return;
  const name = prompt('‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:','‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö');
  if(!name) return;
  currentData.attachments[section] = currentData.attachments[section] || [];
  currentData.attachments[section].push({name,url});
  renderAttachments(section);
}
function removeAttachment(section,idx){
  currentData.attachments[section].splice(idx,1);
  renderAttachments(section);
}

/* ‡πÅ‡∏ô‡∏ö‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏Ç‡πâ‡∏≠ 3 + 17) */
function autoAttachFromWP(section){
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÑ‡∏õ fa-db-wp ‡∏û‡∏£‡πâ‡∏≠‡∏° unit/year
  const unit = currentData.unit_id || document.getElementById('unit-select').value;
  const year = currentData.fiscal_year || document.getElementById('year-select').value;
  if(!unit || !year){
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Å‡πà‡∏≠‡∏ô');
    return;
  }
  const url = `fa-db-wp.html?unit=${encodeURIComponent(unit)}&year=${encodeURIComponent(year)}&from=8_5_${section}`;
  currentData.attachments[section] = currentData.attachments[section] || [];
  currentData.attachments[section].push({
    name:`‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á (${section})`,
    url
  });
  renderAttachments(section);
}

/* ==============================
   ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏Ç‡πâ‡∏≠ 1,2,6)
   ============================== */
document.getElementById('btn-save').addEventListener('click', async ()=>{
  collectFormToData();

  // TODO: ‡∏™‡πà‡∏á currentData ‡πÑ‡∏õ backend ‡∏à‡∏£‡∏¥‡∏á
  // await fetch('/api/fa/lg/8_5', { method:'POST', body:JSON.stringify(currentData) ... });

  console.log('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å currentData:', currentData);
  alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á log ‡∏ó‡∏µ‡πà console) ‚Äì ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° backend ‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ñ‡∏≤‡∏ß‡∏£‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
});

/* ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ currentData */
function collectFormToData(){
  currentData.objective = tinymce.get('objective-editor').getContent();
  currentData.procedures = tinymce.get('procedures-editor').getContent();
  currentData.notes = tinymce.get('notes-editor').getContent();

  currentData.sign.prep.name = document.getElementById('sign-prep-name').value;
  currentData.sign.prep.pos  = document.getElementById('sign-prep-pos').value;
  currentData.sign.prep.date = document.getElementById('sign-prep-date').value;
  currentData.sign.review.name = document.getElementById('sign-review-name').value;
  currentData.sign.review.pos  = document.getElementById('sign-review-pos').value;
  currentData.sign.review.date = document.getElementById('sign-review-date').value;

  currentData.checklist = {
    chk1: document.getElementById('chk1').checked,
    chk2: document.getElementById('chk2').checked,
    chk3: document.getElementById('chk3').checked,
    chk4: document.getElementById('chk4').checked,
    chk5: document.getElementById('chk5').checked,
    chk6: document.getElementById('chk6').checked,
    chk7: document.getElementById('chk7').checked
  };
}

/* ==============================
   ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î / QA (‡∏Ç‡πâ‡∏≠ 5)
   ============================== */
document.getElementById('btn-spellcheck').addEventListener('click', async ()=>{
  collectFormToData();

  // TODO: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å AI/Service ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î‡∏à‡∏£‡∏¥‡∏á
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á
  const result = {
    spelling:[
      '‚Äú‡∏•‡∏π‡∏´‡∏ô‡∏µ‡πâ‚Äù ‚Üí ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‚Äù',
      '‚Äú‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‚Äù ‚Üí ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‚Äù'
    ],
    incomplete:[
      '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 30%',
    ],
    guideline:[
      '‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô Subsequent Collection ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏Ñ‡πâ‡∏≤‡∏á‡πÄ‡∏Å‡∏¥‡∏ô 90 ‡∏ß‡∏±‡∏ô',
    ]
  };

  const panel = document.getElementById('qa-panel');
  panel.innerHTML = `
    <h3>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h3>
    <strong>‡∏Ñ‡∏≥‡∏™‡∏∞‡∏Å‡∏î / ‡∏Ñ‡∏≥‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</strong>
    <ul>${result.spelling.map(x=>`<li>${x}</li>`).join('')}</ul>
    <strong>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</strong>
    <ul>${result.incomplete.map(x=>`<li>${x}</li>`).join('')}</ul>
    <strong>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</strong>
    <ul>${result.guideline.map(x=>`<li>${x}</li>`).join('')}</ul>
  `;

  document.getElementById('chk7').checked = true; // ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏ô‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡πÄ‡∏≠‡∏á)
});

/* ==============================
   AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ (‡∏Ç‡πâ‡∏≠ 4)
   ============================== */
document.getElementById('btn-ai-summary').addEventListener('click', async ()=>{
  collectFormToData();

  // TODO: ‡∏™‡πà‡∏á currentData ‡πÑ‡∏õ AI backend ‡∏à‡∏£‡∏¥‡∏á
  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≥‡∏•‡∏≠‡∏á
  const autoSummary =
    `<p><strong>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô</strong></p>
     <p>‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${currentData.period_end||'30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô'} 
     ‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô XXX ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô/‡∏•‡∏î‡∏•‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô YYY ‡∏ö‡∏≤‡∏ó (Z%).
     ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏¢‡∏∑‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ 
     ‡∏ã‡∏∂‡πà‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°.</p>
     <p>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏≤‡∏¢‡∏∏‡∏´‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏ô 90 ‡∏ß‡∏±‡∏ô ‡πÑ‡∏î‡πâ‡πÅ‡∏à‡πâ‡∏á‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏´‡∏ô‡∏µ‡πâ
     ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏à‡∏∞‡∏™‡∏π‡∏ç‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°.</p>`;

  const editor = tinymce.get('notes-editor');
  const old = editor.getContent();
  editor.setContent(old ? old + '<hr/>' + autoSummary : autoSummary);
});

/* ==============================
   Checklist + Validation + Warning (‡∏Ç‡πâ‡∏≠ 6,7)
   ============================== */
document.getElementById('btn-confirm-export').addEventListener('click', ()=>{
  collectFormToData();
  const problems = validateBeforeExport();

  if(problems.length){
    // ‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‚Üí ‡∏Ç‡πâ‡∏≠ 7 ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    showWarningModal(problems);
  }else{
    // Checklist ‡∏ú‡πà‡∏≤‡∏ô ‚Üí export / ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
    doExportAndRoute();
  }
});

function validateBeforeExport(){
  const problems = [];
  const unit = currentData.unit_id || document.getElementById('unit-select').value;
  const year = currentData.fiscal_year || document.getElementById('year-select').value;

  if(!unit || !year) problems.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì');
  if(!currentData.objective) problems.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
  if(!currentData.procedures) problems.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
  if(!currentData.table_rows || currentData.table_rows.length===0)
    problems.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏≠‡∏∑‡πà‡∏ô');
  if(!currentData.notes) problems.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•/‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞');
  if(!currentData.checklist || Object.values(currentData.checklist).some(v=>!v))
    problems.push('Checklist ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠');

  return problems;
}

function showWarningModal(problems){
  const body = document.getElementById('modal-warning-body');
  body.innerHTML = `
    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö/‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:</p>
    <ul>${problems.map(p=>`<li>${p}</li>`).join('')}</ul>
    <p style="font-size:12px;color:var(--muted);">
      ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‚Äù, ‚Äú‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‚Äù, ‡∏´‡∏£‡∏∑‡∏≠ ‚Äú‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‚Äù (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡πà‡∏≤ override ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)
    </p>
  `;
  document.getElementById('modal-warning').style.display='flex';
}
function closeWarningModal(){
  document.getElementById('modal-warning').style.display='none';
}
function askForGuidance(){
  alert('‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API/AI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÑ‡∏î‡πâ (‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô)');
}
function overrideAndContinue(){
  errorOverrideCount++;
  closeWarningModal();
  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Üí ‡∏ñ‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠ 10
  if(errorOverrideCount>=3){
    document.getElementById('modal-consult').style.display='flex';
  }else{
    doExportAndRoute();
  }
}

/* ==============================
   Modal ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ (‡∏Ç‡πâ‡∏≠ 10)
   ============================== */
document.getElementById('btn-consult').addEventListener('click', ()=>{
  document.getElementById('modal-consult').style.display='flex';
});
function closeConsultModal(){
  document.getElementById('modal-consult').style.display='none';
}
function confirmConsult(){
  closeConsultModal();
  alert('‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç (‡πÄ‡∏ä‡πà‡∏ô Email, Line OA, ‡∏£‡∏∞‡∏ö‡∏ö‡∏†‡∏≤‡∏¢‡πÉ‡∏ô OAG) ‡πÑ‡∏î‡πâ');
}

/* ==============================
   Export & ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ (‡∏Ç‡πâ‡∏≠ 9,11)
   ============================== */
function doExportAndRoute(){
  const type = document.getElementById('export-type').value;
  switch(type){
    case 'print':
      window.print();
      break;
    case 'json':
      downloadJSON();
      break;
    case 'docx':
      alert('‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Word (.docx) ‡∏à‡∏≤‡∏Å currentData ‡πÉ‡∏ô backend');
      break;
    case 'xlsx':
      alert('‡πÇ‡∏´‡∏°‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Excel (.xlsx) ‡∏à‡∏≤‡∏Å currentData ‡πÉ‡∏ô backend');
      break;
  }

  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á "‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠" ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô (‡∏Ç‡πâ‡∏≠ 9)
  console.log('‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô / cashboard / ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:', currentData);
}

function downloadJSON(){
  const blob = new Blob([JSON.stringify(currentData,null,2)],{type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `fa-lg-8-5-${currentData.unit_id||'unit'}-${currentData.fiscal_year||'year'}.json`;
  a.click();
}

/* ==============================
   ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏ö 15,16,17 + ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô (‡∏Ç‡πâ‡∏≠ 9,18)
   ============================== */
function buildQuery(){
  const unit = currentData.unit_id || document.getElementById('unit-select').value || '';
  const year = currentData.fiscal_year || document.getElementById('year-select').value || '';
  const params = new URLSearchParams();
  if(unit) params.set('unit',unit);
  if(year) params.set('year',year);
  params.set('from','8_5');
  return params.toString();
}
function goHome(){
  // 15. ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ fieldwork ‡∏´‡∏•‡∏±‡∏Å
  const q = buildQuery();
  window.location.href = q ? `fa-lg-fieldwork.html?${q}` : 'fa-lg-fieldwork.html';
}
function goFieldwork(){
  goHome();
}
function goNotes(){
  const q = buildQuery();
  window.location.href = q ? `a-lg-notes-2y.html?${q}` : 'a-lg-notes-2y.html';
}
function goWorkpaper(){
  const q = buildQuery();
  window.location.href = q ? `fa-db-wp.html?${q}` : 'fa-db-wp.html';
}
function goCashboard(){
  // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå cashboard ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
  const q = buildQuery();
  window.location.href = q ? `fa-db-data-gov.html?${q}` : 'fa-db-data-gov.html';
}
function goReview(){
  const q = buildQuery();
  window.location.href = q ? `fa-review-menu.html?${q}` : 'fa-review-menu.html';
}
function goNextForm(){
  // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏ü‡∏≠‡∏£‡πå‡∏° 8.6 ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á
  const q = buildQuery();
  window.location.href = q ? `fa-lg-form-8-6.html?${q}` : 'fa-lg-form-8-6.html';
}

/* ==============================
   init
   ============================== */
populateUnitYear();
renderAll();

/* ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö (‡∏Ç‡πâ‡∏≠ 9 ‚Äì ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢) */
document.getElementById('system-search-input').addEventListener('input', (e)=>{
  const val = (e.target.value||'').toLowerCase();
  const area = document.getElementById('system-search-list');
  [...area.querySelectorAll('button')].forEach(btn=>{
    const t = btn.textContent.toLowerCase();
    btn.style.display = t.includes(val) ? 'block' : 'none';
  });
});

</script>

</body>
</html>
