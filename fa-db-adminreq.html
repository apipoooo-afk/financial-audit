
<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>FA DB | ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô & ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#060818;
    --card:#11152b;
    --muted:#a3acc7;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:"Segoe UI",Arial,sans-serif;
    background:var(--bg);
    color:#fff;
  }
  header{
    padding:18px 10px;
    text-align:center;
    background:linear-gradient(120deg,#7b1e3c,#0d47a1);
    box-shadow:0 4px 14px rgba(0,0,0,.6);
  }
  header h1{margin:0;font-size:22px;font-weight:800;}
  header p{margin:4px 0 0;font-size:13px;color:var(--muted);}
  .wrap{max-width:1100px;margin:18px auto 30px;padding:0 16px;}

  .top-row{
    display:flex;
    justify-content:space-between;
    flex-wrap:wrap;
    gap:8px;
    font-size:13px;
    color:var(--muted);
    margin-bottom:10px;
  }
  .stat-box span{margin-right:10px;}

  .card{
    background:var(--card);
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    padding:14px 14px 12px;
    margin-bottom:14px;
    box-shadow:0 8px 20px rgba(0,0,0,.55);
  }
  h2{margin:0 0 8px;font-size:18px;}
  .muted{font-size:12px;color:var(--muted);}

  .summary-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:10px;
    margin-top:8px;
  }
  .summary-item{
    padding:8px 10px;
    border-radius:12px;
    background:rgba(15,23,42,.9);
    border:1px solid rgba(148,163,184,.45);
    font-size:12px;
  }
  .summary-item strong{font-size:18px;display:block;margin-bottom:2px;}

  table{
    width:100%;
    border-collapse:collapse;
    font-size:12px;
    margin-top:6px;
  }
  th,td{
    border:1px solid rgba(148,163,184,.4);
    padding:6px 5px;
    vertical-align:top;
  }
  th{
    background:#020617;
    font-weight:600;
    position:sticky;
    top:0;
    z-index:1;
  }
  tr:nth-child(even){background:rgba(15,23,42,.8);}

  .btn-row{
    margin-top:8px;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }
  button{
    border:none;
    border-radius:999px;
    padding:7px 12px;
    font-size:12px;
    cursor:pointer;
  }
  .btn-secondary{background:#374151;color:#e5e7eb;}

  a.nav{
    display:inline-block;
    margin-top:10px;
    margin-right:8px;
    color:#e0e7ff;
    text-decoration:none;
    font-size:13px;
  }

  @media(max-width:720px){
    th,td{font-size:11px;}
  }
</style>
</head>
<body>

<header>
  <h1>üõ° FA DB ‚Äì ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô / ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h1>
  <p>Admin Requests Database (‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö admin: fas-admin-requests)</p>
</header>

<div class="wrap">

  <div class="top-row">
    <div>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (session): <strong id="userEmail">-</strong></div>
    <div class="stat-box">
      üëÅ ‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ: <strong id="statCurrent">0</strong>
      üîÑ ‡∏™‡∏∞‡∏™‡∏°: <strong id="statTotal">0</strong>
    </div>
  </div>

  <!-- ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠ -->
  <div class="card">
    <h2>‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin</h2>
    <p class="muted">
      ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å <code>localStorage["fas-admin-requests"]</code> ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ <code>admin.html</code><br>
      ‚Ä¢ ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏´‡∏•‡∏±‡∏Å: <code>NEW_ADMIN</code> (‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö), <code>RESET_PASSWORD</code> (‡∏Ç‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô)
    </p>

    <div class="summary-grid">
      <div class="summary-item">
        <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö)</span>
        <strong id="sumTotalReqs">0</strong>
      </div>
      <div class="summary-item">
        <span>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô Admin ‡πÉ‡∏´‡∏°‡πà (NEW_ADMIN)</span>
        <strong id="sumNewAdmin">0</strong>
      </div>
      <div class="summary-item">
        <span>‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (RESET_PASSWORD)</span>
        <strong id="sumReset">0</strong>
      </div>
      <div class="summary-item">
        <span>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ã‡πâ‡∏≥ &gt; 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
        <strong id="sumDuplicateEmail">0</strong>
      </div>
    </div>
  </div>

  <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠ -->
  <div class="card">
    <h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö Admin (fas-admin-requests)</h2>
    <p class="muted">
      ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô<br>
      * ‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ / ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏Ñ‡∏≥‡∏Ç‡∏≠ ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤ <code>admin.html</code> ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π / Export)
    </p>

    <div class="btn-row">
      <button type="button" class="btn-secondary" id="btnExportReqs">üì§ Export Requests CSV</button>
      <span class="muted">‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á CSV: id,requestType,fullName,citizenId,govId,position,email,reason,createdAt</span>
    </div>

    <div style="max-height:360px;overflow:auto;margin-top:6px;">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏≥‡∏Ç‡∏≠</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏™‡∏Å‡∏∏‡∏•</th>
            <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</th>
            <th>‡∏£‡∏´‡∏±‡∏™‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</th>
            <th>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</th>
            <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
            <th>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠</th>
          </tr>
        </thead>
        <tbody id="reqBody"></tbody>
      </table>
    </div>
  </div>

  <a href="fa-database-menu.html" class="nav">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</a>
  <a href="index.html" class="nav">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>

</div>

<script>
/* ===== CONFIG / KEYS ===== */
const MODULE_KEY   = "adminreq";
const TOTAL_KEY    = "fa-db-total-" + MODULE_KEY;
const SESSION_KEY  = "fa-db-session-" + MODULE_KEY;

/* ===== SESSION CHECK (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ö fa-database ‡∏≠‡∏∑‡πà‡∏ô) ===== */
function checkSession(){
  const raw = localStorage.getItem("fas-session");
  if(!raw){
    location.href = "fa-database-login.html";
    return;
  }
  try{
    const s = JSON.parse(raw);
    if(Date.now() > s.expiresAt){
      localStorage.removeItem("fas-session");
      location.href = "fa-database-login.html";
      return;
    }
    document.getElementById("userEmail").textContent = s.email || "-";
  }catch{
    location.href = "fa-database-login.html";
  }
}

/* ===== MENU STATS ===== */
function updateStatsOnLoad(){
  const total = Number(localStorage.getItem(TOTAL_KEY) || "0") + 1;
  const curr  = Number(sessionStorage.getItem(SESSION_KEY) || "0") + 1;
  localStorage.setItem(TOTAL_KEY, String(total));
  sessionStorage.setItem(SESSION_KEY, String(curr));
  document.getElementById("statTotal").textContent   = total;
  document.getElementById("statCurrent").textContent = curr;
}

/* ===== LOAD DATA FROM admin.html ===== */
let adminReqs = [];

function loadAdminReqs(){
  try{
    const raw = localStorage.getItem("fas-admin-requests");
    adminReqs = raw ? JSON.parse(raw) : [];
    if(!Array.isArray(adminReqs)) adminReqs = [];
  }catch{
    adminReqs = [];
  }
}

/* ===== SUMMARY CALC ===== */
function renderSummary(){
  const total = adminReqs.length;
  const newAdmin = adminReqs.filter(r => (r.requestType || "NEW_ADMIN") === "NEW_ADMIN").length;
  const reset   = adminReqs.filter(r => r.requestType === "RESET_PASSWORD").length;

  // ‡∏ô‡∏±‡∏ö email ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  const emailCount = {};
  adminReqs.forEach(r => {
    const em = (r.email || "").toLowerCase();
    if(!em) return;
    emailCount[em] = (emailCount[em] || 0) + 1;
  });
  const dupEmails = Object.values(emailCount).filter(c => c > 1).length;

  document.getElementById("sumTotalReqs").textContent    = total;
  document.getElementById("sumNewAdmin").textContent     = newAdmin;
  document.getElementById("sumReset").textContent        = reset;
  document.getElementById("sumDuplicateEmail").textContent = dupEmails;
}

/* ===== TABLE RENDER ===== */
function renderReqTable(){
  const tbody = document.getElementById("reqBody");
  tbody.innerHTML = "";

  if(adminReqs.length === 0){
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="9" style="text-align:center;color:#9ca3af;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÉ‡∏ô fas-admin-requests</td>`;
    tbody.appendChild(tr);
    return;
  }

  adminReqs.forEach((r, idx) => {
    const type = r.requestType || "NEW_ADMIN";
    let typeLabel = type;
    if(type === "NEW_ADMIN")      typeLabel = "‡∏Ç‡∏≠‡πÄ‡∏õ‡πá‡∏ô Admin (NEW_ADMIN)";
    if(type === "RESET_PASSWORD") typeLabel = "‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (RESET_PASSWORD)";

    const created = r.createdAt ? new Date(r.createdAt).toLocaleString("th-TH") : "-";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td>${typeLabel}</td>
      <td>${r.fullName || ""}</td>
      <td>${r.citizenId || ""}</td>
      <td>${r.govId || ""}</td>
      <td>${r.position || ""}</td>
      <td>${r.email || ""}</td>
      <td class="muted">${r.reason || ""}</td>
      <td class="muted">${created}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===== EXPORT CSV ===== */
function reqsToCSV(){
  const header = ["id","requestType","fullName","citizenId","govId","position","email","reason","createdAt"];
  const lines = [header.join(",")];

  adminReqs.forEach(r=>{
    const rowObj = {
      id:          r.id || "",
      requestType: r.requestType || "NEW_ADMIN",
      fullName:    r.fullName || "",
      citizenId:   r.citizenId || "",
      govId:       r.govId || "",
      position:    r.position || "",
      email:       r.email || "",
      reason:      r.reason || "",
      createdAt:   r.createdAt || ""
    };
    const row = header.map(k=>{
      const v = (rowObj[k] || "").toString().replace(/"/g,'""');
      return `"${v}"`;
    });
    lines.push(row.join(","));
  });

  return lines.join("\r\n");
}

document.getElementById("btnExportReqs").addEventListener("click", ()=>{
  const csv = reqsToCSV();
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
  const url  = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "fa-db-admin-requests.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

/* ===== INIT ===== */
checkSession();
updateStatsOnLoad();
loadAdminReqs();
renderSummary();
renderReqTable();
</script>

</body>
</html>
