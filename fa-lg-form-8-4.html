<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>FA ‚Äì LG Form 8.4 | ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root{
      --primary:#0d47a1;
      --primary-2:#42a5f5;
      --accent:#ffd54f;
      --bg:#060818;
      --bg-soft:#0b1024;
      --card:#11152b;
      --text:#f5f7ff;
      --muted:#a3acc7;
      --border:#262b46;
      --maroon:#7b1e3c;
      --pink:#f48fb1;
      --success:#66bb6a;
      --danger:#ef5350;
      --shadow-soft:0 10px 30px rgba(0,0,0,0.6);
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:"Segoe UI",Tahoma,sans-serif;
      background:
        radial-gradient(circle at 10% 0%, rgba(123,30,60,0.36) 0, transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(66,165,245,0.32) 0, transparent 55%),
        var(--bg);
      color:var(--text);
    }

    a{color:var(--accent);text-decoration:none;}
    a:hover{text-decoration:underline;}

    header{
      padding:16px 18px 12px;
      background:linear-gradient(120deg,#7b1e3c,#0d47a1,#42a5f5);
      box-shadow:var(--shadow-soft);
      position:sticky;
      top:0;
      z-index:20;
    }
    header h1{
      margin:0;
      font-size:22px;
      font-weight:800;
    }
    header p{
      margin:4px 0 0;
      font-size:13px;
      color:rgba(245,247,255,0.85);
    }
    .header-actions{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:13px;
      align-items:center;
    }
    .chip{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.15);
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    main{
      max-width:1200px;
      margin:20px auto 32px;
      padding:0 10px 40px;
    }

    .toolbar{
      background:var(--card);
      border-radius:14px;
      border:1px solid var(--border);
      padding:14px 14px 10px;
      box-shadow:var(--shadow-soft);
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
      margin-bottom:16px;
    }
    .toolbar-group{
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:13px;
    }
    label span{
      display:block;
      margin-bottom:3px;
      color:var(--muted);
    }
    input[type="text"],
    input[type="number"],
    select,
    textarea{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#0c1023;
      color:var(--text);
      font-family:inherit;
      font-size:13px;
    }
    textarea{min-height:70px;resize:vertical;}

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }
    .btn{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid transparent;
      background:linear-gradient(120deg,#0d47a1,#42a5f5);
      color:#fff;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 4px 10px rgba(0,0,0,0.6);
    }
    .btn.sec{
      background:#151936;
      border-color:var(--border);
      box-shadow:none;
    }
    .btn.danger{
      background:#b71c1c;
    }
    .btn:disabled{
      opacity:0.45;
      cursor:not-allowed;
      box-shadow:none;
    }

    .tabs{
      margin-top:16px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .tab-btn{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#0b1024;
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
    }
    .tab-btn.active{
      background:linear-gradient(120deg,#42a5f5,#7b1e3c);
      color:#fff;
      border-color:transparent;
    }

    .card{
      margin-top:12px;
      background:var(--card);
      border-radius:16px;
      border:1px solid var(--border);
      padding:14px 14px 10px;
      box-shadow:var(--shadow-soft);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:8px;
    }
    .card-title{
      font-size:15px;
      font-weight:700;
    }
    .card-sub{
      font-size:12px;
      color:var(--muted);
      margin-top:2px;
    }
    .badge{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.2);
    }

    .grid-2{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:10px;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:6px;
    }
    th,td{
      border:1px solid var(--border);
      padding:4px 6px;
      text-align:left;
    }
    th{
      background:#151936;
      color:var(--muted);
      font-weight:600;
    }
    tr:nth-child(even) td{
      background:#090d1f;
    }
    .table-actions{
      display:flex;
      justify-content:flex-end;
      margin-top:6px;
      gap:6px;
      flex-wrap:wrap;
    }

    .panel{
      padding:8px 10px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:#090d1f;
      font-size:12px;
      margin-top:6px;
    }
    .panel h4{
      margin:0 0 4px;
      font-size:12px;
      color:var(--muted);
    }
    .panel ul{
      margin:0;
      padding-left:18px;
    }

    .checklist{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
      gap:8px;
      margin-top:6px;
      font-size:12px;
    }
    .check-item{
      display:flex;
      align-items:flex-start;
      gap:6px;
      padding:6px 8px;
      border-radius:10px;
      background:#090d1f;
      border:1px solid var(--border);
    }
    .check-item input{
      margin-top:2px;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      border:1px solid var(--border);
    }
    .status-pill.ready{
      border-color:var(--success);
      color:var(--success);
    }

    .file-input{
      font-size:12px;
      margin-top:4px;
    }

    .export-options{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
      font-size:12px;
    }

    .attach-list{
      margin-top:6px;
      font-size:11px;
      color:var(--muted);
    }
    .attach-list ul{
      margin:0;
      padding-left:18px;
    }
    .attach-list li{
      margin:1px 0;
    }

    .hidden{display:none;}

    /* ‡πÇ‡∏´‡∏°‡∏î‡∏û‡∏¥‡∏°‡∏û‡πå A4 ‚Äì ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° */
    @media print{
      header,.toolbar,.tabs,.no-print{
        display:none!important;
      }
      body{
        background:#fff;
        color:#000;
      }
      main{
        max-width:100%;
        margin:0;
        padding:0;
      }
      .card{
        border-radius:0;
        border:none;
        box-shadow:none;
        page-break-inside:avoid;
        display:none;
      }
      .card.print-active{
        display:block;
      }
      table th,table td{
        border:1px solid #000;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>‡πÅ‡∏ö‡∏ö ‡∏≠‡∏õ‡∏ó. 8.4 ‚Äì ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h1>
    <p>Lead Schedule & ‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢ 8.4.1 / 8.4.1.1 / 8.4.2 | ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö Fieldwork Stage</p>
    <div class="header-actions">
      <div class="chip">
        üîô <a href="fa-lg-fieldwork.html">‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÄ‡∏°‡∏ô‡∏π Fieldwork</a>
      </div>
      <div class="chip">
        üìÑ Export ‡πÅ‡∏¢‡∏Å 4 ‡πÅ‡∏ö‡∏ö: 8.4 / 8.4.1 / 8.4.1.1 / 8.4.2
      </div>
      <div class="chip">
        üß† AI Assist + Checklist + Attachments ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö
      </div>
    </div>
  </header>

  <main>
    <!-- TOOLBAR ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ / ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à -->
    <section class="toolbar no-print">
      <div class="toolbar-group">
        <label>
          <span>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì / Fiscal Year</span>
          <input type="text" id="fyInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2568">
        </label>
        <label>
          <span>‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / Engagement Code</span>
          <input type="text" id="engagementCodeInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô FA-LG-2568-001">
        </label>
      </div>
      <div class="toolbar-group">
        <label>
          <span>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à / Local Government</span>
          <input type="text" id="unitNameInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©">
        </label>
        <label>
          <span>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ‡∏≠‡∏õ‡∏ó. / Type</span>
          <select id="unitTypeSelect">
            <option value="">- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å -</option>
            <option value="‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ô‡∏Ñ‡∏£">‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ô‡∏Ñ‡∏£</option>
            <option value="‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á">‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á</option>
            <option value="‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ï‡∏≥‡∏ö‡∏•">‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡∏ï‡∏≥‡∏ö‡∏•</option>
            <option value="‡∏≠‡∏ö‡∏à.">‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</option>
            <option value="‡∏≠‡∏ö‡∏ï.">‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏≥‡∏ö‡∏•</option>
          </select>
        </label>
      </div>
      <div class="toolbar-group">
        <span>‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô / Actions</span>
        <div class="btn-row">
          <button class="btn sec" id="loadBtn">üì• ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</button>
          <button class="btn" id="saveBtn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</button>
          <button class="btn sec" id="resetBtn">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        </div>
        <small style="color:var(--muted);margin-top:4px;">
          * ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ <strong>localStorage</strong> ‡πÄ‡∏õ‡πá‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á<br>
          ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° backend ‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ API ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        </small>
      </div>
    </section>

    <!-- TABS -->
    <div class="tabs no-print">
      <button class="tab-btn active" data-tab="tab-8-4">‡∏≠‡∏õ‡∏ó. 8.4 ‚Äì ‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å</button>
      <button class="tab-btn" data-tab="tab-8-4-1">‡∏≠‡∏õ‡∏ó. 8.4.1 ‚Äì ‡∏™‡∏£‡∏∏‡∏õ</button>
      <button class="tab-btn" data-tab="tab-8-4-1-1">‡∏≠‡∏õ‡∏ó. 8.4.1.1 ‚Äì ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</button>
      <button class="tab-btn" data-tab="tab-8-4-2">‡∏≠‡∏õ‡∏ó. 8.4.2 ‚Äì ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô</button>
      <button class="tab-btn" data-tab="tab-checklist">Checklist & Export</button>
    </div>

    <!-- TAB 8.4 -->
    <section class="card tab-panel" id="tab-8-4">
      <div class="card-header">
        <div>
          <div class="card-title">‡∏≠‡∏õ‡∏ó. 8.4 ‚Äì ‡πÅ‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å (Lead Schedule)</div>
          <div class="card-sub">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á ‡∏≠‡∏õ‡∏ó. ‡∏ì ‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö 2 ‡∏õ‡∏µ</div>
        </div>
        <span class="badge">Lead of 8.4.1 / 8.4.2</span>
      </div>

      <div class="grid-2">
        <div>
          <label>
            <span>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏° ‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
            <input type="number" id="totalCurrentInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô 21452493.25">
          </label>
          <label>
            <span>‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏£‡∏ß‡∏° ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</span>
            <input type="number" id="totalPriorInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô 19874520.00">
          </label>
          <label>
            <span>‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)</span>
            <input type="number" id="totalDiffInput" readonly>
          </label>
          <label>
            <span>‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏™‡∏£‡∏∏‡∏õ</span>
            <textarea id="diffReasonInput" placeholder="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏¢‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç"></textarea>
          </label>
        </div>
        <div>
          <label>
            <span>‡∏Ç‡πâ‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö)</span>
            <textarea id="conclusionInput" placeholder="‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÇ‡∏î‡∏¢‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠"></textarea>
          </label>
          <label>
            <span>‡∏£‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢ AI (‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏î‡πâ)</span>
            <textarea id="aiConclusionInput" placeholder="‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Äò‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‚Äô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°"></textarea>
          </label>
          <div class="btn-row">
            <button class="btn" id="aiSummaryBtn">üß† ‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á)</button>
            <button class="btn sec" id="spellCheckBtn">üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</button>
          </div>
        </div>
      </div>

      <div class="panel" id="spellPanel">
        <h4>‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</h4>
        <ul id="spellResultList">
          <li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</li>
        </ul>
      </div>

      <div class="panel">
        <h4>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö 8.4 (‡∏´‡∏•‡∏±‡∏Å)</h4>
        <button type="button"
                class="btn sec attach-btn"
                data-attach-key="8-4-main">
          üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö ‡∏≠‡∏õ‡∏ó. 8.4
        </button>
        <input type="file"
               class="file-input"
               id="attach-8-4-main"
               multiple
               hidden>
        <div class="attach-list" id="attach-list-8-4-main">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ
        </div>
      </div>
    </section>

    <!-- TAB 8.4.1 -->
    <section class="card tab-panel hidden" id="tab-8-4-1">
      <div class="card-header">
        <div>
          <div class="card-title">‡∏≠‡∏õ‡∏ó. 8.4.1 ‚Äì ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î</div>
          <div class="card-sub">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠‡∏¢ 8.4.1.1 ‡πÅ‡∏¢‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å</div>
        </div>
        <span class="badge">Summary of 8.4.1.1</span>
      </div>

      <div class="panel">
        <h4>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ (8.4.1)</h4>
        <table id="summaryTable">
          <thead>
            <tr>
              <th style="width:30px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏´‡∏°‡∏ß‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å / Section</th>
              <th>‡∏¢‡∏≠‡∏î‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</th>
              <th>‡∏¢‡∏≠‡∏î‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
              <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <div class="table-actions">
          <button class="btn sec" id="addSummaryRowBtn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏™‡∏£‡∏∏‡∏õ</button>
          <button class="btn sec" id="recalcFromDetailBtn">‚Ü∫ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å 8.4.1.1 (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</button>
        </div>
      </div>

      <div class="panel">
        <h4>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠ 8.4.1</h4>
        <button type="button"
                class="btn sec attach-btn"
                data-attach-key="8-4-1">
          üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö ‡∏≠‡∏õ‡∏ó. 8.4.1
        </button>
        <input type="file"
               class="file-input"
               id="attach-8-4-1"
               multiple
               hidden>
        <div class="attach-list" id="attach-list-8-4-1">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ
        </div>
      </div>
    </section>

    <!-- TAB 8.4.1.1 -->
    <section class="card tab-panel hidden" id="tab-8-4-1-1">
      <div class="card-header">
        <div>
          <div class="card-title">‡∏≠‡∏õ‡∏ó. 8.4.1.1 ‚Äì ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
          <div class="card-sub">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö bank statement / ‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î</div>
        </div>
        <span class="badge">Detail Level</span>
      </div>

      <div class="panel">
        <h4>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (8.4.1.1)</h4>
        <table id="detailTable">
          <thead>
            <tr>
              <th style="width:30px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</th>
              <th>‡∏™‡∏≤‡∏Ç‡∏≤</th>
              <th>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
              <th>‡∏¢‡∏≠‡∏î‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</th>
              <th>‡∏¢‡∏≠‡∏î‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
              <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
              <th style="width:40px;">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <div class="table-actions">
          <button class="btn sec" id="addDetailRowBtn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
        </div>
      </div>

      <div class="panel">
        <h4>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 8.4.1.1</h4>
        <button type="button"
                class="btn sec attach-btn"
                data-attach-key="8-4-1-1">
          üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö ‡∏≠‡∏õ‡∏ó. 8.4.1.1
        </button>
        <input type="file"
               class="file-input"
               id="attach-8-4-1-1"
               multiple
               hidden>
        <div class="attach-list" id="attach-list-8-4-1-1">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ
        </div>
      </div>
    </section>

    <!-- TAB 8.4.2 -->
    <section class="card tab-panel hidden" id="tab-8-4-2">
      <div class="card-header">
        <div>
          <div class="card-title">‡∏≠‡∏õ‡∏ó. 8.4.2 ‚Äì ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å</div>
          <div class="card-sub">‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πâ‡∏≤‡∏á‡∏à‡πà‡∏≤‡∏¢ ‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏£‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå ‡πÄ‡∏ä‡πá‡∏Ñ‡∏Ñ‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô ‡∏Ø‡∏•‡∏Ø</div>
        </div>
        <span class="badge">Other Related Items</span>
      </div>

      <div class="panel">
        <h4>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô (8.4.2)</h4>
        <table id="otherTable">
          <thead>
            <tr>
              <th style="width:30px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
              <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó / Item Type</th>
              <th>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</th>
              <th>‡∏¢‡∏≠‡∏î‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤</th>
              <th>‡∏¢‡∏≠‡∏î‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</th>
              <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
              <th style="width:40px;">‡∏•‡∏ö</th>
            </tr>
          </thead>
          <tbody>
          </tbody>
        </table>
        <div class="table-actions">
          <button class="btn sec" id="addOtherRowBtn">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </div>
      </div>

      <div class="panel">
        <h4>‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö 8.4.2</h4>
        <button type="button"
                class="btn sec attach-btn"
                data-attach-key="8-4-2">
          üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö ‡∏≠‡∏õ‡∏ó. 8.4.2
        </button>
        <input type="file"
               class="file-input"
               id="attach-8-4-2"
               multiple
               hidden>
        <div class="attach-list" id="attach-list-8-4-2">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ
        </div>
      </div>
    </section>

    <!-- TAB CHECKLIST & EXPORT -->
    <section class="card tab-panel hidden" id="tab-checklist">
      <div class="card-header">
        <div>
          <div class="card-title">Checklist, ‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô, Export & ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô</div>
          <div class="card-sub">‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô ‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</div>
        </div>
        <span class="badge">Finalization</span>
      </div>

      <div class="panel">
        <h4>Checklist ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (‡∏ï‡πà‡∏≠‡πÅ‡∏ö‡∏ö 8.4)</h4>
        <div class="checklist" id="checklistContainer">
          <label class="check-item">
            <input type="checkbox" data-check-key="numbers-checked">
            <span>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏á‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á/‡∏á‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ê‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
          </label>
          <label class="check-item">
            <input type="checkbox" data-check-key="attachments-complete">
            <span>‡πÅ‡∏ô‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (bank statement / ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£) ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
          </label>
          <label class="check-item">
            <input type="checkbox" data-check-key="conclusion-written">
            <span>‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ñ‡πâ‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span>
          </label>
          <label class="check-item">
            <input type="checkbox" data-check-key="spell-checked">
            <span>‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‚Äù ‡πÅ‡∏•‡πâ‡∏ß</span>
          </label>
          <label class="check-item">
            <input type="checkbox" data-check-key="reviewed">
            <span>‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°/‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</span>
          </label>
        </div>
        <div style="margin-top:8px;font-size:12px;">
          ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:
          <span id="checkStatus" class="status-pill">‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏™‡πà‡∏á</span>
        </div>
      </div>

      <div class="panel">
        <h4>‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏ú‡∏¥‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô/‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</h4>
        <p id="warningPanel" style="font-size:12px;color:var(--muted);margin:0;">
          ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á
        </p>
      </div>

      <div class="panel">
        <h4>‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç</h4>
        <p style="font-size:12px;margin:0 0 6px;" id="consultText">
          ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ã‡πâ‡∏≥ ‡πÜ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
        </p>
        <div class="btn-row">
          <button class="btn sec" type="button" id="manualConsultBtn">üì® ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ (‡∏Å‡∏î‡πÄ‡∏≠‡∏á)</button>
        </div>
      </div>

      <div class="panel">
        <h4>‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô</h4>
        <div style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;">
          <input type="text" id="systemSearchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö ‡πÄ‡∏ä‡πà‡∏ô review, database, cashboard" style="flex:1;min-width:200px;">
          <button class="btn sec" id="searchSystemBtn">üîé ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          <button class="btn" id="sendToSystemBtn" disabled>üì§ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏à‡∏≥‡∏•‡∏≠‡∏á)</button>
        </div>
        <div id="systemSearchResult" style="margin-top:6px;font-size:12px;color:var(--muted);">
          ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á
        </div>
      </div>

      <div class="panel">
        <h4>Export ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (A4)</h4>
        <div class="export-options">
          <label><input type="radio" name="exportType" value="pdf" checked> PDF (‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå ‚Üí Save as PDF)</label>
          <label><input type="radio" name="exportType" value="word"> Word (DOCX ‚Äì ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏ô backend)</label>
          <label><input type="radio" name="exportType" value="excel"> Excel (XLSX ‚Äì ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÉ‡∏ô backend)</label>
          <label><input type="radio" name="exportType" value="json"> JSON (‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô)</label>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏° Export ‡πÅ‡∏¢‡∏Å‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° -->
        <div class="btn-row" style="margin-top:8px;flex-wrap:wrap;">
          <button class="btn" data-export-form="tab-8-4" disabled>
            üñ® Export ‡πÅ‡∏ö‡∏ö ‡∏≠‡∏õ‡∏ó. 8.4
          </button>
          <button class="btn" data-export-form="tab-8-4-1" disabled>
            üñ® Export ‡πÅ‡∏ö‡∏ö ‡∏≠‡∏õ‡∏ó. 8.4.1
          </button>
          <button class="btn" data-export-form="tab-8-4-1-1" disabled>
            üñ® Export ‡πÅ‡∏ö‡∏ö ‡∏≠‡∏õ‡∏ó. 8.4.1.1
          </button>
          <button class="btn" data-export-form="tab-8-4-2" disabled>
            üñ® Export ‡πÅ‡∏ö‡∏ö ‡∏≠‡∏õ‡∏ó. 8.4.2
          </button>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏° Export ‡∏ó‡∏±‡πâ‡∏á 4 ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô -->
        <div class="btn-row" style="margin-top:4px;">
          <button class="btn sec" id="confirmPrintBtn" disabled>
            üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå/Export ‡∏ó‡∏±‡πâ‡∏á 4 ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
          </button>
          <button class="btn" id="confirmSendBtn" disabled>
            üì§ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô (‡∏™‡∏£‡∏∏‡∏õ‡πÅ‡∏û‡πá‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
          </button>
        </div>

        <small style="font-size:11px;color:var(--muted);display:block;margin-top:6px;">
          * Export ‡∏ó‡∏µ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö: ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° Export ‡πÅ‡∏ö‡∏ö ‡∏≠‡∏õ‡∏ó. 8.4 / 8.4.1 / 8.4.1.1 / 8.4.2 ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£<br>
          * Export ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏û‡∏¥‡∏°‡∏û‡πå/Export ‡∏ó‡∏±‡πâ‡∏á 4 ‡πÅ‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‚Äù (‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô A4 ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á)<br>
          * ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå Word/Excel/JSON ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡πà‡∏≠‡∏¢‡∏≠‡∏î‡πÑ‡∏î‡πâ‡πÉ‡∏ô backend ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡∏ô‡∏µ‡πâ
        </small>
      </div>
    </section>
  </main>

  <script>
    // ================== STATE ‡∏´‡∏•‡∏±‡∏Å ==================
    const state = {
      master:{
        totalCurrent:0,
        totalPrior:0,
        totalDiff:0,
        diffReason:"",
        conclusion:"",
        aiConclusion:""
      },
      summaryRows:[],
      detailRows:[],
      otherRows:[],
      checklist:{
        "numbers-checked":false,
        "attachments-complete":false,
        "conclusion-written":false,
        "spell-checked":false,
        "reviewed":false
      },
      attachments:{},    // ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÅ‡∏ö‡∏ö
      errorCount:0,      // ‡πÉ‡∏ä‡πâ‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ã‡πâ‡∏≥ ‡πÜ ‡∏Å‡∏µ‡πà‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      askedConsult:false // ‡∏ñ‡∏≤‡∏°‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á
    };

    function getStorageKey(){
      const fy=document.getElementById('fyInput').value || 'xxxx';
      const unit=document.getElementById('unitNameInput').value || 'unit';
      const eng=document.getElementById('engagementCodeInput').value || 'eng';
      return `fa-lg-8-4-${fy}-${unit}-${eng}`;
    }

    // ================== TAB ==================
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tabId=btn.dataset.tab;
        document.querySelectorAll('.tab-panel').forEach(p=>{
          if(p.id===tabId) p.classList.remove('hidden');
          else p.classList.add('hidden');
        });
      });
    });

    // ================== MASTER INPUTS ==================
    const totalCurrentInput=document.getElementById('totalCurrentInput');
    const totalPriorInput=document.getElementById('totalPriorInput');
    const totalDiffInput=document.getElementById('totalDiffInput');
    const diffReasonInput=document.getElementById('diffReasonInput');
    const conclusionInput=document.getElementById('conclusionInput');
    const aiConclusionInput=document.getElementById('aiConclusionInput');
    const warningPanel=document.getElementById('warningPanel');

    function updateWarningPanel(){
      const fy=document.getElementById('fyInput').value.trim();
      const unit=document.getElementById('unitNameInput').value.trim();
      const c=parseFloat(totalCurrentInput.value||0);
      const p=parseFloat(totalPriorInput.value||0);
      const msgs=[];
      if(!fy) msgs.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì');
      if(!unit) msgs.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à');
      if(isNaN(c) || isNaN(p) || (c===0 && p===0)){
        msgs.push('‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô/‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î');
      }
      if(state.summaryRows.length===0){
        msgs.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏£‡∏∏‡∏õ‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö 8.4.1');
      }
      if(state.detailRows.length===0){
        msgs.push('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö 8.4.1.1');
      }
      if(state.otherRows.length===0){
        msgs.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö 8.4.2 (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤ ‚Äú‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Äù)');
      }

      if(msgs.length===0){
        warningPanel.textContent='‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô';
      }else{
        warningPanel.innerHTML='‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:<br>- '+msgs.join('<br>- ');
      }
    }

    function recalcDiff(){
      const c=parseFloat(totalCurrentInput.value||0);
      const p=parseFloat(totalPriorInput.value||0);
      const diff=c-p;
      totalDiffInput.value=isNaN(diff)?0:diff.toFixed(2);
      state.master.totalCurrent=c;
      state.master.totalPrior=p;
      state.master.totalDiff=diff;
      updateWarningPanel();
    }

    totalCurrentInput.addEventListener('input',recalcDiff);
    totalPriorInput.addEventListener('input',recalcDiff);
    diffReasonInput.addEventListener('input',e=>state.master.diffReason=e.target.value);
    conclusionInput.addEventListener('input',e=>state.master.conclusion=e.target.value);
    aiConclusionInput.addEventListener('input',e=>state.master.aiConclusion=e.target.value);

    // ================== TABLE 8.4.1 SUMMARY ==================
    const summaryTableBody=document.querySelector('#summaryTable tbody');
    document.getElementById('addSummaryRowBtn').addEventListener('click',()=>{
      state.summaryRows.push({
        section:"",
        prior:0,
        current:0,
        note:""
      });
      renderSummaryTable();
      updateWarningPanel();
    });

    function renderSummaryTable(){
      summaryTableBody.innerHTML="";
      state.summaryRows.forEach((row,idx)=>{
        const tr=document.createElement('tr');

        const tdIdx=document.createElement('td');
        tdIdx.textContent=idx+1;
        tr.appendChild(tdIdx);

        const tdSection=document.createElement('td');
        const iSection=document.createElement('input');
        iSection.type='text';
        iSection.value=row.section;
        iSection.addEventListener('input',e=>row.section=e.target.value);
        tdSection.appendChild(iSection);
        tr.appendChild(tdSection);

        const tdPrior=document.createElement('td');
        const iPrior=document.createElement('input');
        iPrior.type='number';
        iPrior.value=row.prior;
        iPrior.addEventListener('input',e=>row.prior=parseFloat(e.target.value||0));
        tdPrior.appendChild(iPrior);
        tr.appendChild(tdPrior);

        const tdCurrent=document.createElement('td');
        const iCurrent=document.createElement('input');
        iCurrent.type='number';
        iCurrent.value=row.current;
        iCurrent.addEventListener('input',e=>row.current=parseFloat(e.target.value||0));
        tdCurrent.appendChild(iCurrent);
        tr.appendChild(tdCurrent);

        const tdNote=document.createElement('td');
        const iNote=document.createElement('input');
        iNote.type='text';
        iNote.value=row.note;
        iNote.addEventListener('input',e=>row.note=e.target.value);
        tdNote.appendChild(iNote);
        tr.appendChild(tdNote);

        summaryTableBody.appendChild(tr);
      });
    }

    document.getElementById('recalcFromDetailBtn').addEventListener('click',()=>{
      if(state.detailRows.length===0){
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö 8.4.1.1 ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Å‡πà‡∏≠‡∏ô');
        incrementErrorCount();
        return;
      }
      const totalPrior=state.detailRows.reduce((s,r)=>s+(parseFloat(r.prior)||0),0);
      const totalCurrent=state.detailRows.reduce((s,r)=>s+(parseFloat(r.current)||0),0);
      state.summaryRows=[{
        section:"‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å 8.4.1.1",
        prior:totalPrior,
        current:totalCurrent,
        note:"‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (‡∏à‡∏≥‡∏•‡∏≠‡∏á)"
      }];
      renderSummaryTable();
      totalCurrentInput.value=totalCurrent.toFixed(2);
      totalPriorInput.value=totalPrior.toFixed(2);
      recalcDiff();
      alert('‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏¢‡∏≠‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å 8.4.1.1 ‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏≥‡∏•‡∏≠‡∏á)');
    });

    // ================== TABLE 8.4.1.1 DETAIL ==================
    const detailTableBody=document.querySelector('#detailTable tbody');
    document.getElementById('addDetailRowBtn').addEventListener('click',()=>{
      state.detailRows.push({
        bank:"",
        branch:"",
        accNo:"",
        type:"",
        prior:0,
        current:0,
        note:""
      });
      renderDetailTable();
      updateWarningPanel();
    });

    function renderDetailTable(){
      detailTableBody.innerHTML="";
      state.detailRows.forEach((row,idx)=>{
        const tr=document.createElement('tr');

        const tdIdx=document.createElement('td');
        tdIdx.textContent=idx+1;
        tr.appendChild(tdIdx);

        const makeInput=(val,cb)=>{
          const inp=document.createElement('input');
          inp.type='text';
          inp.value=val;
          inp.addEventListener('input',e=>cb(e.target.value));
          return inp;
        };

        let td=document.createElement('td');
        td.appendChild(makeInput(row.bank,v=>row.bank=v));
        tr.appendChild(td);

        td=document.createElement('td');
        td.appendChild(makeInput(row.branch,v=>row.branch=v));
        tr.appendChild(td);

        td=document.createElement('td');
        td.appendChild(makeInput(row.accNo,v=>row.accNo=v));
        tr.appendChild(td);

        td=document.createElement('td');
        td.appendChild(makeInput(row.type,v=>row.type=v));
        tr.appendChild(td);

        td=document.createElement('td');
        const priorInput=document.createElement('input');
        priorInput.type='number';
        priorInput.value=row.prior;
        priorInput.addEventListener('input',e=>row.prior=parseFloat(e.target.value||0));
        td.appendChild(priorInput);
        tr.appendChild(td);

        td=document.createElement('td');
        const currentInput=document.createElement('input');
        currentInput.type='number';
        currentInput.value=row.current;
        currentInput.addEventListener('input',e=>row.current=parseFloat(e.target.value||0));
        td.appendChild(currentInput);
        tr.appendChild(td);

        td=document.createElement('td');
        td.appendChild(makeInput(row.note,v=>row.note=v));
        tr.appendChild(td);

        td=document.createElement('td');
        const delBtn=document.createElement('button');
        delBtn.textContent='‚úï';
        delBtn.className='btn danger';
        delBtn.style.padding='2px 6px';
        delBtn.style.fontSize='11px';
        delBtn.addEventListener('click',()=>{
          state.detailRows.splice(idx,1);
          renderDetailTable();
          updateWarningPanel();
        });
        td.appendChild(delBtn);
        tr.appendChild(td);

        detailTableBody.appendChild(tr);
      });
    }

    // ================== TABLE 8.4.2 OTHER ==================
    const otherTableBody=document.querySelector('#otherTable tbody');
    document.getElementById('addOtherRowBtn').addEventListener('click',()=>{
      state.otherRows.push({
        itemType:"",
        desc:"",
        prior:0,
        current:0,
        note:""
      });
      renderOtherTable();
      updateWarningPanel();
    });

    function renderOtherTable(){
      otherTableBody.innerHTML="";
      state.otherRows.forEach((row,idx)=>{
        const tr=document.createElement('tr');

        const tdIdx=document.createElement('td');
        tdIdx.textContent=idx+1;
        tr.appendChild(tdIdx);

        const makeInput=(val,cb)=>{
          const inp=document.createElement('input');
          inp.type='text';
          inp.value=val;
          inp.addEventListener('input',e=>cb(e.target.value));
          return inp;
        };

        let td=document.createElement('td');
        td.appendChild(makeInput(row.itemType,v=>row.itemType=v));
        tr.appendChild(td);

        td=document.createElement('td');
        td.appendChild(makeInput(row.desc,v=>row.desc=v));
        tr.appendChild(td);

        td=document.createElement('td');
        const priorInput=document.createElement('input');
        priorInput.type='number';
        priorInput.value=row.prior;
        priorInput.addEventListener('input',e=>row.prior=parseFloat(e.target.value||0));
        td.appendChild(priorInput);
        tr.appendChild(td);

        td=document.createElement('td');
        const currentInput=document.createElement('input');
        currentInput.type='number';
        currentInput.value=row.current;
        currentInput.addEventListener('input',e=>row.current=parseFloat(e.target.value||0));
        td.appendChild(currentInput);
        tr.appendChild(td);

        td=document.createElement('td');
        td.appendChild(makeInput(row.note,v=>row.note=v));
        tr.appendChild(td);

        td=document.createElement('td');
        const delBtn=document.createElement('button');
        delBtn.textContent='‚úï';
        delBtn.className='btn danger';
        delBtn.style.padding='2px 6px';
        delBtn.style.fontSize='11px';
        delBtn.addEventListener('click',()=>{
          state.otherRows.splice(idx,1);
          renderOtherTable();
          updateWarningPanel();
        });
        td.appendChild(delBtn);
        tr.appendChild(td);

        otherTableBody.appendChild(tr);
      });
    }

    // ================== ATTACHMENTS ‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö ==================
    function initAttachmentButtons(){
      const attachButtons=document.querySelectorAll('.attach-btn');
      attachButtons.forEach(btn=>{
        const key=btn.getAttribute('data-attach-key');
        const input=document.getElementById('attach-'+key);
        const listDiv=document.getElementById('attach-list-'+key);
        if(!input || !listDiv) return;

        btn.addEventListener('click',()=>input.click());

        input.addEventListener('change',()=>{
          const files=Array.from(input.files||[]);
          state.attachments[key]=files.map(f=>f.name);
          renderAttachmentList(key);
        });
      });
    }

    function renderAttachmentList(key){
      const listDiv=document.getElementById('attach-list-'+key);
      if(!listDiv) return;
      const names=state.attachments[key]||[];
      if(!names.length){
        listDiv.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏ô‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ';
        return;
      }
      const ul=document.createElement('ul');
      names.forEach(name=>{
        const li=document.createElement('li');
        li.textContent='üìÑ '+name;
        ul.appendChild(li);
      });
      listDiv.innerHTML='';
      listDiv.appendChild(ul);
    }

    function renderAllAttachmentsFromState(){
      Object.keys(state.attachments).forEach(key=>renderAttachmentList(key));
    }

    // ================== AI SUMMARY (‡∏à‡∏≥‡∏•‡∏≠‡∏á) ==================
    document.getElementById('aiSummaryBtn').addEventListener('click',()=>{
      const fy=document.getElementById('fyInput').value || '....';
      const unit=document.getElementById('unitNameInput').value || '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à';
      const totalC=parseFloat(totalCurrentInput.value||0);
      const totalP=parseFloat(totalPriorInput.value||0);
      const diff=totalC-totalP;
      const diffPct = totalP!==0 ? (diff/totalP*100) : 0;

      const direction = diff>0?'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô':'‡∏•‡∏î‡∏•‡∏á';
      const text =
`‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á${unit} ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${fy}
‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å ‡∏ì ‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏á‡∏ß‡∏î‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${totalC.toLocaleString('th-TH',{maximumFractionDigits:2})} ‡∏ö‡∏≤‡∏ó 
‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏µ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${totalP.toLocaleString('th-TH',{maximumFractionDigits:2})} ‡∏ö‡∏≤‡∏ó 
${direction}‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${diff.toLocaleString('th-TH',{maximumFractionDigits:2})} ‡∏ö‡∏≤‡∏ó ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${diffPct.toFixed(2)}% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏≤

‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£ ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏™‡∏≤‡∏£‡∏∞‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç 
‡∏ó‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏¢‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ`;

      aiConclusionInput.value=text;
      state.master.aiConclusion=text;
      alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ)');
    });

    // ================== ERROR COUNT & CONSULT ==================
    const consultText=document.getElementById('consultText');
    function incrementErrorCount(){
      state.errorCount++;
      if(state.errorCount>=3 && !state.askedConsult){
        const want=confirm('‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ã‡πâ‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏î OK ‡∏´‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£, Cancel ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£');
        state.askedConsult=true;
        if(want){
          consultText.textContent='‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô backend ‡∏à‡∏£‡∏¥‡∏á)';
          alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏ß‡πâ (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÑ‡∏î‡πâ)');
        }else{
          consultText.textContent='‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤ ‡πÅ‡∏°‡πâ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ã‡πâ‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
        }
      }
    }

    document.getElementById('manualConsultBtn').addEventListener('click',()=>{
      consultText.textContent='‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏î‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á (‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢/‡πÅ‡∏ä‡∏ó‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á)';
      alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô backend ‡∏à‡∏£‡∏¥‡∏á');
    });

    // ================== SPELL / STRUCTURE CHECK ==================
    const spellList=document.getElementById('spellResultList');

    document.getElementById('spellCheckBtn').addEventListener('click',()=>{
      const errors=[];
      const warns=[];
      const fy=document.getElementById('fyInput').value.trim();
      const unit=document.getElementById('unitNameInput').value.trim();

      if(!fy) errors.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì');
      if(!unit) errors.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à');

      if((conclusionInput.value.trim().length||0)<30){
        warns.push('‡∏Ç‡πâ‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏±‡πâ‡∏ô‡∏°‡∏≤‡∏Å ‡∏Ñ‡∏ß‡∏£‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
      }
      if(state.summaryRows.length===0){
        warns.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á 8.4.1 ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
      }
      if(state.detailRows.length===0){
        warns.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á 8.4.1.1 ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å');
      }

      spellList.innerHTML="";
      if(errors.length===0 && warns.length===0){
        const li=document.createElement('li');
        li.textContent='‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ö‡∏Å‡∏û‡∏£‡πà‡∏≠‡∏á‡πÄ‡∏ä‡∏¥‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô)';
        spellList.appendChild(li);
      }else{
        errors.forEach(e=>{
          const li=document.createElement('li');
          li.textContent='‚ùå '+e;
          li.style.color='var(--danger)';
          spellList.appendChild(li);
        });
        warns.forEach(w=>{
          const li=document.createElement('li');
          li.textContent='‚ö† '+w;
          spellList.appendChild(li);
        });
      }

      state.checklist['spell-checked']=true;
      syncChecklistUI();
      if(errors.length>0 || warns.length>0) incrementErrorCount();
      updateWarningPanel();
    });

    // ================== CHECKLIST ==================
    const checklistContainer=document.getElementById('checklistContainer');
    const checkStatus=document.getElementById('checkStatus');
    const confirmPrintBtn=document.getElementById('confirmPrintBtn');
    const confirmSendBtn=document.getElementById('confirmSendBtn');
    const exportFormButtons=document.querySelectorAll('[data-export-form]');

    checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
      chk.addEventListener('change',()=>{
        const key=chk.dataset.checkKey;
        state.checklist[key]=chk.checked;
        syncChecklistUI();
      });
    });

    function syncChecklistUI(){
      const values=Object.values(state.checklist);
      const allDone=values.every(v=>v===true);
      if(allDone){
        checkStatus.textContent='‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠';
        checkStatus.classList.add('ready');
        if(confirmPrintBtn) confirmPrintBtn.disabled=false;
        if(confirmSendBtn) confirmSendBtn.disabled=false;
        exportFormButtons.forEach(btn=>btn.disabled=false);
      }else{
        checkStatus.textContent='‚è≥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏û‡∏¥‡∏°‡∏û‡πå/‡∏™‡πà‡∏á';
        checkStatus.classList.remove('ready');
        if(confirmPrintBtn) confirmPrintBtn.disabled=true;
        if(confirmSendBtn) confirmSendBtn.disabled=true;
        exportFormButtons.forEach(btn=>btn.disabled=true);
      }
    }

    // ================== EXPORT ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå ==================
    function setPrintTarget(formIdOrAll){
      const panels=document.querySelectorAll('.tab-panel');
      panels.forEach(p=>p.classList.remove('print-active'));
      if(formIdOrAll==='all'){
        panels.forEach(p=>p.classList.add('print-active'));
      }else{
        const target=document.getElementById(formIdOrAll);
        if(target) target.classList.add('print-active');
      }
    }

    exportFormButtons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        const formId=btn.getAttribute('data-export-form');
        const selectedType=(document.querySelector('input[name="exportType"]:checked')||{}).value;

        if(selectedType==='json'){
          alert('‡πÇ‡∏´‡∏°‡∏î JSON ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô backend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á\n‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏î‡πÇ‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå A4 ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå');
        }

        setPrintTarget(formId);
        window.print();
      });
    });

    if(confirmPrintBtn){
      confirmPrintBtn.addEventListener('click',()=>{
        const selectedType=(document.querySelector('input[name="exportType"]:checked')||{}).value;
        if(selectedType==='json'){
          alert('‡πÇ‡∏´‡∏°‡∏î JSON ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÉ‡∏ô backend ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á\n‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏î‡πÇ‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå A4 ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå');
        }
        setPrintTarget('all');
        window.print();
      });
    }

    if(confirmSendBtn){
      confirmSendBtn.addEventListener('click',()=>{
        alert('‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° backend ‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô / ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / Cashboard ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÑ‡∏î‡πâ\n‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≥‡∏•‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô');
      });
    }

    // ================== ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (‡∏à‡∏≥‡∏•‡∏≠‡∏á) ==================
    const systemSearchInput=document.getElementById('systemSearchInput');
    const systemSearchBtn=document.getElementById('searchSystemBtn');
    const sendToSystemBtn=document.getElementById('sendToSystemBtn');
    const systemSearchResult=document.getElementById('systemSearchResult');
    let selectedSystemKey=null;

    const systemRegistry=[
      {key:'review', name:'‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô FA'},
      {key:'database', name:'‡∏£‡∏∞‡∏ö‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á FA-LG'},
      {key:'cashboard', name:'‡∏£‡∏∞‡∏ö‡∏ö Cash Board ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô'},
      {key:'other', name:'‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° 4'}
    ];

    systemSearchBtn.addEventListener('click',()=>{
      const q=(systemSearchInput.value||'').toLowerCase();
      const matched=systemRegistry.filter(s=>s.key.includes(q)||s.name.toLowerCase().includes(q));
      if(!matched.length){
        systemSearchResult.textContent='‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô';
        selectedSystemKey=null;
        sendToSystemBtn.disabled=true;
        return;
      }
      const s=matched[0];
      selectedSystemKey=s.key;
      sendToSystemBtn.disabled=false;
      systemSearchResult.textContent='‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö: '+s.name+' (key: '+s.key+')';
    });

    sendToSystemBtn.addEventListener('click',()=>{
      if(!selectedSystemKey){
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á');
        return;
      }
      alert('‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö 8.4 ‡∏ó‡∏±‡πâ‡∏á‡∏ä‡∏∏‡∏î‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏ö: '+selectedSystemKey+' (‡∏à‡∏≥‡∏•‡∏≠‡∏á)\n‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á');
    });

    // ================== SAVE / LOAD / RESET (localStorage ‡∏à‡∏≥‡∏•‡∏≠‡∏á DB) ==================
    document.getElementById('saveBtn').addEventListener('click',()=>{
      const key=getStorageKey();
      const fy=document.getElementById('fyInput').value.trim();
      const unit=document.getElementById('unitNameInput').value.trim();
      if(!fy || !unit){
        alert('‡∏Ñ‡∏ß‡∏£‡∏Å‡∏£‡∏≠‡∏Å‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÅ‡∏•‡∏∞‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        incrementErrorCount();
      }
      const payload={
        meta:{
          fy:document.getElementById('fyInput').value,
          engagement:document.getElementById('engagementCodeInput').value,
          unitName:document.getElementById('unitNameInput').value,
          unitType:document.getElementById('unitTypeSelect').value
        },
        state
      };
      localStorage.setItem(key,JSON.stringify(payload));
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á (localStorage) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢\nKey: '+key);
    });

    document.getElementById('loadBtn').addEventListener('click',()=>{
      const key=getStorageKey();
      const raw=localStorage.getItem(key);
      if(!raw){
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ï‡πâ key ‡∏ô‡∏µ‡πâ\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì/‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à/‡∏£‡∏´‡∏±‡∏™‡∏á‡∏≤‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà');
        incrementErrorCount();
        return;
      }
      const payload=JSON.parse(raw);
      document.getElementById('fyInput').value=payload.meta.fy;
      document.getElementById('engagementCodeInput').value=payload.meta.engagement;
      document.getElementById('unitNameInput').value=payload.meta.unitName;
      document.getElementById('unitTypeSelect').value=payload.meta.unitType;

      Object.assign(state.master,payload.state.master||{});
      state.summaryRows=payload.state.summaryRows||[];
      state.detailRows=payload.state.detailRows||[];
      state.otherRows=payload.state.otherRows||[];
      Object.assign(state.checklist,payload.state.checklist||{});
      state.attachments=payload.state.attachments || {};
      state.errorCount=payload.state.errorCount || 0;
      state.askedConsult=payload.state.askedConsult || false;

      totalCurrentInput.value=state.master.totalCurrent||0;
      totalPriorInput.value=state.master.totalPrior||0;
      recalcDiff();
      diffReasonInput.value=state.master.diffReason||"";
      conclusionInput.value=state.master.conclusion||"";
      aiConclusionInput.value=state.master.aiConclusion||"";

      renderSummaryTable();
      renderDetailTable();
      renderOtherTable();
      renderAllAttachmentsFromState();

      checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(chk=>{
        const key=chk.dataset.checkKey;
        chk.checked=!!state.checklist[key];
      });
      syncChecklistUI();
      updateWarningPanel();

      alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    });

    document.getElementById('resetBtn').addEventListener('click',()=>{
      if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? (‡πÑ‡∏°‡πà‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage)')) return;
      totalCurrentInput.value='';
      totalPriorInput.value='';
      totalDiffInput.value='';
      diffReasonInput.value='';
      conclusionInput.value='';
      aiConclusionInput.value='';
      document.getElementById('fyInput').value='';
      document.getElementById('engagementCodeInput').value='';
      document.getElementById('unitNameInput').value='';
      document.getElementById('unitTypeSelect').value='';

      state.master={totalCurrent:0,totalPrior:0,totalDiff:0,diffReason:"",conclusion:"",aiConclusion:""};
      state.summaryRows=[];
      state.detailRows=[];
      state.otherRows=[];
      Object.keys(state.checklist).forEach(k=>state.checklist[k]=false);
      state.attachments={};
      state.errorCount=0;
      state.askedConsult=false;

      renderSummaryTable();
      renderDetailTable();
      renderOtherTable();
      renderAllAttachmentsFromState();
      checklistContainer.querySelectorAll('input[type="checkbox"]').forEach(chk=>chk.checked=false);
      syncChecklistUI();
      spellList.innerHTML='<li>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</li>';
      warningPanel.textContent='‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å ‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡∏ß‡πà‡∏≤‡∏á';
      consultText.textContent='‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ã‡πâ‡∏≥ ‡πÜ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏™‡∏ô‡∏≠‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô';
    });

    // ================== INITIAL ==================
    syncChecklistUI();
    initAttachmentButtons();
    updateWarningPanel();
  </script>
</body>
</html>
