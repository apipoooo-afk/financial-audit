<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>FA Chatbot | ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body {
      margin:0;
      padding:0;
      font-family:"Segoe UI",Arial,sans-serif;
      background:#f5f6fa;
      color:#222;
    }

    header {
      background:linear-gradient(120deg,#0d6efd,#6f42c1,#20c997);
      color:white;
      padding:16px 20px;
      box-shadow:0 3px 10px rgba(0,0,0,0.25);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
    }

    .title {
      font-size:22px;
      font-weight:700;
    }

    .subtitle {
      font-size:13px;
      margin-top:4px;
      opacity:0.9;
      max-width:360px;
      line-height:1.5;
    }

    .right-box {
      text-align:right;
      font-size:12px;
    }

    .right-box a {
      color:#fff;
      text-decoration:underline;
    }

    .metrics-bar {
      background:#ffffff;
      padding:10px 16px;
      border-bottom:1px solid #ddd;
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:13px;
      flex-wrap:wrap;
      gap:6px;
    }

    .metric-pill {
      background:#e8f0ff;
      padding:5px 12px;
      border-radius:999px;
      font-size:13px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .container {
      display:flex;
      height:calc(100vh - 130px);
    }

    .left-pane {
      flex:3;
      display:flex;
      flex-direction:column;
      padding:12px;
      background:#ffffff;
      border-right:1px solid #ddd;
    }

    .right-pane {
      flex:1.4;
      padding:14px;
      background:#f0f4ff;
      overflow-y:auto;
    }

    .greeting-box {
      background:#f2f7ff;
      border-radius:12px;
      padding:12px 14px;
      margin-bottom:10px;
      line-height:1.5;
      font-size:13px;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
    }

    .label {
      margin-top:10px;
      margin-bottom:6px;
      font-weight:700;
      font-size:14px;
    }

    textarea {
      width:100%;
      min-height:80px;
      resize:none;
      border-radius:8px;
      border:1px solid #ccc;
      padding:10px;
      font-size:14px;
      font-family:inherit;
    }

    .controls {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
      margin-bottom:8px;
    }

    .controls button {
      padding:8px 14px;
      border:none;
      border-radius:8px;
      font-size:13px;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .btn-send { background:#0d6efd; color:white; }
    .btn-clear { background:#eeeeee; }
    .btn-back { background:#6c757d; color:white; margin-left:auto; }
    .btn-processing { background:#ffeb3b; color:#222; }
    .btn-speak { background:#20c997; color:white; }

    .answer-box {
      flex:1;
      padding:12px;
      border-radius:10px;
      background:#f7f7f7;
      border:1px solid #ddd;
      font-size:14px;
      line-height:1.6;
      overflow-y:auto;
      white-space:pre-wrap;
    }

    .sample-item {
      background:#ffffff;
      border-radius:10px;
      padding:10px 12px;
      margin-bottom:10px;
      cursor:pointer;
      box-shadow:0 1px 4px rgba(0,0,0,0.08);
      font-size:13px;
      transition:0.15s;
    }
    .sample-item:hover {
      background:#e7f0ff;
    }

    @media(max-width:900px) {
      .container { flex-direction:column; height:auto; }
      .left-pane, .right-pane { height:auto; }
    }
  </style>

</head>
<body>

<header>
  <div>
    <div class="title">ü§ñ FA Chatbot</div>
    <div class="subtitle">
      ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö ‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
      ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö FA (RAG)
    </div>
  </div>

  <div class="right-box">
    ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö: <span id="username-label">Guest</span><br>
    <a href="index.html">üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤ Index</a>
  </div>
</header>

<div class="metrics-bar">
  <span class="metric-pill">üë• ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô: <span id="current-users">0</span> ‡∏Ñ‡∏ô</span>
  <span class="metric-pill">üìä ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏™‡∏∞‡∏™‡∏°: <span id="total-questions">0</span> ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
  <span id="system-status">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</span>
</div>

<div class="container">

  <!-- Left pane (Chat Area) -->
  <div class="left-pane">

    <div class="greeting-box">
      ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞/‡∏Ñ‡∏£‡∏±‡∏ö üëã<br>
      ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠‚Äã <b>FA Chatbot</b> ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (Financial Audit ‚Äì FA)<br><br>
      ‚úî ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ ‡∏õ‡∏µ 2564, ‡πÅ‡∏ô‡∏ß‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡∏õ‡∏µ 2567, ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê<br>
      ‚úî ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (RAG)
    </div>

    <div class="label">‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
    <textarea id="question-input" placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î Materiality..."></textarea>

    <div class="controls">

      <button class="btn-send" id="btn-send">üì§ ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</button>
      <button class="btn-clear" id="btn-clear">üßπ ‡∏•‡πâ‡∏≤‡∏á</button>
      <button class="btn-processing" id="btn-processing" disabled style="display:none;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</button>
      <button class="btn-speak" id="btn-speak" disabled>üîä ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>

      <button class="btn-back" onclick="window.location.href='index.html'">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>

    <div class="label">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
    <div id="answer-box" class="answer-box">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‚Ä¶</div>

  </div>

  <!-- Right pane (Sample Questions) -->
  <div class="right-pane">
    <h3>üéØ ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</h3>
    <div id="sample-list"></div>
  </div>

</div>

<script>
  // ============================
  // SAMPLE QUESTIONS
  // ============================
  const sampleQuestions = [
    "‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à FA ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?",
    "‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î Materiality ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ 2564 ‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?",
    "‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?",
    "‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£?",
    "‡πÅ‡∏ô‡∏ß‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏û.‡∏®. 2567 ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?",
    "‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?",
    "‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?",
    "‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?",
    "‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏ï‡∏≤‡∏°‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏†‡∏≤‡∏Ñ‡∏£‡∏±‡∏ê‡∏°‡∏µ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÉ‡∏î?",
    "‡∏û‡∏ö‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏î‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡∏ß‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?"
  ];

  const sampleList = document.getElementById("sample-list");
  sampleQuestions.forEach(q => {
    const div = document.createElement("div");
    div.className = "sample-item";
    div.textContent = q;
    div.onclick = () => {
      document.getElementById("question-input").value = q;
      sendQuestion();
    };
    sampleList.appendChild(div);
  });

  // ============================
  // ELEMENTS
  // ============================
  const questionInput = document.getElementById("question-input");
  const answerBox = document.getElementById("answer-box");
  const btnSend = document.getElementById("btn-send");
  const btnClear = document.getElementById("btn-clear");
  const btnProcessing = document.getElementById("btn-processing");
  const btnSpeak = document.getElementById("btn-speak");
  const statusLabel = document.getElementById("system-status");
  const currentUsersEl = document.getElementById("current-users");
  const totalQuestionsEl = document.getElementById("total-questions");

  let lastAnswer = "";

  // ============================
  // LOCAL SESSION
  // ============================
  let userSession = null;
  try {
    userSession = sessionStorage.getItem("fa_user_session");
    const obj = JSON.parse(userSession || "{}");
    document.getElementById("username-label").textContent = obj.username || "Guest";
  } catch (e) {}

  // ============================
  // SEND QUESTION ‚Üí BACKEND
  // ============================
  btnSend.addEventListener("click", sendQuestion);
  questionInput.addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendQuestion();
    }
  });

  async function sendQuestion() {
    const q = questionInput.value.trim();
    if (!q) return;

    btnProcessing.style.display = "inline-flex";
    btnSend.disabled = true;
    btnClear.disabled = true;
    btnSpeak.disabled = true;
    statusLabel.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‚Ä¶";

    answerBox.textContent = "‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‚Ä¶";

    try {
      const res = await fetch("/api/fa-chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question: q, user_session: userSession })
      });

      const data = await res.json();

      let answer = data.answer || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ";
      if (data.sources && data.sources.length > 0) {
        answer += "\n\n‡πÅ‡∏´‡∏•‡πà‡∏á‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á:\n- " + data.sources.join("\n- ");
      }

      answerBox.textContent = answer;
      lastAnswer = answer;
      btnSpeak.disabled = false;

      statusLabel.textContent = "‡∏ï‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";

    } catch (err) {
      answerBox.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå";
      statusLabel.textContent = "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î";
    }

    btnProcessing.style.display = "none";
    btnSend.disabled = false;
    btnClear.disabled = false;

    fetchStats();
  }

  // ============================
  // CLEAR
  // ============================
  btnClear.addEventListener("click", () => {
    questionInput.value = "";
    answerBox.textContent = "‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‚Ä¶";
    btnSpeak.disabled = true;
  });

  // ============================
  // SPEAK ANSWER
  // ============================
  btnSpeak.addEventListener("click", () => {
    if (!lastAnswer) return;
    try {
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(lastAnswer);
      u.lang = "th-TH";
      u.rate = 1;
      u.pitch = 1;
      window.speechSynthesis.speak(u);
    } catch (e) {
      alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
    }
  });

  // ============================
  // STATS
  // ============================
  async function fetchStats() {
    try {
      const r = await fetch("/api/fa-stats");
      const d = await r.json();
      currentUsersEl.textContent = d.current_users;
      totalQuestionsEl.textContent = d.total_questions;
    } catch (e) {}
  }

  fetchStats();
  setInterval(fetchStats, 30000); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
</script>

</body>
</html>
