<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>FA ‚Äì Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å new e-LASS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS: ‡πÉ‡∏ä‡πâ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#060818;
      --bg-soft:#0b1024;
      --card:#11152b;
      --border:#262b46;
      --primary:#0d47a1;
      --primary-2:#42a5f5;
      --accent:#ffd54f;
      --text:#f5f7ff;
      --muted:#a3acc7;
      --danger:#ef5350;
      --success:#66bb6a;
      --radius-lg:16px;
      --shadow-soft:0 12px 30px rgba(0,0,0,0.55);
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, sans-serif;
      background:
        radial-gradient(circle at 10% 0%, rgba(123,30,60,0.3) 0, transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(66,165,245,0.22) 0, transparent 55%),
        #060818;
      color:var(--text);
      min-height:100vh;
    }

    header{
      padding:18px 20px 12px;
      background:linear-gradient(120deg,#7b1e3c,#0d47a1,#42a5f5);
      box-shadow:0 4px 18px rgba(0,0,0,0.55);
      border-bottom:1px solid rgba(255,255,255,0.18);
    }
    header h1{
      margin:0;
      font-size:22px;
      font-weight:700;
    }
    header p{
      margin:4px 0 0;
      font-size:13px;
      opacity:0.9;
    }

    .nav-bar{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:13px;
      align-items:center;
    }
    .nav-bar a{
      color:#ffebee;
      text-decoration:none;
    }
    .nav-bar span{
      opacity:0.8;
    }

    main{
      max-width:1100px;
      margin:20px auto 40px;
      padding:0 12px 30px;
    }

    .card{
      background:linear-gradient(160deg,rgba(17,21,43,0.96),rgba(11,16,36,0.98));
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      padding:18px 18px 20px;
      box-shadow:var(--shadow-soft);
      margin-bottom:18px;
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .card-header h2{
      margin:0;
      font-size:18px;
    }
    .card-header small{
      font-size:12px;
      color:var(--muted);
    }

    label{
      font-size:13px;
      display:block;
      margin-bottom:6px;
    }
    input[type="file"],
    select,
    input[type="text"],
    input[type="number"]{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#050814;
      color:var(--text);
      font-size:13px;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }
    .col{
      flex:1 1 200px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      border:none;
      padding:8px 16px;
      font-size:13px;
      cursor:pointer;
      background:var(--primary);
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,0.45);
      transition:transform 0.08s ease, box-shadow 0.08s ease, background 0.15s;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 7px 18px rgba(0,0,0,0.6);
      background:var(--primary-2);
    }
    .btn-secondary{
      background:#26324f;
    }
    .btn-secondary:hover{
      background:#39476c;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background:rgba(0,0,0,0.25);
      color:var(--muted);
    }

    .status{
      font-size:12px;
      margin-top:6px;
    }
    .status.ok{color:var(--success);}
    .status.err{color:var(--danger);}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:10px;
    }
    thead th{
      background:#101530;
      padding:6px 8px;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:5px 8px;
      border-top:1px solid #1f2440;
    }
    tbody tr:nth-child(even){
      background:#080c1c;
    }
    tbody tr:nth-child(odd){
      background:#0b1024;
    }

    .mapping-table th,
    .mapping-table td{
      vertical-align:middle;
    }

    .select-small{
      width:100%;
      padding:4px 8px;
      font-size:12px;
    }

    .badge{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      border:1px solid rgba(255,255,255,0.2);
      color:var(--muted);
    }

    pre{
      background:#050814;
      border-radius:10px;
      border:1px solid var(--border);
      padding:10px;
      font-size:11px;
      max-height:260px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-all;
    }

    @media(max-width:720px){
      header h1{font-size:19px;}
      .card{padding:14px 12px 16px;}
    }
  </style>
</head>
<body>

<header>
  <h1>FA ‚Äì ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å new e-LASS</h1>
  <p>‡πÉ‡∏ä‡πâ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ new e-LASS ‡∏°‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ‡∏≠‡∏õ‡∏ó. 8.2‚Äì8.31 ‡πÅ‡∏•‡∏∞‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</p>

  <div class="nav-bar">
    <a href="index.html">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</a>
    <span>‚Ä∫</span>
    <span>FA ‚Äì Import new e-LASS</span>
  </div>
</header>

<main>

  <!-- ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à / ‡∏õ‡∏µ‡∏á‡∏ö -->
  <section class="card">
    <div class="card-header">
      <h2>1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à & ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h2>
      <div class="pill">Step 1/3 ¬∑ Context</div>
    </div>

    <div class="row">
      <div class="col">
        <label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à (Organization Name / LG)</label>
        <input type="text" id="orgName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©">
      </div>
      <div class="col">
        <label>‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à (Org Code)</label>
        <input type="text" id="orgCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3350401">
      </div>
      <div class="col">
        <label>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (Fiscal Year ‚Äì ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</label>
        <input type="number" id="fiscalYear" placeholder="2568">
      </div>
    </div>
  </section>

  <!-- ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå -->
  <section class="card">
    <div class="card-header">
      <h2>2. ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö new e-LASS</h2>
      <div class="pill">Step 2/3 ¬∑ Upload & Preview</div>
    </div>

    <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå new e-LASS (.xlsx, .xls, .csv)</label>
    <input type="file" id="fileInput" accept=".xlsx,.xls,.csv">

    <div id="fileStatus" class="status"></div>

    <div id="previewContainer" style="margin-top:12px; display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <div class="pill">
          ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå
        </div>
        <button class="btn-secondary btn" id="btnRebuildMapping">
          üîÅ ‡∏™‡∏£‡πâ‡∏≤‡∏á Mapping ‡πÉ‡∏´‡∏°‡πà
        </button>
      </div>
      <div id="tablePreview" style="max-height:260px;overflow:auto;margin-top:8px;"></div>
    </div>
  </section>

  <!-- Mapping -->
  <section class="card">
    <div class="card-header">
      <h2>3. Mapping ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≤‡∏Å new e-LASS ‚Üí Schema ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô FA</h2>
      <div class="pill">Step 3/3 ¬∑ Column Mapping</div>
    </div>

    <p style="font-size:12px;color:var(--muted);margin-top:0;">
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô <strong>‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1)</strong> ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£
      ‡πÄ‡∏ä‡πà‡∏ô <strong>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì, ‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ, ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ, ‡πÄ‡∏î‡∏ö‡∏¥‡∏ï, ‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï, ‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</strong> ‡∏Ø‡∏•‡∏Ø
    </p>

    <div id="mappingTableContainer"></div>

    <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;">
      <button class="btn" id="btnTransform">
        ‚öô ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô
      </button>
      <div id="transformStatus" class="status"></div>
    </div>

    <div id="jsonResultContainer" style="margin-top:14px; display:none;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:6px;">
        <span class="badge">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏õ‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô)</span>
        <small style="color:var(--muted);">‡∏ô‡∏≥ JSON ‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ DB / API / ‡∏´‡∏ô‡πâ‡∏≤ ‡∏≠‡∏õ‡∏ó.8.x ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</small>
      </div>
      <pre id="jsonPreview"></pre>
    </div>
  </section>

</main>

<script>
  // === CONFIG: ‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö FA ===
  const TARGET_FIELDS = [
    { key: "ignore",       label: "‚ùå ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ô‡∏µ‡πâ (Ignore)" },
    { key: "fiscal_year",  label: "‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (fiscal_year)" },
    { key: "org_name",     label: "‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à (org_name)" },
    { key: "org_code",     label: "‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à (org_code)" },
    { key: "account_code", label: "‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (account_code)" },
    { key: "account_name", label: "‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ (account_name)" },
    { key: "amount_dr",    label: "‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏ö‡∏¥‡∏ï (amount_dr)" },
    { key: "amount_cr",    label: "‡∏¢‡∏≠‡∏î‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï (amount_cr)" },
    { key: "amount_net",   label: "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ / ‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (amount_net)" },
    { key: "period",       label: "‡∏á‡∏ß‡∏î (period)" }
  ];

  const fileInput        = document.getElementById("fileInput");
  const fileStatus       = document.getElementById("fileStatus");
  const previewContainer = document.getElementById("previewContainer");
  const tablePreview     = document.getElementById("tablePreview");
  const mappingContainer = document.getElementById("mappingTableContainer");
  const btnRebuildMapping= document.getElementById("btnRebuildMapping");
  const btnTransform     = document.getElementById("btnTransform");
  const transformStatus  = document.getElementById("transformStatus");
  const jsonResultContainer = document.getElementById("jsonResultContainer");
  const jsonPreview      = document.getElementById("jsonPreview");

  let uploadedData = [];   // array-of-arrays ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
  let headerRow    = [];   // ‡πÅ‡∏ñ‡∏ß‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå

  fileInput.addEventListener("change", handleFile);

  btnRebuildMapping.addEventListener("click", () => {
    if(!uploadedData.length){
      alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å new e-LASS ‡∏Å‡πà‡∏≠‡∏ô");
      return;
    }
    buildMappingTable();
  });

  btnTransform.addEventListener("click", transformDataToJSON);

  // ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel/CSV
  function handleFile(e){
    const file = e.target.files[0];
    jsonResultContainer.style.display = "none";
    transformStatus.textContent = "";

    if(!file){
      fileStatus.textContent = "";
      previewContainer.style.display = "none";
      tablePreview.innerHTML = "";
      mappingContainer.innerHTML = "";
      return;
    }

    fileStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...";
    fileStatus.className = "status";

    const reader = new FileReader();
    const fileName = file.name.toLowerCase();

    if(fileName.endsWith(".xlsx") || fileName.endsWith(".xls")){
      reader.readAsArrayBuffer(file);
      reader.onload = (event) => {
        try{
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const firstSheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheetName];

          // sheet_to_json with header:1 => array of arrays
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
          processRawRows(rows);
        }catch(err){
          console.error(err);
          fileStatus.textContent = "‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå Excel ‚Äì ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
          fileStatus.className = "status err";
        }
      };
    }else if(fileName.endsWith(".csv")){
      reader.readAsText(file, "utf-8");
      reader.onload = (event) => {
        const text = event.target.result;
        const rows = text.split(/\r?\n/).map(line => line.split(","));
        processRawRows(rows);
      };
    }else{
      fileStatus.textContent = "‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå .xlsx .xls .csv ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô";
      fileStatus.className = "status err";
    }
  }

  // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• rows ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
  function processRawRows(rows){
    if(!rows.length){
      fileStatus.textContent = "‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
      fileStatus.className = "status err";
      return;
    }

    uploadedData = rows;
    headerRow = rows[0];

    fileStatus.textContent = `‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${rows.length-1} ‡πÅ‡∏ñ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)`;
    fileStatus.className = "status ok";

    renderPreviewTable(rows);
    buildMappingTable();
  }

  // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå
  function renderPreviewTable(rows){
    if(!rows.length) return;

    previewContainer.style.display = "block";

    const maxRows = Math.min(6, rows.length); // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 6 ‡πÅ‡∏ñ‡∏ß

    let html = "<table><thead><tr>";
    rows[0].forEach((h, idx) => {
      html += `<th>Col ${idx+1}<br>${escapeHtml(String(h))}</th>`;
    });
    html += "</tr></thead><tbody>";

    for(let r=1; r<maxRows; r++){
      html += "<tr>";
      rows[r].forEach(cell => {
        html += `<td>${escapeHtml(String(cell ?? ""))}</td>`;
      });
      html += "</tr>";
    }

    html += "</tbody></table>";
    tablePreview.innerHTML = html;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á Mapping
  function buildMappingTable(){
    if(!headerRow.length){
      mappingContainer.innerHTML = "<p style='font-size:12px;color:var(--muted);'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå</p>";
      return;
    }

    let html = "<table class='mapping-table'><thead><tr>";
    html += "<th style='width:5%;'>#</th>";
    html += "<th style='width:45%;'>‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≤‡∏Å new e-LASS</th>";
    html += "<th style='width:50%;'>‡πÅ‡∏°‡∏õ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ü‡∏¥‡∏•‡∏î‡πå‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á FA</th>";
    html += "</tr></thead><tbody>";

    headerRow.forEach((headerText, idx) => {
      const suggestedKey = guessTargetField(String(headerText || ""));
      html += "<tr>";
      html += `<td>${idx+1}</td>`;
      html += `<td>${escapeHtml(String(headerText || "(‡∏ß‡πà‡∏≤‡∏á)"))}</td>`;
      html += `<td>${buildSelectHtml(idx, suggestedKey)}</td>`;
      html += "</tr>";
    });

    html += "</tbody></table>";

    mappingContainer.innerHTML = html;
  }

  // Dropdown ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
  function buildSelectHtml(colIndex, suggestedKey){
    let html = `<select class="select-small mapping-select" data-col-index="${colIndex}">`;
    TARGET_FIELDS.forEach(field => {
      const selected = (field.key === suggestedKey) ? "selected" : "";
      html += `<option value="${field.key}" ${selected}>${escapeHtml(field.label)}</option>`;
    });
    html += "</select>";
    return html;
  }

  // ‡πÄ‡∏î‡∏≤ type ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏±‡∏ß
  function guessTargetField(header){
    const h = header.toLowerCase();

    if(h.includes("‡∏õ‡∏µ‡∏á‡∏ö") || h.includes("fiscal")) return "fiscal_year";
    if(h.includes("‡∏£‡∏´‡∏±‡∏™") && h.includes("‡∏´‡∏ô‡πà‡∏ß‡∏¢")) return "org_code";
    if((h.includes("‡∏ä‡∏∑‡πà‡∏≠") && h.includes("‡∏´‡∏ô‡πà‡∏ß‡∏¢")) || h.includes("‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£") || h.includes("‡∏≠‡∏õ‡∏ó")) return "org_name";
    if((h.includes("‡∏£‡∏´‡∏±‡∏™") && h.includes("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ")) || h.startsWith("acc") || h.includes("‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ")) return "account_code";
    if((h.includes("‡∏ä‡∏∑‡πà‡∏≠") && h.includes("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ")) || h.includes("‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ")) return "account_name";
    if(h.includes("‡πÄ‡∏î‡∏ö‡∏¥‡∏ï") || h.includes("debit")) return "amount_dr";
    if(h.includes("‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï") || h.includes("credit")) return "amount_cr";
    if(h.includes("‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠") || h.includes("‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠") || h.includes("‡∏™‡∏∏‡∏ó‡∏ò‡∏¥") || h.includes("balance")) return "amount_net";
    if(h.includes("‡∏á‡∏ß‡∏î") || h.includes("period")) return "period";

    return "ignore";
  }

  // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏° Mapping
  function transformDataToJSON(){
    transformStatus.textContent = "";
    jsonResultContainer.style.display = "none";
    jsonPreview.textContent = "";

    if(!uploadedData.length){
      transformStatus.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô";
      transformStatus.className = "status err";
      return;
    }

    const fiscalYear = document.getElementById("fiscalYear").value;
    const orgName    = document.getElementById("orgName").value;
    const orgCode    = document.getElementById("orgCode").value;

    const selects = Array.from(document.querySelectorAll(".mapping-select"));
    if(!selects.length){
      transformStatus.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á Mapping ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå";
      transformStatus.className = "status err";
      return;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á mapping ‡πÅ‡∏ö‡∏ö {colIndex: fieldKey}
    const colMapping = {};
    selects.forEach(sel => {
      const colIndex = parseInt(sel.dataset.colIndex, 10);
      const fieldKey = sel.value;
      colMapping[colIndex] = fieldKey;
    });

    const results = [];
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ß index = 1 (‡∏Ç‡πâ‡∏≤‡∏°‡∏´‡∏±‡∏ß‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)
    for(let r=1; r<uploadedData.length; r++){
      const row = uploadedData[r];
      // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á ‡πÜ
      if(!row || row.every(c => (c === null || c === undefined || String(c).trim() === ""))){
        continue;
      }

      const obj = {};

      // context ‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡∏ü‡∏≠‡∏£‡πå‡∏°
      if(fiscalYear) obj.fiscal_year = fiscalYear;
      if(orgName)    obj.org_name    = orgName;
      if(orgCode)    obj.org_code    = orgCode;

      // ‡πÅ‡∏°‡∏õ‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
      Object.keys(colMapping).forEach(idxStr => {
        const colIdx = parseInt(idxStr, 10);
        const key = colMapping[colIdx];
        if(!key || key === "ignore") return;

        const cellVal = row[colIdx] ?? "";
        if(key === "fiscal_year" && !fiscalYear){
          obj.fiscal_year = cellVal;
        }else if(key === "org_name" && !orgName){
          obj.org_name = cellVal;
        }else if(key === "org_code" && !orgCode){
          obj.org_code = cellVal;
        }else{
          obj[key] = cellVal;
        }
      });

      results.push(obj);
    }

    transformStatus.textContent = `‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${results.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö FA)`;
    transformStatus.className = "status ok";

    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á JSON ‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô
    const previewSlice = results.slice(0, 20); // ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 20 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    jsonPreview.textContent = JSON.stringify(previewSlice, null, 2);
    jsonResultContainer.style.display = "block";

    console.log("FA-Standard JSON:", results);
    // ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠:
    // - ‡∏™‡πà‡∏á results ‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend/API
    // - ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage / IndexedDB ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ‡∏≠‡∏õ‡∏ó.8.x
  }

  function escapeHtml(str){
    return str
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }
</script>

</body>
</html>