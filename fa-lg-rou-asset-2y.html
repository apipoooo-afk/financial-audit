<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>งบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน (2 ปี)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, sans-serif;
      background:#060818;
      color:#f5f7ff;
    }
    header{
      padding:18px 20px 10px;
      background:linear-gradient(120deg,#0d47a1,#42a5f5,#7b1e3c);
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
    }
    h1{margin:0;font-size:26px;font-weight:700;}
    .header-sub{
      margin-top:6px;
      font-size:13px;
      opacity:0.85;
    }
    .container{
      padding:20px;
      max-width:1200px;
      margin:0 auto;
    }
    .card{
      background:#11152b;
      padding:20px;
      border-radius:12px;
      border:1px solid #262b46;
      margin-bottom:20px;
    }
    .card h3{
      margin-top:0;
    }
    .upload-row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      align-items:flex-start;
    }
    label{
      font-size:14px;
    }
    input[type="file"],
    select,
    input[type="text"],
    input[type="number"],
    input[type="url"]{
      margin-top:4px;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #3c456e;
      background:#0b1024;
      color:#f5f7ff;
      font-size:13px;
    }
    select{
      min-width:120px;
    }
    .btn-primary{
      padding:8px 18px;
      background:#42a5f5;
      color:white;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    .btn-primary:hover{
      background:#1e88e5;
    }
    .btn-nav{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.16);
      color:#f5f7ff;
      font-size:12px;
      cursor:pointer;
      margin-right:8px;
    }
    .btn-nav:hover{
      background:rgba(255,255,255,0.12);
    }
    .nav-bar{
      margin-top:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:16px;
      background:#11152b;
    }
    th,td{
      border:1px solid #262b46;
      padding:8px;
      font-size:13px;
    }
    th{
      background:#0d47a1;
      text-align:center;
    }
    .line-label { width:45%; }
    .year-col { width:25%; text-align:right; }
    .note-title{
      background:#2b3358;
      font-weight:700;
      padding:10px;
      margin-top:10px;
      border-radius:8px;
      border:1px solid #3c456e;
      font-size:14px;
    }
    .helper-text{
      font-size:12px;
      color:#a3acc7;
      margin-top:6px;
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
    }
    .col{
      flex:1;
      min-width:260px;
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      background:rgba(66,165,245,0.12);
      border:1px solid rgba(66,165,245,0.5);
      color:#bbdefb;
      margin-left:8px;
    }
    #currentDateTime{
      font-size:12px;
      margin-top:4px;
    }
    ul.attach-list{
      list-style:none;
      padding-left:16px;
      font-size:12px;
      margin:8px 0 0;
    }
    ul.attach-list li{
      margin-bottom:2px;
      color:#cfd8dc;
    }
    .badge{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:#263238;
      margin-left:6px;
    }
    .file-slot{
      margin-bottom:4px;
    }
    .report-header-preview{
      text-align:center;
      margin-bottom:12px;
      line-height:1.6;
    }
  </style>
</head>

<body>

<header>
  <h1>งบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน (2 ปี)</h1>
  <div class="header-sub">
    ระบบประมวลผลจากกระดาษทำการ + บันทึกข้อมูลลงฐานข้อมูลรายงานการตรวจสอบ
    <span class="pill">SOCE – Digital Working Paper</span>
    <div id="currentDateTime"></div>
  </div>

  <div class="nav-bar">
    <!-- แก้ href ให้ตรงระบบจริงได้ -->
    <button class="btn-nav" onclick="location.href='index.html'">กลับไปหน้าหลักระบบ</button>
    <button class="btn-nav" onclick="location.href='fa-lg-fieldwork.html'">ไปหน้า FA – กระดาษทำการ</button>
    <button class="btn-nav" onclick="location.href='fa-lg-annual-report.html'">ไปหน้ารายงานการตรวจสอบ</button>
  </div>
</header>

<div class="container">

  <!-- 1. ข้อมูลหน่วยรับตรวจ และไฟล์ Excel -->
  <div class="card">
    <h3>1. ข้อมูลหน่วยรับตรวจ และนำเข้าไฟล์ Excel กระดาษทำการ SOCE</h3>

    <div class="row">
      <div class="col">
        <label>ปีงบประมาณ (ปี N):</label><br>
        <select id="yearN">
          <option value="">-- เลือกปี --</option>
          <option>2560</option><option>2561</option><option>2562</option>
          <option>2563</option><option>2564</option><option>2565</option>
          <option>2566</option><option>2567</option><option>2568</option>
          <option>2569</option><option>2570</option><option>2571</option>
          <option>2572</option><option>2573</option><option>2574</option>
          <option>2575</option><option>2576</option><option>2577</option>
          <option>2578</option><option>2579</option><option>2580</option>
          <option>2581</option><option>2582</option>
        </select>
        <div class="helper-text">
          ปี N-1 (อัตโนมัติ): <span id="yearNMinus1">-</span>
        </div>
      </div>

      <div class="col">
        <label>รหัสรายงาน / เลขที่งานตรวจสอบ:</label><br>
        <input type="text" id="auditId" placeholder="เช่น OAG-SSK-FA-2568-001">
      </div>
    </div>

    <!-- แถวใหม่: ชื่อหน่วยรับตรวจ + ปีสิ้นสุด 30 ก.ย. -->
    <div class="row" style="margin-top:12px;">
      <div class="col">
        <label>ชื่อหน่วยรับตรวจ:</label><br>
        <input type="text" id="entityName" placeholder="เช่น เทศบาลเมืองทดสอบ">
      </div>
      <div class="col">
        <label>สำหรับปีสิ้นสุดวันที่ 30 กันยายน (พ.ศ.):</label><br>
        <select id="yearEnd">
          <option value="">-- เลือกปีสิ้นสุด --</option>
          <option>2565</option><option>2566</option><option>2567</option>
          <option>2568</option><option>2569</option><option>2570</option>
          <option>2571</option><option>2572</option><option>2573</option>
          <option>2574</option><option>2575</option><option>2576</option>
          <option>2577</option><option>2578</option><option>2579</option>
          <option>2580</option><option>2581</option><option>2582</option>
        </select>
      </div>
    </div>

    <div class="note-title" style="margin-top:20px;">ไฟล์กระดาษทำการ Excel ที่ใช้ประมวลผล</div>

    <div class="upload-row" style="margin-top:10px;">
      <div class="col">
        <label>ไฟล์ปีล่าสุด (ปี N) สูงสุด 10 ไฟล์:</label><br>
        <div id="fileCurrentGroup">
          <div class="file-slot"><input type="file" class="fileCurrent" accept=".xlsx,.xls,.xlsm"></div>
          <div class="file-slot"><input type="file" class="fileCurrent" accept=".xlsx,.xls,.xlsm"></div>
          <div class="file-slot"><input type="file" class="fileCurrent" accept=".xlsx,.xls,.xlsm"></div>
          <div class="file-slot"><input type="file" class="fileCurrent" accept=".xlsx,.xls,.xlsm"></div>
          <div class="file-slot"><input type="file" class="fileCurrent" accept=".xlsx,.xls,.xlsm"></div>
        </div>
      </div>

      <div class="col">
        <label>ไฟล์ปีก่อน (ปี N-1) สูงสุด 10 ไฟล์:</label><br>
        <div id="filePreviousGroup">
          <div class="file-slot"><input type="file" class="filePrevious" accept=".xlsx,.xls,.xlsm"></div>
          <div class="file-slot"><input type="file" class="filePrevious" accept=".xlsx,.xls,.xlsm"></div>
          <div class="file-slot"><input type="file" class="filePrevious" accept=".xlsx,.xls,.xlsm"></div>
          <div class="file-slot"><input type="file" class="filePrevious" accept=".xlsx,.xls,.xlsm"></div>
          <div class="file-slot"><input type="file" class="filePrevious" accept=".xlsx,.xls,.xlsm"></div>
         </div>
      </div>
    </div>

    <p class="helper-text">
      *ไฟล์ควรมีโครงสร้างแถว/คอลัมน์ตามแบบ SOCE ของระบบ (Sheet: <code>Eqiuty</code>, คอลัมน์ C เป็นยอดเงินต่อบรรทัด)
      ระบบจะรวมยอดจากทุกไฟล์ของแต่ละปีให้เป็นตัวเลขรวมของปีนั้น
    </p>

    <button class="btn-primary" style="margin-top:10px;" onclick="processSOCE()">
      ประมวลผลงบแสดงการเปลี่ยนแปลง SOCE
    </button>
  </div>

  <!-- 2. แนบไฟล์ 1 -->
  <div class="card">
    <h3>2. แนบเอกสารประกอบการตรวจสอบ (รองรับทุกชนิดไฟล์)</h3>
    <label>ไฟล์แนบเพิ่มเติม (PDF, รูปภาพ, Word, อื่น ๆ):<br>
      <input type="file" id="attachments" multiple />
    </label>
    <p class="helper-text">
      ระบบจะบันทึกข้อมูลเมตาของไฟล์แนบ (ชื่อไฟล์ ประเภท ขนาด) ไปพร้อมกับผลการประมวล SOCE
    </p>
    <ul id="attachmentsList" class="attach-list"></ul>
  </div>
<!-- 2. แนบไฟล์ 2 -->
  <div class="card">
    <h3>2. แนบเอกสารประกอบการตรวจสอบ (รองรับทุกชนิดไฟล์)</h3>
    <label>ไฟล์แนบเพิ่มเติม (PDF, รูปภาพ, Word, อื่น ๆ):<br>
      <input type="file" id="attachments" multiple />
    </label>
    <p class="helper-text">
      ระบบจะบันทึกข้อมูลเมตาของไฟล์แนบ (ชื่อไฟล์ ประเภท ขนาด) ไปพร้อมกับผลการประมวล SOCE
    </p>
    <ul id="attachmentsList" class="attach-list"></ul>
  </div>
  <!-- 2. แนบไฟล์ 3 -->
  <div class="card">
    <h3>2. แนบเอกสารประกอบการตรวจสอบ (รองรับทุกชนิดไฟล์)</h3>
    <label>ไฟล์แนบเพิ่มเติม (PDF, รูปภาพ, Word, อื่น ๆ):<br>
      <input type="file" id="attachments" multiple />
    </label>
    <p class="helper-text">
      ระบบจะบันทึกข้อมูลเมตาของไฟล์แนบ (ชื่อไฟล์ ประเภท ขนาด) ไปพร้อมกับผลการประมวล SOCE
    </p>
    <ul id="attachmentsList" class="attach-list"></ul>
  </div>
  <!-- 2. แนบไฟล์ 4 -->
  <div class="card">
    <h3>2. แนบเอกสารประกอบการตรวจสอบ (รองรับทุกชนิดไฟล์)</h3>
    <label>ไฟล์แนบเพิ่มเติม (PDF, รูปภาพ, Word, อื่น ๆ):<br>
      <input type="file" id="attachments" multiple />
    </label>
    <p class="helper-text">
      ระบบจะบันทึกข้อมูลเมตาของไฟล์แนบ (ชื่อไฟล์ ประเภท ขนาด) ไปพร้อมกับผลการประมวล SOCE
    </p>
    <ul id="attachmentsList" class="attach-list"></ul>
  </div>
  <!-- 2. แนบไฟล์ 5 -->
  <div class="card">
    <h3>2. แนบเอกสารประกอบการตรวจสอบ (รองรับทุกชนิดไฟล์)</h3>
    <label>ไฟล์แนบเพิ่มเติม (PDF, รูปภาพ, Word, อื่น ๆ):<br>
      <input type="file" id="attachments" multiple />
    </label>
    <p class="helper-text">
      ระบบจะบันทึกข้อมูลเมตาของไฟล์แนบ (ชื่อไฟล์ ประเภท ขนาด) ไปพร้อมกับผลการประมวล SOCE
    </p>
    <ul id="attachmentsList" class="attach-list"></ul>
  </div>
  <!-- 2. แนบไฟล์ 6 -->
  <div class="card">
    <h3>2. แนบเอกสารประกอบการตรวจสอบ (รองรับทุกชนิดไฟล์)</h3>
    <label>ไฟล์แนบเพิ่มเติม (PDF, รูปภาพ, Word, อื่น ๆ):<br>
      <input type="file" id="attachments" multiple />
    </label>
    <p class="helper-text">
      ระบบจะบันทึกข้อมูลเมตาของไฟล์แนบ (ชื่อไฟล์ ประเภท ขนาด) ไปพร้อมกับผลการประมวล SOCE
    </p>
    <ul id="attachmentsList" class="attach-list"></ul>
  </div>
  <!-- 3. ผลประมวล + หัวงบแบบเรียลไทม์ -->
  <div class="card">
    <h3>3. ผลการประมวลงบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน</h3>

      <!-- หัวงบแบบเดียวกับ Excel (อัปเดตเรียลไทม์) + ปุ่ม Export -->
  <div class="export-row" style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:10px;">
    <button class="btn-primary" type="button" onclick="exportSOCEToExcel()">Export Excel</button>
    <button class="btn-primary" type="button" onclick="exportSOCEToWord()">Export Word</button>
    <button class="btn-primary" type="button" onclick="exportSOCEToPDF()">Export PDF</button>
  </div>

  <!-- ส่วนที่ใช้เป็นเนื้อหาในการ Export (หัว + ตาราง) -->
  <div id="reportSection">
    <div id="reportHeaderPreview" class="report-header-preview"></div>

    <div id="soceContainer">
      <p class="helper-text">
        ยังไม่มีการประมวลผล แสดงผลเมื่อเลือกไฟล์และกดปุ่ม “ประมวลผลงบ SOCE”
      </p>
    </div>
  </div>
</div>

  <!-- 4. บันทึกผล -->
  <div class="card">
    <h3>4. การบันทึกผลการประมวลลงระบบฐานข้อมูลรายงานการตรวจสอบ</h3>

    <div class="row">
      <div class="col">
        <label>จุดปลายทางการเก็บข้อมูลผลการประมวล:</label><br>
        <select id="saveTarget">
          <option value="local">บันทึกลงฐานข้อมูลในเครื่อง (localStorage)</option>
          <option value="download">ดาวน์โหลดไฟล์ JSON</option>
          <option value="api">ส่งไปยัง API / Database กลาง</option>
        </select>
      </div>
      <div class="col" id="apiUrlContainer" style="display:none;">
        <label>URL จุดปลายทาง API (ตัวอย่าง):</label><br>
        <input type="url" id="apiUrl" placeholder="เช่น https://your-api.gov/soce-report">
      </div>
    </div>

    <p class="helper-text">
      *ระบบนี้เตรียมโครงสร้างการบันทึกข้อมูลให้แล้ว สามารถต่อเชื่อมกับ Database จริงผ่าน API ได้โดยตรง
    </p>

    <button class="btn-primary" style="margin-top:10px;" onclick="saveResult()">
      บันทึกผลการประมวล
    </button>
  </div>
// -------------------------
// ฟังก์ชัน Export SOCE
// -------------------------
function getSOCEFileName(prefix){
  const entity = (document.getElementById("entityName")?.value || "").trim() || "SOCE";
  const yearEnd = document.getElementById("yearEnd")?.value || "";
  const safeEntity = entity.replace(/[\\/:*?"<>|]/g, "_");
  return `${prefix}_${safeEntity}_${yearEnd || "XXXX"}`;
}

// Export เป็น Excel (ใช้ XLSX จาก CDN เดิม)
function exportSOCEToExcel(){
  const table = document.querySelector("#soceContainer table");
  if (!table){
    alert("ยังไม่มีตารางผลการประมวล ไม่สามารถส่งออกได้");
    return;
  }
  const wb = XLSX.utils.table_to_book(table, { sheet: "SOCE" });
  const fileName = getSOCEFileName("SOCE") + ".xlsx";
  XLSX.writeFile(wb, fileName);
}

// Export เป็น Word (ไฟล์ .doc เปิดด้วย MS Word ได้)
function exportSOCEToWord(){
  const headerDiv = document.getElementById("reportHeaderPreview");
  const table = document.querySelector("#soceContainer table");
  if (!table){
    alert("ยังไม่มีตารางผลการประมวล ไม่สามารถส่งออกได้");
    return;
  }

  const headerHtml = headerDiv ? headerDiv.innerHTML : "";
  const tableHtml = table.outerHTML;

  const html =
    '<html xmlns:o="urn:schemas-microsoft-com:office:office" ' +
    'xmlns:w="urn:schemas-microsoft-com:office:word" ' +
    'xmlns="http://www.w3.org/TR/REC-html40">' +
    "<head><meta charset='utf-8'><title>SOCE</title></head><body>" +
    headerHtml +
    tableHtml +
    "</body></html>";

  const blob = new Blob(['\ufeff', html], { type: "application/msword" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = getSOCEFileName("SOCE") + ".doc";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// Export เป็น PDF (จับภาพทั้ง #reportSection)
async function exportSOCEToPDF(){
  const section = document.getElementById("reportSection");
  if (!section || !document.querySelector("#soceContainer table")){
    alert("ยังไม่มีตารางผลการประมวล ไม่สามารถส่งออกได้");
    return;
  }

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  // แปลง DOM เป็นภาพด้วย html2canvas
  const canvas = await html2canvas(section, { scale: 2 });
  const imgData = canvas.toDataURL("image/png");

  const pdfWidth = pdf.internal.pageSize.getWidth();
  const imgProps = pdf.getImageProperties(imgData);
  const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

  pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
  pdf.save(getSOCEFileName("SOCE") + ".pdf");
}

  <!-- 5. ตัวอย่าง layout -->
  <div class="card">
    <h3>5. ตัวอย่างรูปแบบงบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน</h3>
    <p class="helper-text">
      ตัวอย่างนี้ใช้เพื่ออ้างอิงรูปแบบการจัดวางคอลัมน์ให้ใกล้เคียงแบบใน Excel จริง
      ไม่ใช่ข้อมูลที่ประมวลผลจากไฟล์
    </p>

    <table>
      <tr>
        <th rowspan="2" style="width:24%;">รายการ / หมายเหตุ</th>
        <th colspan="8">ส่วนประกอบของสินทรัพย์สุทธิ/ส่วนทุน</th>
      </tr>
      <tr>
        <th>เงินสะสม</th>
        <th>เงินทุนสำรองเงินสะสม</th>
        <th>รายได้สะสม</th>
        <th>ทุนสำรองเงินทุน</th>
        <th>กำไร/ขาดทุนสะสม</th>
        <th>รวมรายได้สูง/(ต่ำ) กว่าค่าใช้จ่ายสะสม</th>
        <th>องค์ประกอบอื่นของสินทรัพย์สุทธิ/ส่วนทุน</th>
        <th>รวมสินทรัพย์สุทธิ/ส่วนทุน</th>
      </tr>
      <tr>
        <td>ยอดคงเหลือ ณ วันที่ 30 กันยายน 2566 - ตามที่รายงานไว้เดิม</td>
        <td style="text-align:right">2,899,668,388.22</td>
        <td style="text-align:right">269,429,560.62</td>
        <td style="text-align:right">241,397,572.95</td>
        <td style="text-align:right">43,231,069.10</td>
        <td style="text-align:right">-</td>
        <td style="text-align:right">3,453,726,590.89</td>
        <td style="text-align:right">-</td>
        <td style="text-align:right">3,453,726,590.89</td>
      </tr>
      <tr>
        <td>รายได้สูง/(ต่ำ) กว่าค่าใช้จ่ายของปี</td>
        <td style="text-align:right">236,915,000.21</td>
        <td style="text-align:right">-</td>
        <td style="text-align:right">95,097,170.35</td>
        <td style="text-align:right">44,665,910.15</td>
        <td style="text-align:right">3,390,191.43</td>
        <td style="text-align:right">3,390,191.43</td>
        <td style="text-align:right">-</td>
        <td style="text-align:right">335,402,361.99</td>
      </tr>
      <tr>
        <td><strong>ยอดคงเหลือ ณ วันที่ 30 กันยายน 2567</strong></td>
        <td style="text-align:right"><strong>3,590,192,339.54</strong></td>
        <td style="text-align:right"><strong>-</strong></td>
        <td style="text-align:right"><strong>344,660,593.55</strong></td>
        <td style="text-align:right"><strong>44,665,910.15</strong></td>
        <td style="text-align:right"><strong>3,390,191.43</strong></td>
        <td style="text-align:right"><strong>3,982,099,034.67</strong></td>
        <td style="text-align:right"><strong>-</strong></td>
        <td style="text-align:right"><strong>3,982,099,034.67</strong></td>
      </tr>
    </table>
  </div>

</div>

<!-- XLSX -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>

<script>
  // เวลา
  function updateDateTime(){
    const now = new Date();
    const options = {
      year: 'numeric', month: 'long', day: 'numeric',
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    };
    document.getElementById("currentDateTime").textContent =
      "วันที่/เวลา ปัจจุบัน: " + now.toLocaleString("th-TH", options);
  }
  setInterval(updateDateTime, 1000);
  updateDateTime();

  // ปี N-1 อัตโนมัติ
  document.getElementById("yearN").addEventListener("change", ()=>{
    const y = parseInt(document.getElementById("yearN").value,10);
    document.getElementById("yearNMinus1").textContent = isNaN(y) ? "-" : (y-1);
  });

  // ไฟล์แนบ
  let attachmentsMeta = [];
  document.getElementById("attachments").addEventListener("change", (e)=>{
    const files = Array.from(e.target.files);
    attachmentsMeta = files.map(f => ({
      name: f.name,
      size: f.size,
      type: f.type
    }));
    const list = document.getElementById("attachmentsList");
    list.innerHTML = "";
    attachmentsMeta.forEach(a=>{
      const li = document.createElement("li");
      li.textContent = a.name + " (" + a.type + ", " + a.size.toLocaleString() + " bytes)";
      list.appendChild(li);
    });
  });

  // หัวรายงานแบบเรียลไทม์
  function updateReportHeader(){
    const entity = (document.getElementById("entityName").value || "").trim() || "ชื่อหน่วยรับตรวจ";
    const yearEnd = document.getElementById("yearEnd").value;
    const line2 = "งบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน";
    const line3 = "สำหรับปีสิ้นสุดวันที่ 30 กันยายน " + (yearEnd || "........");
    document.getElementById("reportHeaderPreview").innerHTML = `
      <div>${entity}</div>
      <div>${line2}</div>
      <div>${line3}</div>
    `;
  }

  document.getElementById("entityName").addEventListener("input", updateReportHeader);
  document.getElementById("yearEnd").addEventListener("change", updateReportHeader);
  updateReportHeader(); // เรียกครั้งแรก

  // Template SOCE
  const SOCE_TEMPLATE = {
    fs_type : "SOCE",
    sheet_name : "Eqiuty",
    lines : [
      { line_code:"SOCE_001", excel_row: 8, raw_label:"ยอดคงเหลือ ณ วันที่ 30 กันยายน (N-2) ตามที่รายงานเดิม" },
      { line_code:"SOCE_002", excel_row: 9, raw_label:"ผลสะสมจากการแก้ไขข้อผิดพลาดปีก่อน" },
      { line_code:"SOCE_003", excel_row:10, raw_label:"ผลสะสมของการเปลี่ยนแปลงนโยบายการบัญชี" },
      { line_code:"SOCE_004", excel_row:11, raw_label:"ยอดคงเหลือหลังปรับปรุง (N-2)" },
      { line_code:"SOCE_005", excel_row:12, raw_label:"การเปลี่ยนแปลงในสินทรัพย์สุทธิ/ส่วนทุน (N-1)" },
      { line_code:"SOCE_006", excel_row:13, raw_label:"การเปลี่ยนแปลงที่ทำให้ทุนเพิ่ม/ลด" },
      { line_code:"SOCE_007", excel_row:14, raw_label:"รายได้สูง/(ต่ำ) กว่าค่าใช้จ่าย" },
      { line_code:"SOCE_008", excel_row:15, raw_label:"ยอดคงเหลือ ณ สิ้นปี N-1" },
      { line_code:"SOCE_009", excel_row:17, raw_label:"ยอดคงเหลือ (N-1) ตามที่รายงานเดิม" },
      { line_code:"SOCE_010", excel_row:18, raw_label:"ผลสะสมแก้ไขข้อผิดพลาด" },
      { line_code:"SOCE_011", excel_row:19, raw_label:"ผลสะสมเปลี่ยนแปลงนโยบาย" },
      { line_code:"SOCE_012", excel_row:20, raw_label:"ยอดคงเหลือหลังปรับปรุง (N-1)" },
      { line_code:"SOCE_013", excel_row:21, raw_label:"การเปลี่ยนแปลงในสินทรัพย์สุทธิ/ส่วนทุน ปี N" },
      { line_code:"SOCE_014", excel_row:22, raw_label:"การเปลี่ยนแปลงที่ทำให้ทุนเพิ่ม/ลด" },
      { line_code:"SOCE_015", excel_row:23, raw_label:"รายได้สูง/(ต่ำ) กว่าค่าใช้จ่าย" },
      { line_code:"SOCE_016", excel_row:24, raw_label:"ยอดคงเหลือ ณ สิ้นปี N" }
    ]
  };

  async function readWorkbook(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type:"array" });
          resolve(workbook);
        }catch(err){
          reject(err);
        }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  function getSheetByTemplate(workbook, template){
    if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0){
      return null;
    }
    const targetName = template.sheet_name;
    if (workbook.Sheets[targetName]){
      return workbook.Sheets[targetName];
    }
    const firstName = workbook.SheetNames[0];
    return workbook.Sheets[firstName];
  }

  function getCellValue(sheet, rowIndex, colIndex){
    if (!sheet) return "";
    const addr = XLSX.utils.encode_cell({ r: rowIndex, c: colIndex });
    const cell = sheet[addr];
    return cell ? cell.v : "";
  }

  function formatNumber(value){
    if (value === null || value === undefined || value === "") return "";
    const num = Number(value);
    if (!isNaN(num)){
      return num.toLocaleString("th-TH", {
        minimumFractionDigits:2,
        maximumFractionDigits:2
      });
    }
    return value;
  }

  function aggregateYear(workbooks, template){
    const result = {};
    template.lines.forEach(line=>{
      result[line.line_code] = { sum:0, hasValue:false };
    });

    workbooks.forEach(wb=>{
      const sheet = getSheetByTemplate(wb, template);
      if (!sheet) return;
      template.lines.forEach(line=>{
        const rowIndex = line.excel_row - 1;
        const colIndex = 2;
        const raw = getCellValue(sheet, rowIndex, colIndex);
        const num = Number(raw);
        if (!isNaN(num)){
          const rec = result[line.line_code];
          rec.sum += num;
          rec.hasValue = true;
        }
      });
    });

    return result;
  }

  let latestSoceData = null;

  async function processSOCE() {
    const yearN = document.getElementById("yearN").value;
    const yearPrev = document.getElementById("yearNMinus1").textContent;
    const auditId = document.getElementById("auditId").value.trim();

    if (!yearN){
      alert("กรุณาเลือกปีงบประมาณ (ปี N)");
      return;
    }

    const filesN = Array.from(document.querySelectorAll(".fileCurrent"))
                    .map(i => i.files[0]).filter(Boolean);
    const filesPrev = Array.from(document.querySelectorAll(".filePrevious"))
                    .map(i => i.files[0]).filter(Boolean);

    if (filesN.length === 0 || filesPrev.length === 0){
      alert("กรุณาเลือกไฟล์ Excel อย่างน้อย 1 ไฟล์สำหรับทั้งปี N และปี N-1");
      return;
    }

    try{
      const wbNList = await Promise.all(filesN.map(readWorkbook));
      const wbPrevList = await Promise.all(filesPrev.map(readWorkbook));

      const sumsN = aggregateYear(wbNList, SOCE_TEMPLATE);
      const sumsPrev = aggregateYear(wbPrevList, SOCE_TEMPLATE);

      let html = `
        <div class="note-title">
          ผลลัพธ์งบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน (รวมจากหลายไฟล์)
          <span class="badge">ปี N: ${yearN || "-"}</span>
          <span class="badge">ปี N-1: ${yearPrev || "-"}</span>
          ${auditId ? '<span class="badge">รหัสงาน: '+auditId+'</span>' : ''}
        </div>
        <table>
          <tr>
            <th class="line-label">รายการ</th>
            <th class="year-col">ปี N (รวมทุกไฟล์)</th>
            <th class="year-col">ปี N-1 (รวมทุกไฟล์)</th>
          </tr>
      `;

      const rows = [];

      SOCE_TEMPLATE.lines.forEach(line=>{
        const recN = sumsN[line.line_code] || {sum:"",hasValue:false};
        const recP = sumsPrev[line.line_code] || {sum:"",hasValue:false};

        const rawN = recN.hasValue ? recN.sum : "";
        const rawP = recP.hasValue ? recP.sum : "";

        const valN = formatNumber(rawN);
        const valP = formatNumber(rawP);

        rows.push({
          line_code: line.line_code,
          label: line.raw_label,
          yearN_raw: rawN,
          yearN_display: valN,
          yearPrev_raw: rawP,
          yearPrev_display: valP
        });

        html += `
          <tr>
            <td>${line.raw_label}</td>
            <td style="text-align:right">${valN}</td>
            <td style="text-align:right">${valP}</td>
          </tr>
        `;
      });

      html += `</table>`;
      document.getElementById("soceContainer").innerHTML = html;

      latestSoceData = {
        fs_type: "SOCE",
        audit_id: auditId || null,
        yearN: yearN || null,
        yearPrev: yearPrev || null,
        generated_at: new Date().toISOString(),
        source_files: {
          yearN_files: filesN.map(f=>f.name),
          yearPrev_files: filesPrev.map(f=>f.name)
        },
        rows: rows,
        attachments: attachmentsMeta
      };

      // อัปเดตหัวรายงานอีกครั้ง (เผื่อมีการแก้ชื่อ/ปี)
      updateReportHeader();

    }catch(err){
      console.error(err);
      alert("ประมวลผลล้มเหลว: " + err.message);
    }
  }

  document.getElementById("saveTarget").addEventListener("change", (e)=>{
    document.getElementById("apiUrlContainer").style.display =
      e.target.value === "api" ? "block" : "none";
  });

  function saveResult(){
    if (!latestSoceData){
      alert("ยังไม่มีผลการประมวล โปรดประมวลผลงบ SOCE ก่อน");
      return;
    }
    const target = document.getElementById("saveTarget").value;

    if (target === "local"){
      const key = "fa_soce_reports";
      const current = JSON.parse(localStorage.getItem(key) || "[]");
      current.push(latestSoceData);
      localStorage.setItem(key, JSON.stringify(current));
      alert("บันทึกข้อมูลลงฐานข้อมูลในเครื่อง (localStorage) เรียบร้อยแล้ว");
    }else if (target === "download"){
      const blob = new Blob([JSON.stringify(latestSoceData,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const yearN = latestSoceData.yearN || "N";
      a.href = url;
      a.download = `soce_${yearN}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }else if (target === "api"){
      const apiUrl = document.getElementById("apiUrl").value.trim();
      if (!apiUrl){
        alert("กรุณาระบุ URL ของ API ที่ต้องการส่งข้อมูลไปเก็บ");
        return;
      }
      fetch(apiUrl, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(latestSoceData)
      })
      .then(res=>{
        if(!res.ok) throw new Error("HTTP " + res.status);
        return res.text();
      })
      .then(()=>{
        alert("ส่งข้อมูลไปยัง API เรียบร้อย (โปรดตรวจสอบที่ปลายทาง)");
      })
      .catch(err=>{
        console.error(err);
        alert("ไม่สามารถส่งข้อมูลไปยัง API ได้: " + err.message);
      });
    }
  }
</script>

</body>
</html>
