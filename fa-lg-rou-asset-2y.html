<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>งบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน (2 ปี)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, sans-serif;
      background:#060818;
      color:#f5f7ff;
    }
    header{
      padding:18px 20px;
      background:linear-gradient(120deg,#0d47a1,#42a5f5,#7b1e3c);
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
    }
    h1{margin:0;font-size:26px;font-weight:700;}
    .container{
      padding:20px;
    }
    .upload-box{
      background:#11152b;
      padding:20px;
      border-radius:12px;
      border:1px solid #262b46;
      margin-bottom:20px;
    }
    .upload-box h3{
      margin-top:0;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:20px;
      background:#11152b;
    }
    th,td{
      border:1px solid #262b46;
      padding:8px;
      font-size:14px;
    }
    th{
      background:#0d47a1;
      text-align:center;
    }
    .line-label { width:45%; }
    .year-col { width:25%; text-align:right; }
    .note-title{
      background:#2b3358;
      font-weight:700;
      padding:10px;
      margin-top:25px;
      border-radius:8px;
      border:1px solid #3c456e;
    }
    .btn-primary{
      padding:10px 20px;
      background:#42a5f5;
      color:white;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
    }
    .btn-primary:hover{
      background:#1e88e5;
    }
    .helper-text{
      font-size:12px;
      color:#a3acc7;
      margin-top:6px;
    }
  </style>
</head>

<body>

<header>
  <h1>งบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน (2 ปี)</h1>
</header>

<div class="container">

  <div class="upload-box">
    <h3>นำเข้าไฟล์ Excel กระดาษทำการ (ปีล่าสุด / ปีก่อน)</h3>
    <p>รองรับไฟล์: .xls, .xlsx, .xlsm</p>

    <label>ไฟล์ปีล่าสุด (ปี N):
      <input type="file" id="fileCurrent" accept=".xlsx,.xls,.xlsm" />
    </label>
    <br><br>

    <label>ไฟล์ปีก่อน (ปี N-1):
      <input type="file" id="filePrevious" accept=".xlsx,.xls,.xlsm" />
    </label>

    <p class="helper-text">
      *แนะนำให้ใช้ไฟล์กระดาษทำการที่มีโครงสร้างแถว/คอลัมน์ตามแบบ SOCE ของระบบ
    </p>

    <button class="btn-primary" onclick="processSOCE()">
      ประมวลผลงบ SOCE
    </button>
  </div>

  <div id="soceContainer"></div>

</div>

<!-- โหลด XLSX เพียงครั้งเดียว -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>

<script>
  // =====================================================
  // ① โครงสร้าง SOCE (Mapping แถวในไฟล์ Excel)
  // =====================================================
  const SOCE_TEMPLATE = {
    fs_type : "SOCE",
    // ใช้ชื่อชีตตามกระดาษทำการ ถ้าไม่พบจะ fallback ไปชีตแรก
    sheet_name : "Eqiuty",
    lines : [
      { line_code:"SOCE_001", excel_row: 8, raw_label:"ยอดคงเหลือ ณ วันที่ 30 กันยายน (N-2) ตามที่รายงานเดิม" },
      { line_code:"SOCE_002", excel_row: 9, raw_label:"ผลสะสมจากการแก้ไขข้อผิดพลาดปีก่อน" },
      { line_code:"SOCE_003", excel_row:10, raw_label:"ผลสะสมของการเปลี่ยนแปลงนโยบายการบัญชี" },
      { line_code:"SOCE_004", excel_row:11, raw_label:"ยอดคงเหลือหลังปรับปรุง (N-2)" },
      { line_code:"SOCE_005", excel_row:12, raw_label:"การเปลี่ยนแปลงในสินทรัพย์สุทธิ/ส่วนทุน (N-1)" },
      { line_code:"SOCE_006", excel_row:13, raw_label:"การเปลี่ยนแปลงที่ทำให้ทุนเพิ่ม/ลด" },
      { line_code:"SOCE_007", excel_row:14, raw_label:"รายได้สูง/(ต่ำ) กว่าค่าใช้จ่าย" },
      { line_code:"SOCE_008", excel_row:15, raw_label:"ยอดคงเหลือ ณ สิ้นปี N-1" },

      { line_code:"SOCE_009", excel_row:17, raw_label:"ยอดคงเหลือ (N-1) ตามที่รายงานเดิม" },
      { line_code:"SOCE_010", excel_row:18, raw_label:"ผลสะสมแก้ไขข้อผิดพลาด" },
      { line_code:"SOCE_011", excel_row:19, raw_label:"ผลสะสมเปลี่ยนแปลงนโยบาย" },
      { line_code:"SOCE_012", excel_row:20, raw_label:"ยอดคงเหลือหลังปรับปรุง (N-1)" },
      { line_code:"SOCE_013", excel_row:21, raw_label:"การเปลี่ยนแปลงในสินทรัพย์สุทธิ/ส่วนทุน ปี N" },
      { line_code:"SOCE_014", excel_row:22, raw_label:"การเปลี่ยนแปลงที่ทำให้ทุนเพิ่ม/ลด" },
      { line_code:"SOCE_015", excel_row:23, raw_label:"รายได้สูง/(ต่ำ) กว่าค่าใช้จ่าย" },
      { line_code:"SOCE_016", excel_row:24, raw_label:"ยอดคงเหลือ ณ สิ้นปี N" }
    ]
  };

  // =====================================================
  // ② ฟังก์ชันอ่านไฟล์ Excel → Workbook
  // =====================================================
  async function readWorkbook(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type:"array" });
          resolve(workbook);
        }catch(err){
          reject(err);
        }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  // ดึง Sheet ตามชื่อ ถ้าไม่เจอใช้ชีตแรก
  function getSheetByTemplate(workbook, template){
    if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0){
      return null;
    }
    const targetName = template.sheet_name;
    if (workbook.Sheets[targetName]){
      return workbook.Sheets[targetName];
    }
    // fallback → ชีตแรก
    const firstName = workbook.SheetNames[0];
    return workbook.Sheets[firstName];
  }

  // ดึงค่าจาก cell อย่างปลอดภัย
  function getCellValue(sheet, rowIndex, colIndex){
    if (!sheet) return "";
    const addr = XLSX.utils.encode_cell({ r: rowIndex, c: colIndex });
    const cell = sheet[addr];
    return cell ? cell.v : "";
  }

  // จัดรูปแบบตัวเลข (มีคอมมา, ทศนิยม 2 ตำแหน่ง ถ้าเป็นตัวเลข)
  function formatNumber(value){
    if (value === null || value === undefined || value === "") return "";
    const num = Number(value);
    if (!isNaN(num)){
      return num.toLocaleString("th-TH", {
        minimumFractionDigits:2,
        maximumFractionDigits:2
      });
    }
    return value; // ถ้าไม่ใช่ตัวเลข ให้แสดงตามเดิม
  }

  // =====================================================
  // ③ Main: ประมวลผล SOCE
  // =====================================================
  async function processSOCE() {
    const fileN   = document.getElementById("fileCurrent").files[0];
    const filePrev = document.getElementById("filePrevious").files[0];

    if (!fileN || !filePrev){
      alert("กรุณาเลือกไฟล์ให้ครบทั้ง 2 ปี (ปี N และ ปี N-1)");
      return;
    }

    try{
      const wbN    = await readWorkbook(fileN);
      const wbPrev = await readWorkbook(filePrev);

      const sheetN    = getSheetByTemplate(wbN, SOCE_TEMPLATE);
      const sheetPrev = getSheetByTemplate(wbPrev, SOCE_TEMPLATE);

      if (!sheetN || !sheetPrev){
        alert("ไม่พบชีตข้อมูลในไฟล์อย่างน้อยหนึ่งไฟล์ กรุณาตรวจสอบโครงสร้างไฟล์ Excel");
        return;
      }

      let html = `
        <div class="note-title">ผลลัพธ์งบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน (จากไฟล์ Excel)</div>
        <table>
          <tr>
            <th class="line-label">รายการ</th>
            <th class="year-col">ปี N</th>
            <th class="year-col">ปี N-1</th>
          </tr>
      `;

      SOCE_TEMPLATE.lines.forEach(line => {
        const rowIndex = line.excel_row - 1; // Excel row → index เริ่มที่ 0
        const colIndex = 2; // คอลัมน์ C (0:A,1:B,2:C)

        const valN    = getCellValue(sheetN,    rowIndex, colIndex);
        const valPrev = getCellValue(sheetPrev, rowIndex, colIndex);

        html += `
          <tr>
            <td>${line.raw_label}</td>
            <td style="text-align:right">${formatNumber(valN)}</td>
            <td style="text-align:right">${formatNumber(valPrev)}</td>
          </tr>
        `;
      });

      html += `</table>`;
      document.getElementById("soceContainer").innerHTML = html;

    }catch(err){
      console.error(err);
      alert("ประมวลผลล้มเหลว: " + err.message);
    }
  }
</script>

</body>
</html>
