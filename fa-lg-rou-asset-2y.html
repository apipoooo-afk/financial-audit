<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>งบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน (2 ปี)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, sans-serif;
      background:#060818;
      color:#f5f7ff;
    }
    header{
      padding:18px 20px 10px;
      background:linear-gradient(120deg,#0d47a1,#42a5f5,#7b1e3c);
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
    }
    h1{margin:0;font-size:26px;font-weight:700;}
    .header-sub{
      margin-top:6px;
      font-size:13px;
      opacity:0.85;
    }
    .container{
      padding:20px;
      max-width:1200px;
      margin:0 auto;
    }
    .card{
      background:#11152b;
      padding:20px;
      border-radius:12px;
      border:1px solid #262b46;
      margin-bottom:20px;
    }
    .card h3{
      margin-top:0;
    }
    .upload-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
    }
    label{
      font-size:14px;
    }
    input[type="file"],
    select,
    input[type="text"],
    input[type="number"],
    input[type="url"]{
      margin-top:4px;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #3c456e;
      background:#0b1024;
      color:#f5f7ff;
      font-size:13px;
    }
    select{
      min-width:120px;
    }
    .btn-primary{
      padding:8px 18px;
      background:#42a5f5;
      color:white;
      border:none;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      font-size:14px;
    }
    .btn-primary:hover{
      background:#1e88e5;
    }
    .btn-nav{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.25);
      background:rgba(0,0,0,0.16);
      color:#f5f7ff;
      font-size:12px;
      cursor:pointer;
      margin-right:8px;
    }
    .btn-nav:hover{
      background:rgba(255,255,255,0.12);
    }
    .nav-bar{
      margin-top:10px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:16px;
      background:#11152b;
    }
    th,td{
      border:1px solid #262b46;
      padding:8px;
      font-size:13px;
    }
    th{
      background:#0d47a1;
      text-align:center;
    }
    .line-label { width:45%; }
    .year-col { width:25%; text-align:right; }
    .note-title{
      background:#2b3358;
      font-weight:700;
      padding:10px;
      margin-top:10px;
      border-radius:8px;
      border:1px solid #3c456e;
      font-size:14px;
    }
    .helper-text{
      font-size:12px;
      color:#a3acc7;
      margin-top:6px;
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
    }
    .col{
      flex:1;
      min-width:260px;
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      font-size:11px;
      background:rgba(66,165,245,0.12);
      border:1px solid rgba(66,165,245,0.5);
      color:#bbdefb;
      margin-left:8px;
    }
    #currentDateTime{
      font-size:12px;
      margin-top:4px;
    }
    ul.attach-list{
      list-style:none;
      padding-left:16px;
      font-size:12px;
      margin:8px 0 0;
    }
    ul.attach-list li{
      margin-bottom:2px;
      color:#cfd8dc;
    }
    .badge{
      font-size:10px;
      padding:2px 6px;
      border-radius:999px;
      background:#263238;
      margin-left:6px;
    }
  </style>
</head>

<body>

<header>
  <h1>งบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน (2 ปี)</h1>
  <div class="header-sub">
    ระบบประมวลผลจากกระดาษทำการ + บันทึกข้อมูลลงฐานข้อมูลรายงานการตรวจสอบ
    <span class="pill">SOCE – Digital Working Paper</span>
    <div id="currentDateTime"></div>
  </div>

  <div class="nav-bar">
    <!-- ปรับ href ให้ตรงกับระบบจริงของคุณได้เลย -->
    <button class="btn-nav" onclick="location.href='index.html'">กลับไปหน้าหลักระบบ</button>
    <button class="btn-nav" onclick="location.href='fa-lg-fieldwork.html'">ไปหน้า FA – กระดาษทำการ</button>
    <button class="btn-nav" onclick="location.href='fa-lg-annual-report.html'">ไปหน้ารายงานการตรวจสอบ</button>
  </div>
</header>

<div class="container">

  <!-- เลือกปีงบประมาณ + ไฟล์ Excel SOCE -->
  <div class="card">
    <h3>1. เลือกปีงบประมาณ และนำเข้าไฟล์ Excel กระดาษทำการ SOCE</h3>

    <div class="row">
      <div class="col">
        <label>ปีงบประมาณ (ปี N):</label><br>
        <select id="yearN">
          <!-- ปี 2560–2582 -->
          <option value="">-- เลือกปี --</option>
          <!-- เติมผ่าน JS ก็ได้ แต่ตรง ๆ แบบนี้ชัดเจน -->
          <option>2560</option><option>2561</option><option>2562</option>
          <option>2563</option><option>2564</option><option>2565</option>
          <option>2566</option><option>2567</option><option>2568</option>
          <option>2569</option><option>2570</option><option>2571</option>
          <option>2572</option><option>2573</option><option>2574</option>
          <option>2575</option><option>2576</option><option>2577</option>
          <option>2578</option><option>2579</option><option>2580</option>
          <option>2581</option><option>2582</option>
        </select>
        <div class="helper-text">
          ปี N-1 (อัตโนมัติ): <span id="yearNMinus1">-</span>
        </div>
      </div>

      <div class="col">
        <label>รหัสรายงาน / เลขที่งานตรวจสอบ:</label><br>
        <input type="text" id="auditId" placeholder="เช่น OAG-SSK-FA-2568-001">
      </div>
    </div>

    <div class="note-title" style="margin-top:20px;">ไฟล์กระดาษทำการ Excel ที่ใช้ประมวลผล</div>

    <div class="upload-row" style="margin-top:10px;">
      <div class="col">
        <label>ไฟล์ปีล่าสุด (ปี N):<br>
          <input type="file" id="fileCurrent" accept=".xlsx,.xls,.xlsm" />
        </label>
      </div>

      <div class="col">
        <label>ไฟล์ปีก่อน (ปี N-1):<br>
          <input type="file" id="filePrevious" accept=".xlsx,.xls,.xlsm" />
        </label>
      </div>
    </div>

    <p class="helper-text">
      *ไฟล์ควรมีโครงสร้างแถว/คอลัมน์ตามแบบ SOCE ของระบบ (Sheet: <code>Eqiuty</code>, คอลัมน์ C เป็นยอดเงิน)
    </p>

    <button class="btn-primary" style="margin-top:10px;" onclick="processSOCE()">
      ประมวลผลงบ SOCE
    </button>
  </div>

  <!-- เมนูอัปโหลดไฟล์แนบได้ทุกรูปแบบ -->
  <div class="card">
    <h3>2. แนบเอกสารประกอบการตรวจสอบ (รองรับทุกชนิดไฟล์)</h3>
    <label>ไฟล์แนบเพิ่มเติม (PDF, รูปภาพ, Word, อื่น ๆ):<br>
      <input type="file" id="attachments" multiple />
    </label>
    <p class="helper-text">
      ระบบจะบันทึกข้อมูลเมตาของไฟล์แนบ (ชื่อไฟล์ ประเภท ขนาด) ไปพร้อมกับผลการประมวล SOCE
    </p>
    <ul id="attachmentsList" class="attach-list"></ul>
  </div>

  <!-- แสดงผลการประมวล SOCE -->
  <div class="card">
    <h3>3. ผลการประมวลงบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน</h3>
    <div id="soceContainer">
      <p class="helper-text">
        ยังไม่มีการประมวลผล แสดงผลเมื่อเลือกไฟล์และกดปุ่ม “ประมวลผลงบ SOCE”
      </p>
    </div>
  </div>

  <!-- ระบบบันทึกผลการประมวลลงฐานข้อมูล -->
  <div class="card">
    <h3>4. การบันทึกผลการประมวลลงระบบฐานข้อมูลรายงานการตรวจสอบ</h3>

    <div class="row">
      <div class="col">
        <label>จุดปลายทางการเก็บข้อมูลผลการประมวล:</label><br>
        <select id="saveTarget">
          <option value="local">บันทึกลงฐานข้อมูลในเครื่อง (localStorage)</option>
          <option value="download">ดาวน์โหลดไฟล์ JSON</option>
          <option value="api">ส่งไปยัง API / Database กลาง</option>
        </select>
      </div>
      <div class="col" id="apiUrlContainer" style="display:none;">
        <label>URL จุดปลายทาง API (ตัวอย่าง):</label><br>
        <input type="url" id="apiUrl" placeholder="เช่น https://your-api.gov/soce-report">
      </div>
    </div>

    <p class="helper-text">
      *ระบบนี้เตรียมโครงสร้างการบันทึกข้อมูลให้แล้ว สามารถต่อเชื่อมกับ Database จริงผ่าน API ได้โดยตรง
    </p>

    <button class="btn-primary" style="margin-top:10px;" onclick="saveResult()">
      บันทึกผลการประมวล
    </button>
  </div>

  <!-- ตัวอย่างงบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ -->
  <div class="card">
    <h3>5. ตัวอย่างรูปแบบงบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน</h3>
    <p class="helper-text">
      ตัวอย่างนี้ใช้เพื่ออ้างอิงรูปแบบการจัดวางรายการ และไม่ใช่ข้อมูลจริงจากไฟล์ Excel
    </p>

    <table>
      <tr>
        <th class="line-label">รายการ</th>
        <th class="year-col">ปี N (ตัวอย่าง)</th>
        <th class="year-col">ปี N-1 (ตัวอย่าง)</th>
      </tr>
      <tr>
        <td>ยอดคงเหลือ ณ วันที่ 30 กันยายน (N-2) ตามที่รายงานเดิม</td>
        <td style="text-align:right">1,000,000.00</td>
        <td style="text-align:right">950,000.00</td>
      </tr>
      <tr>
        <td>ผลสะสมจากการแก้ไขข้อผิดพลาดปีก่อน</td>
        <td style="text-align:right">20,000.00</td>
        <td style="text-align:right">10,000.00</td>
      </tr>
      <tr>
        <td>ผลสะสมของการเปลี่ยนแปลงนโยบายการบัญชี</td>
        <td style="text-align:right">5,000.00</td>
        <td style="text-align:right">3,000.00</td>
      </tr>
      <tr>
        <td>ยอดคงเหลือหลังปรับปรุง (N-2)</td>
        <td style="text-align:right">1,025,000.00</td>
        <td style="text-align:right">963,000.00</td>
      </tr>
      <tr>
        <td>รายได้สูง/(ต่ำ) กว่าค่าใช้จ่าย</td>
        <td style="text-align:right">150,000.00</td>
        <td style="text-align:right">120,000.00</td>
      </tr>
      <tr>
        <td><strong>ยอดคงเหลือ ณ สิ้นปี</strong></td>
        <td style="text-align:right"><strong>1,175,000.00</strong></td>
        <td style="text-align:right"><strong>1,083,000.00</strong></td>
      </tr>
    </table>
  </div>

</div>

<!-- โหลด XLSX เพียงครั้งเดียว -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.0/dist/xlsx.full.min.js"></script>

<script>
  // แสดงวันเดือนปีเวลา ปัจจุบัน
  function updateDateTime(){
    const now = new Date();
    const options = {
      year: 'numeric', month: 'long', day: 'numeric',
      hour:'2-digit', minute:'2-digit', second:'2-digit'
    };
    document.getElementById("currentDateTime").textContent =
      "วันที่/เวลา ปัจจุบัน: " + now.toLocaleString("th-TH", options);
  }
  setInterval(updateDateTime, 1000);
  updateDateTime();

  // อัปเดตปี N-1 เมื่อเลือกปี N
  document.getElementById("yearN").addEventListener("change", ()=>{
    const y = parseInt(document.getElementById("yearN").value,10);
    document.getElementById("yearNMinus1").textContent = isNaN(y) ? "-" : (y-1);
  });

  // เก็บเมตาไฟล์แนบ
  let attachmentsMeta = [];

  document.getElementById("attachments").addEventListener("change", (e)=>{
    const files = Array.from(e.target.files);
    attachmentsMeta = files.map(f => ({
      name: f.name,
      size: f.size,
      type: f.type
    }));

    const list = document.getElementById("attachmentsList");
    list.innerHTML = "";
    if (attachmentsMeta.length === 0) return;

    attachmentsMeta.forEach(a=>{
      const li = document.createElement("li");
      li.textContent = a.name + " (" + a.type + ", " + a.size.toLocaleString() + " bytes)";
      list.appendChild(li);
    });
  });

  // โครงสร้าง SOCE (mapping แถวจาก Excel)
  const SOCE_TEMPLATE = {
    fs_type : "SOCE",
    sheet_name : "Eqiuty",
    lines : [
      { line_code:"SOCE_001", excel_row: 8, raw_label:"ยอดคงเหลือ ณ วันที่ 30 กันยายน (N-2) ตามที่รายงานเดิม" },
      { line_code:"SOCE_002", excel_row: 9, raw_label:"ผลสะสมจากการแก้ไขข้อผิดพลาดปีก่อน" },
      { line_code:"SOCE_003", excel_row:10, raw_label:"ผลสะสมของการเปลี่ยนแปลงนโยบายการบัญชี" },
      { line_code:"SOCE_004", excel_row:11, raw_label:"ยอดคงเหลือหลังปรับปรุง (N-2)" },
      { line_code:"SOCE_005", excel_row:12, raw_label:"การเปลี่ยนแปลงในสินทรัพย์สุทธิ/ส่วนทุน (N-1)" },
      { line_code:"SOCE_006", excel_row:13, raw_label:"การเปลี่ยนแปลงที่ทำให้ทุนเพิ่ม/ลด" },
      { line_code:"SOCE_007", excel_row:14, raw_label:"รายได้สูง/(ต่ำ) กว่าค่าใช้จ่าย" },
      { line_code:"SOCE_008", excel_row:15, raw_label:"ยอดคงเหลือ ณ สิ้นปี N-1" },

      { line_code:"SOCE_009", excel_row:17, raw_label:"ยอดคงเหลือ (N-1) ตามที่รายงานเดิม" },
      { line_code:"SOCE_010", excel_row:18, raw_label:"ผลสะสมแก้ไขข้อผิดพลาด" },
      { line_code:"SOCE_011", excel_row:19, raw_label:"ผลสะสมเปลี่ยนแปลงนโยบาย" },
      { line_code:"SOCE_012", excel_row:20, raw_label:"ยอดคงเหลือหลังปรับปรุง (N-1)" },
      { line_code:"SOCE_013", excel_row:21, raw_label:"การเปลี่ยนแปลงในสินทรัพย์สุทธิ/ส่วนทุน ปี N" },
      { line_code:"SOCE_014", excel_row:22, raw_label:"การเปลี่ยนแปลงที่ทำให้ทุนเพิ่ม/ลด" },
      { line_code:"SOCE_015", excel_row:23, raw_label:"รายได้สูง/(ต่ำ) กว่าค่าใช้จ่าย" },
      { line_code:"SOCE_016", excel_row:24, raw_label:"ยอดคงเหลือ ณ สิ้นปี N" }
    ]
  };

  // ฟังก์ชันอ่าน workbook
  async function readWorkbook(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = (e)=>{
        try{
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type:"array" });
          resolve(workbook);
        }catch(err){
          reject(err);
        }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  function getSheetByTemplate(workbook, template){
    if (!workbook || !workbook.SheetNames || workbook.SheetNames.length === 0){
      return null;
    }
    const targetName = template.sheet_name;
    if (workbook.Sheets[targetName]){
      return workbook.Sheets[targetName];
    }
    const firstName = workbook.SheetNames[0];
    return workbook.Sheets[firstName];
  }

  function getCellValue(sheet, rowIndex, colIndex){
    if (!sheet) return "";
    const addr = XLSX.utils.encode_cell({ r: rowIndex, c: colIndex });
    const cell = sheet[addr];
    return cell ? cell.v : "";
  }

  function formatNumber(value){
    if (value === null || value === undefined || value === "") return "";
    const num = Number(value);
    if (!isNaN(num)){
      return num.toLocaleString("th-TH", {
        minimumFractionDigits:2,
        maximumFractionDigits:2
      });
    }
    return value;
  }

  // จะใช้เก็บผลล่าสุด สำหรับบันทึกลงฐานข้อมูล
  let latestSoceData = null;

  async function processSOCE() {
    const fileN   = document.getElementById("fileCurrent").files[0];
    const filePrev = document.getElementById("filePrevious").files[0];
    const yearN = document.getElementById("yearN").value;
    const yearPrev = document.getElementById("yearNMinus1").textContent;
    const auditId = document.getElementById("auditId").value.trim();

    if (!yearN){
      alert("กรุณาเลือกปีงบประมาณ (ปี N)");
      return;
    }
    if (!fileN || !filePrev){
      alert("กรุณาเลือกไฟล์ Excel ให้ครบทั้ง 2 ปี (ปี N และ ปี N-1)");
      return;
    }

    try{
      const wbN    = await readWorkbook(fileN);
      const wbPrev = await readWorkbook(filePrev);

      const sheetN    = getSheetByTemplate(wbN, SOCE_TEMPLATE);
      const sheetPrev = getSheetByTemplate(wbPrev, SOCE_TEMPLATE);

      if (!sheetN || !sheetPrev){
        alert("ไม่พบชีตข้อมูลในไฟล์อย่างน้อยหนึ่งไฟล์ กรุณาตรวจสอบโครงสร้างไฟล์ Excel");
        return;
      }

      const rows = [];
      let html = `
        <div class="note-title">
          ผลลัพธ์งบแสดงการเปลี่ยนแปลงสินทรัพย์สุทธิ/ส่วนทุน จากไฟล์ Excel
          <span class="badge">ปี N: ${yearN || "-"}</span>
          <span class="badge">ปี N-1: ${yearPrev || "-"}</span>
          ${auditId ? '<span class="badge">รหัสงาน: '+auditId+'</span>' : ''}
        </div>
        <table>
          <tr>
            <th class="line-label">รายการ</th>
            <th class="year-col">ปี N</th>
            <th class="year-col">ปี N-1</th>
          </tr>
      `;

      SOCE_TEMPLATE.lines.forEach(line => {
        const rowIndex = line.excel_row - 1;
        const colIndex = 2; // คอลัมน์ C

        const rawN    = getCellValue(sheetN,    rowIndex, colIndex);
        const rawPrev = getCellValue(sheetPrev, rowIndex, colIndex);

        const valN    = formatNumber(rawN);
        const valPrev = formatNumber(rawPrev);

        rows.push({
          line_code: line.line_code,
          label: line.raw_label,
          yearN_raw: rawN,
          yearN_display: valN,
          yearPrev_raw: rawPrev,
          yearPrev_display: valPrev
        });

        html += `
          <tr>
            <td>${line.raw_label}</td>
            <td style="text-align:right">${valN}</td>
            <td style="text-align:right">${valPrev}</td>
          </tr>
        `;
      });

      html += `</table>`;
      document.getElementById("soceContainer").innerHTML = html;

      latestSoceData = {
        fs_type: "SOCE",
        audit_id: auditId || null,
        yearN: yearN || null,
        yearPrev: yearPrev || null,
        generated_at: new Date().toISOString(),
        source_files: {
          yearN_file_name: fileN.name,
          yearPrev_file_name: filePrev.name
        },
        rows: rows,
        attachments: attachmentsMeta
      };

    }catch(err){
      console.error(err);
      alert("ประมวลผลล้มเหลว: " + err.message);
    }
  }

  // toggle ช่อง URL API
  document.getElementById("saveTarget").addEventListener("change", (e)=>{
    document.getElementById("apiUrlContainer").style.display =
      e.target.value === "api" ? "block" : "none";
  });

  function saveResult(){
    if (!latestSoceData){
      alert("ยังไม่มีผลการประมวล โปรดประมวลผลงบ SOCE ก่อน");
      return;
    }

    const target = document.getElementById("saveTarget").value;

    if (target === "local"){
      const key = "fa_soce_reports";
      const current = JSON.parse(localStorage.getItem(key) || "[]");
      current.push(latestSoceData);
      localStorage.setItem(key, JSON.stringify(current));
      alert("บันทึกข้อมูลลงฐานข้อมูลในเครื่อง (localStorage) เรียบร้อยแล้ว");
    }
    else if (target === "download"){
      const blob = new Blob([JSON.stringify(latestSoceData,null,2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const yearN = latestSoceData.yearN || "N";
      a.href = url;
      a.download = `soce_${yearN}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    else if (target === "api"){
      const apiUrl = document.getElementById("apiUrl").value.trim();
      if (!apiUrl){
        alert("กรุณาระบุ URL ของ API ที่ต้องการส่งข้อมูลไปเก็บ");
        return;
      }
      fetch(apiUrl, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(latestSoceData)
      })
      .then(res=>{
        if(!res.ok) throw new Error("HTTP " + res.status);
        return res.text();
      })
      .then(()=>{
        alert("ส่งข้อมูลไปยัง API เรียบร้อย (โปรดตรวจสอบที่ปลายทาง)");
      })
      .catch(err=>{
        console.error(err);
        alert("ไม่สามารถส่งข้อมูลไปยัง API ได้: " + err.message);
      });
    }
  }
</script>

</body>
</html>
