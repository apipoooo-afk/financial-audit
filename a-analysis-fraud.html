<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>FA ‚Äì ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root{
      --bg:#060818;
      --bg-soft:#0b1024;
      --card:#11152b;
      --border:#262b46;
      --primary:#0d47a1;
      --primary-2:#42a5f5;
      --accent:#ffd54f;
      --text:#f5f7ff;
      --muted:#a3acc7;
      --danger:#ef5350;
      --warning:#ffb74d;
      --success:#66bb6a;
      --radius-lg:16px;
      --shadow-soft:0 12px 30px rgba(0,0,0,0.55);
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, sans-serif;
      background:
        radial-gradient(circle at 10% 0%, rgba(123,30,60,0.3) 0, transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(66,165,245,0.22) 0, transparent 55%),
        #060818;
      color:var(--text);
      min-height:100vh;
    }

    header{
      padding:18px 20px 12px;
      background:linear-gradient(120deg,#7b1e3c,#0d47a1,#42a5f5);
      box-shadow:0 4px 18px rgba(0,0,0,0.55);
      border-bottom:1px solid rgba(255,255,255,0.18);
    }
    header h1{
      margin:0;
      font-size:22px;
      font-weight:700;
    }
    header p{
      margin:4px 0 0;
      font-size:13px;
      opacity:0.9;
    }

    .nav-bar{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      font-size:13px;
      align-items:center;
    }
    .nav-bar a{
      color:#ffebee;
      text-decoration:none;
    }
    .nav-bar span{
      opacity:0.8;
    }

    main{
      max-width:1180px;
      margin:20px auto 40px;
      padding:0 12px 30px;
      display:grid;
      grid-template-columns:340px minmax(0,1fr);
      gap:18px;
    }
    @media(max-width:960px){
      main{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:linear-gradient(160deg,rgba(17,21,43,0.97),rgba(11,16,36,0.99));
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      padding:16px 16px 18px;
      box-shadow:var(--shadow-soft);
      margin-bottom:10px;
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
      margin-bottom:8px;
    }
    .card-header h2{
      margin:0;
      font-size:17px;
    }
    .card-header small{
      font-size:12px;
      color:var(--muted);
    }

    label{
      font-size:13px;
      display:block;
      margin-bottom:4px;
    }
    input[type="file"],
    select,
    input[type="text"],
    input[type="number"],
    textarea{
      width:100%;
      padding:7px 9px;
      border-radius:8px;
      border:1px solid var(--border);
      background:#050814;
      color:var(--text);
      font-size:13px;
    }
    textarea{
      min-height:60px;
      resize:vertical;
    }

    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .col{
      flex:1 1 140px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      border:none;
      padding:7px 14px;
      font-size:13px;
      cursor:pointer;
      background:var(--primary);
      color:#fff;
      box-shadow:0 4px 12px rgba(0,0,0,0.45);
      transition:transform 0.08s ease, box-shadow 0.08s ease, background 0.15s;
      text-decoration:none;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 7px 18px rgba(0,0,0,0.6);
      background:var(--primary-2);
    }
    .btn-secondary{
      background:#26324f;
    }
    .btn-secondary:hover{
      background:#39476c;
    }
    .btn-ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,0.18);
      box-shadow:none;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:11px;
      padding:3px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.16);
      background:rgba(0,0,0,0.25);
      color:var(--muted);
    }

    .status{
      font-size:12px;
      margin-top:5px;
    }
    .status.ok{color:var(--success);}
    .status.err{color:var(--danger);}
    .status.warn{color:var(--warning);}

    .subtext{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }

    .tag-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin:4px 0;
    }
    .tag{
      font-size:11px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(0,0,0,0.2);
      color:var(--muted);
    }

    .slot-card{
      border-radius:12px;
      border:1px solid #1f2440;
      padding:8px 8px 8px;
      background:#050814;
      margin-bottom:6px;
    }
    .slot-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }
    .slot-title{
      font-size:12px;
      font-weight:600;
    }
    .slot-buttons{
      display:flex;
      gap:4px;
      flex-wrap:wrap;
    }
    .slot-status{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }

    .checkbox-list{
      list-style:none;
      padding-left:0;
      margin:6px 0 0;
      font-size:12px;
    }
    .checkbox-list li{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:4px;
    }
    .checkbox-list label{
      margin-bottom:0;
      font-size:12px;
    }

    /* RIGHT ‚Äì dashboard */
    .risk-level-badge{
      padding:5px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .risk-low{
      background:rgba(102,187,106,0.14);
      color:#a5d6a7;
      border:1px solid rgba(165,214,167,0.8);
    }
    .risk-medium{
      background:rgba(255,183,77,0.16);
      color:#ffe082;
      border:1px solid rgba(255,224,130,0.85);
    }
    .risk-high{
      background:rgba(239,83,80,0.16);
      color:#ef9a9a;
      border:1px solid rgba(239,154,154,0.85);
    }

    .score-box{
      display:flex;
      align-items:baseline;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }
    .score-number{
      font-size:26px;
      font-weight:800;
      color:#fff;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:6px;
    }
    thead th{
      background:#101530;
      padding:6px 6px;
      border-bottom:1px solid #1f2440;
      text-align:left;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:5px 6px;
      border-top:1px solid #1f2440;
    }
    tbody tr:nth-child(even){
      background:#080c1c;
    }
    tbody tr:nth-child(odd){
      background:#0b1024;
    }

    .issue-high{
      color:var(--danger);
      font-weight:600;
    }
    .issue-medium{
      color:var(--warning);
      font-weight:600;
    }
    .issue-low{
      color:var(--success);
      font-weight:600;
    }

    .muted{
      color:var(--muted);
      font-size:11px;
    }

    .tab-bar{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin:8px 0 6px;
      border-bottom:1px solid #1f2440;
      padding-bottom:4px;
      font-size:12px;
    }
    .tab-btn{
      border:none;
      background:transparent;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
      transition:background 0.12s,color 0.12s;
    }
    .tab-btn.active{
      background:rgba(66,165,245,0.18);
      color:#e3f2fd;
    }

    .panel{
      display:none;
      margin-top:2px;
    }
    .panel.active{
      display:block;
    }

    pre{
      background:#050814;
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px;
      font-size:11px;
      max-height:220px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
    }

    code{
      font-size:11px;
      background:#050814;
      padding:2px 4px;
      border-radius:4px;
      border:1px solid #1f2440;
    }
  </style>
</head>
<body>

<header>
  <h1>FA ‚Äì ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h1>
  <p>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞ Red Flags ‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢</p>
<div class="nav-bar">
  <a href="index.html">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</a>
  <span>‚Ä∫</span>
  <a href="fa-analysis-menu.html">üìå ‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</a>
  <span>‚Ä∫</span>
  <a href="fa-guideline.html" target="_blank" rel="noopener">üìö ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠/‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (FA Guideline)</a>
  <span>‚Ä∫</span>
  <span>üß® ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï</span>
</div>
</header>

<main>

  <!-- LEFT: INPUT & CONFIG -->
  <aside>
    <!-- 1. Context -->
    <section class="card">
      <div class="card-header">
        <div>
          <h2>1. ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï & ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
          <small>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à / ‡∏õ‡∏µ‡∏á‡∏ö / ‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï</small>
        </div>
        <span class="pill">Step 1/3 ¬∑ Context</span>
      </div>

      <div class="row">
        <div class="col">
          <label>‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à (Organization / LG)</label>
          <input type="text" id="orgName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©">
        </div>
        <div class="col">
          <label>‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à (Org Code)</label>
          <input type="text" id="orgCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô 3350401">
        </div>
      </div>

      <div class="row" style="margin-top:6px;">
        <div class="col">
          <label>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏´‡∏•‡∏±‡∏Å (‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á)</label>
          <input type="number" id="mainFiscalYear" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2568">
        </div>
        <div class="col">
          <label>‡∏õ‡∏µ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
          <input type="number" id="compareYear" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2567">
        </div>
      </div>

      <label style="margin-top:8px;">‡πÇ‡∏ü‡∏Å‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏´‡∏•‡∏±‡∏Å</label>
      <select id="fraudFocus">
        <option value="fs">1) ‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏≥/‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</option>
        <option value="asset">2) ‡∏Å‡∏≤‡∏£‡∏¢‡∏±‡∏Å‡∏¢‡∏≠‡∏Å/‡πÄ‡∏ö‡∏µ‡∏¢‡∏î‡∏ö‡∏±‡∏á‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå</option>
        <option value="corruption">3) ‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÄ‡∏ä‡∏¥‡∏á‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢ / ‡∏à‡∏±‡∏î‡∏ã‡∏∑‡πâ‡∏≠‡∏à‡∏±‡∏î‡∏à‡πâ‡∏≤‡∏á (‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ)</option>
        <option value="all">4) ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡∏ó‡∏∏‡∏Å‡∏°‡∏¥‡∏ï‡∏¥ (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
      </select>

      <label style="margin-top:8px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ö‡∏£‡∏¥‡∏ö‡∏ó/‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</label>
      <textarea id="contextNote" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å new e-LASS ‡∏ó‡∏µ‡πà‡∏õ‡∏¥‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏•‡∏∞‡∏á‡∏ö‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏õ‡∏¥‡∏î ‡∏ì 30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô ..."></textarea>
    </section>

    <!-- 2. Data slots (max 10) -->
    <section class="card">
      <div class="card-header">
        <div>
          <h2>2. ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 10 ‡∏ä‡∏∏‡∏î)</h2>
          <small>‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå JSON ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</small>
        </div>
        <span class="pill">Step 2/3 ¬∑ Data</span>
      </div>

      <div class="subtext">
        ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö JSON ‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: <code>[ { fiscal_year, org_code, org_name, account_code, account_name, amount_net, ... } ]</code><br>
        ‡πÄ‡∏ä‡πà‡∏ô export ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö import new e-LASS ‡∏´‡∏£‡∏∑‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
      </div>

      <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center;gap:8px;">
        <span class="pill">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß: <span id="slotCount">0</span> / 10</span>
        <button class="btn-secondary btn" id="btnAddSlot">
          ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Slot)
        </button>
      </div>

      <div id="slotContainer" style="margin-top:8px;"></div>
    </section>

    <!-- 3. Analysis config -->
    <section class="card">
      <div class="card-header">
        <div>
          <h2>3. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï</h2>
          <small>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå / ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</small>
        </div>
        <span class="pill">Step 3/3 ¬∑ Analysis</span>
      </div>

      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡∏∏‡∏î)</label>
      <ul id="analysisSlotList" class="checkbox-list">
        <!-- auto -->
      </ul>

      <label style="margin-top:8px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</label>
      <select id="analysisMethod">
        <option value="rule">Rule-based Red Flags (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
        <option value="ratio">Ratio-based (‡∏°‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏Å)</option>
        <option value="custom">Custom / ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</option>
      </select>

      <label style="margin-top:8px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</label>
      <select id="viewMode">
        <option value="dashboard">1) Dashboard + ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ + Red Flags</option>
        <option value="table">2) ‡πÄ‡∏ô‡πâ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel)</option>
        <option value="json">3) ‡πÄ‡∏ô‡πâ‡∏ô JSON Output (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API)</option>
      </select>

      <label style="margin-top:8px;">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á/‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö (‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Custom)</label>
      <textarea id="customRule" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ï‡∏£‡∏ß‡∏à‡∏Å‡∏£‡∏ì‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô > 30% ‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏¥‡∏ô 50% ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô"></textarea>

      <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
        <button class="btn" id="btnRunAnalysis">
          ‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï
        </button>
        <button class="btn-ghost" id="btnClearResult">
          üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
        </button>
      </div>

      <div id="analysisStatus" class="status warn" style="margin-top:6px;">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡∏∏‡∏î ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î ‚Äú‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‚Äù
      </div>
    </section>

    <!-- Navigation back -->
    <section class="card">
      <div class="row" style="gap:8px;">
        <div class="col">
          <a href="fa-analysis-menu.html" class="btn-secondary btn" style="width:100%;justify-content:center;">
            ‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
          </a>
        </div>
        <div class="col">
          <a href="index.html" class="btn-ghost btn" style="width:100%;justify-content:center;">
            üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô
          </a>
        </div>
      </div>
    </section>
  </aside>

  <!-- RIGHT: DASHBOARD & RESULT -->
  <section>
    <!-- Dashboard -->
    <section class="card">
      <div class="card-header" style="margin-bottom:4px;">
        <div>
          <h2>Fraud Risk Dashboard</h2>
          <div class="muted" id="dashboardContext">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î ‚Äú‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‚Äù
          </div>
        </div>
        <div style="text-align:right;">
          <div id="overallRiskBadge" class="risk-level-badge risk-low">
            üîç ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô
          </div>
          <div class="score-box" style="margin-top:6px;">
            <span>Fraud Risk Score (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</span>
            <span class="score-number" id="overallScore">‚Äì</span>
            <span>/ 100</span>
          </div>
        </div>
      </div>

      <div class="tag-row" id="riskTagRow">
        <span class="tag">Financial Statement Fraud</span>
        <span class="tag">Asset Misappropriation</span>
        <span class="tag">Corruption / Procurement</span>
        <span class="tag">Red Flags ‚Äì Earnings Quality</span>
      </div>
    </section>

    <!-- Detail tabs -->
    <section class="card">
      <div class="card-header" style="margin-bottom:4px;">
        <div>
          <h2>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï</h2>
          <small>‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Red Flags / ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</small>
        </div>
      </div>

      <div class="tab-bar">
        <button class="tab-btn active" data-panel-btn data-target="panel-summary">
          üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        </button>
        <button class="tab-btn" data-panel-btn data-target="panel-flags">
          üö© ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Red Flags
        </button>
        <button class="tab-btn" data-panel-btn data-target="panel-metrics">
          üìà ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        </button>
      </div>

      <!-- Panel 1: Summary per dataset -->
      <div class="panel active" id="panel-summary">
        <p class="muted">
          ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á Risk Score (0‚Äì100) ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Red Flags ‡∏ó‡∏µ‡πà‡∏û‡∏ö
        </p>
        <table>
          <thead>
            <tr>
              <th style="width:28%;">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
              <th style="width:12%;">‡∏õ‡∏µ‡∏á‡∏ö</th>
              <th style="width:16%;">Fraud Risk Score</th>
              <th style="width:14%;">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
              <th style="width:12%;"># Red Flags</th>
              <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏¢‡πà‡∏≠</th>
            </tr>
          </thead>
          <tbody id="summaryTableBody">
            <!-- dynamic -->
          </tbody>
        </table>
      </div>

      <!-- Panel 2: Red Flags -->
      <div class="panel" id="panel-flags">
        <p class="muted">
          ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Red Flags ‡πÅ‡∏ö‡πà‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á (‡∏™‡∏π‡∏á/‡∏Å‡∏•‡∏≤‡∏á/‡∏ï‡πà‡∏≥) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å‡∏ï‡πà‡∏≠‡πÑ‡∏õ
        </p>
        <table>
          <thead>
            <tr>
              <th style="width:24%;">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
              <th style="width:16%;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</th>
              <th style="width:12%;">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
              <th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î / ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</th>
            </tr>
          </thead>
          <tbody id="flagsTableBody">
            <!-- dynamic -->
          </tbody>
        </table>
      </div>

      <!-- Panel 3: Metrics -->
      <div class="panel" id="panel-metrics">
        <p class="muted">
          ‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ Margin ‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ‡∏Ø‡∏•‡∏Ø
          ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ Excel ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥ Infographic ‡∏´‡∏£‡∏∑‡∏≠ Dashboard ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÑ‡∏î‡πâ
        </p>
        <table>
          <thead>
            <tr>
              <th style="width:24%;">‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
              <th style="width:12%;">‡∏õ‡∏µ‡∏á‡∏ö</th>
              <th style="width:14%;">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ (Revenue)</th>
              <th style="width:14%;">‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (Net)</th>
              <th style="width:12%;">Net Margin</th>
              <th style="width:12%;">‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏°</th>
              <th>‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
            </tr>
          </thead>
          <tbody id="metricsTableBody">
            <!-- dynamic -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Raw preview -->
    <section class="card">
      <div class="card-header" style="margin-bottom:4px;">
        <div>
          <h2>‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (Raw Preview)</h2>
          <small>‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏≤‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‚Äù ‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢</small>
        </div>
      </div>
      <pre id="rawPreview">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</pre>
    </section>

    <!-- Export / Save -->
    <section class="card">
      <div class="card-header" style="margin-bottom:4px;">
        <div>
          <h2>Export &amp; ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h2>
          <small>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏ô‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô / ‡∏ó‡∏≥ Infographic / ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á</small>
        </div>
      </div>

      <div style="display:flex;flex-wrap:wrap;gap:8px;">
        <button class="btn-secondary btn" id="btnExportCSV">
          üìÅ Export ‚Äì CSV (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Excel / BI)
        </button>
        <button class="btn-secondary btn" id="btnExportJSON">
          üßæ Export ‚Äì JSON (‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå)
        </button>
        <button class="btn-secondary btn" id="btnPrint">
          üñ® Print / Export PDF (‡∏ú‡πà‡∏≤‡∏ô Browser)
        </button>
        <button class="btn-ghost btn" id="btnSaveAPI">
          üóÑ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á (Hook API)
        </button>
      </div>

      <p class="muted" style="margin-top:8px;">
        ‚Ä¢ CSV ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Excel / Power BI ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡∏∞ Infographic ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°<br>
        ‚Ä¢ Print ‚Üí ‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Print to PDF ‡∏Ç‡∏≠‡∏á Browser ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF ‡πÅ‡∏ô‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô<br>
        ‚Ä¢ JSON ‚Üí ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö AI / n8n / API ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡πà‡∏≠‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å<br>
        ‚Ä¢ ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á‚Äù ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î Hook ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° REST API ‡∏´‡∏£‡∏∑‡∏≠ Database ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á
      </p>
    </section>
  </section>

</main>

<script>
  // ====== STATE ======
  const MAX_SLOTS = 10;
  let slotCounter = 0;
  const slots = []; // {id, nameInput, yearGuess, records, metrics, result}

  let lastAnalysis = null; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export

  // ====== DOM ======
  const slotContainer   = document.getElementById('slotContainer');
  const slotCountEl     = document.getElementById('slotCount');
  const analysisSlotList= document.getElementById('analysisSlotList');
  const btnAddSlot      = document.getElementById('btnAddSlot');

  const btnRunAnalysis  = document.getElementById('btnRunAnalysis');
  const btnClearResult  = document.getElementById('btnClearResult');
  const analysisStatus  = document.getElementById('analysisStatus');

  const orgNameEl       = document.getElementById('orgName');
  const orgCodeEl       = document.getElementById('orgCode');
  const mainYearEl      = document.getElementById('mainFiscalYear');
  const compareYearEl   = document.getElementById('compareYear');
  const fraudFocusEl    = document.getElementById('fraudFocus');
  const analysisMethodEl= document.getElementById('analysisMethod');
  const viewModeEl      = document.getElementById('viewMode');
  const customRuleEl    = document.getElementById('customRule');
  const contextNoteEl   = document.getElementById('contextNote');

  const dashboardContext= document.getElementById('dashboardContext');
  const overallRiskBadge= document.getElementById('overallRiskBadge');
  const overallScoreEl  = document.getElementById('overallScore');
  const riskTagRow      = document.getElementById('riskTagRow');

  const summaryTableBody= document.getElementById('summaryTableBody');
  const flagsTableBody  = document.getElementById('flagsTableBody');
  const metricsTableBody= document.getElementById('metricsTableBody');
  const rawPreviewEl    = document.getElementById('rawPreview');

  const btnExportCSV    = document.getElementById('btnExportCSV');
  const btnExportJSON   = document.getElementById('btnExportJSON');
  const btnPrint        = document.getElementById('btnPrint');
  const btnSaveAPI      = document.getElementById('btnSaveAPI');

  const tabButtons      = document.querySelectorAll('[data-panel-btn]');
  const panels = {
    'panel-summary': document.getElementById('panel-summary'),
    'panel-flags':   document.getElementById('panel-flags'),
    'panel-metrics': document.getElementById('panel-metrics')
  };

  // ====== TAB SWITCH ======
  tabButtons.forEach(btn=>{
    btn.addEventListener('click',()=>{
      const target = btn.dataset.target;
      tabButtons.forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      Object.keys(panels).forEach(k=>{
        panels[k].classList.toggle('active', k===target);
      });
    });
  });

  // ====== SLOT MANAGEMENT ======
  btnAddSlot.addEventListener('click', ()=>{
    if(slots.length >= MAX_SLOTS){
      alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö 10 ‡∏ä‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß');
      return;
    }
    addSlot();
  });

  function addSlot(){
    slotCounter++;
    const id = 'slot_'+slotCounter;

    const wrapper = document.createElement('div');
    wrapper.className = 'slot-card';
    wrapper.dataset.slotId = id;

    const header = document.createElement('div');
    header.className = 'slot-header';

    const title = document.createElement('div');
    title.className = 'slot-title';
    title.textContent = `‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà ${slotCounter}`;

    const btns = document.createElement('div');
    btns.className = 'slot-buttons';

    const btnPreview = document.createElement('button');
    btnPreview.type = 'button';
    btnPreview.className = 'btn-ghost';
    btnPreview.style.fontSize = '11px';
    btnPreview.textContent = 'üîç ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á';

    const btnDelete = document.createElement('button');
    btnDelete.type = 'button';
    btnDelete.className = 'btn-ghost';
    btnDelete.style.fontSize = '11px';
    btnDelete.textContent = 'üóë ‡∏•‡∏ö';

    btns.appendChild(btnPreview);
    btns.appendChild(btnDelete);

    header.appendChild(title);
    header.appendChild(btns);

    const nameLabel = document.createElement('label');
    nameLabel.textContent = '‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
    nameLabel.style.marginBottom = '2px';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.placeholder = '‡πÄ‡∏ä‡πà‡∏ô new e-LASS ‡∏õ‡∏µ 2568 (‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô)';
    nameInput.value = `Dataset ${slotCounter}`;

    const fileLabel = document.createElement('label');
    fileLabel.textContent = '‡πÑ‡∏ü‡∏•‡πå JSON ‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ';
    fileLabel.style.marginTop = '6px';
    fileLabel.style.marginBottom = '2px';

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.accept = '.json';

    const status = document.createElement('div');
    status.className = 'slot-status';
    status.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå';

    wrapper.appendChild(header);
    wrapper.appendChild(nameLabel);
    wrapper.appendChild(nameInput);
    wrapper.appendChild(fileLabel);
    wrapper.appendChild(fileInput);
    wrapper.appendChild(status);

    slotContainer.appendChild(wrapper);

    const slotObj = {
      id,
      dom:wrapper,
      nameInput,
      fileInput,
      statusEl:status,
      yearGuess:null,
      records:null,
      metrics:null,
      result:null
    };
    slots.push(slotObj);
    refreshSlotCount();
    refreshAnalysisSlotList();

    fileInput.addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(!file){
        slotObj.records = null;
        slotObj.metrics = null;
        slotObj.statusEl.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
        return;
      }
      readSlotFile(slotObj, file);
    });

    btnPreview.addEventListener('click', ()=>{
      previewSlot(slotObj);
    });

    btnDelete.addEventListener('click', ()=>{
      if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà')) return;
      const idx = slots.findIndex(s=>s.id===id);
      if(idx>=0){
        slots.splice(idx,1);
      }
      wrapper.remove();
      refreshSlotCount();
      refreshAnalysisSlotList();
    });
  }

  function refreshSlotCount(){
    slotCountEl.textContent = String(slots.length);
  }

  function refreshAnalysisSlotList(){
    analysisSlotList.innerHTML = '';
    if(!slots.length){
      const li = document.createElement('li');
      li.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô';
      analysisSlotList.appendChild(li);
      return;
    }

    slots.forEach(s=>{
      const li = document.createElement('li');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.value = s.id;
      cb.id = 'chk_'+s.id;

      const lb = document.createElement('label');
      lb.setAttribute('for', cb.id);
      const nm = s.nameInput.value || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
      const yr = s.yearGuess ? ` ¬∑ ‡∏õ‡∏µ‡∏á‡∏ö: ${s.yearGuess}` : '';
      lb.textContent = nm + yr;

      li.appendChild(cb);
      li.appendChild(lb);
      analysisSlotList.appendChild(li);
    });
  }

  function readSlotFile(slot, file){
    const reader = new FileReader();
    slot.statusEl.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå...';
    reader.onload = (evt)=>{
      try{
        const text = evt.target.result;
        const data = JSON.parse(text);
        if(!Array.isArray(data)){
          throw new Error('JSON ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô array ‡∏Ç‡∏≠‡∏á records');
        }
        slot.records = data;
        slot.metrics = computeMetrics(data);
        slot.yearGuess = guessYearFromRecords(data);

        const recCount = data.length;
        const yr = slot.yearGuess ? `‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${slot.yearGuess}` : '‡∏õ‡∏µ‡∏á‡∏ö‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô';
        slot.statusEl.textContent = `‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${recCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ¬∑ ${yr}`;
        slot.statusEl.className = 'slot-status';

        refreshAnalysisSlotList();
      }catch(err){
        console.error(err);
        slot.records = null;
        slot.metrics = null;
        slot.statusEl.textContent = '‡∏≠‡πà‡∏≤‡∏ô JSON ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå';
        slot.statusEl.className = 'slot-status';
      }
    };
    reader.onerror = ()=>{
      slot.statusEl.textContent = '‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    };
    reader.readAsText(file, 'utf-8');
  }

  function previewSlot(slot){
    if(!slot.records || !Array.isArray(slot.records)){
      rawPreviewEl.textContent = '‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
      return;
    }
    const nm = slot.nameInput.value || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
    const sample = slot.records.slice(0, 10);
    rawPreviewEl.textContent =
      `‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${nm}\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 10 records ‡πÅ‡∏£‡∏Å:\n\n` +
      JSON.stringify(sample, null, 2);
  }

  function guessYearFromRecords(records){
    for(const r of records){
      if(r.fiscal_year) return r.fiscal_year;
      if(r.year) return r.year;
    }
    return null;
  }

  // ====== METRICS & FRAUD LOGIC ======
  function computeMetrics(records){
    let revenue = 0;
    let expense = 0;
    let ar = 0;
    let inventory = 0;
    let cash = 0;
    let liabilities = 0;
    let equity = 0;
    let nonRecurring = 0;

    records.forEach(r=>{
      const code = String(r.account_code || '');
      const name = String(r.account_name || '');
      const amtRaw = r.amount_net ?? r.balance ?? 0;
      const amt = Number(amtRaw) || 0;

      const lowerName = name.toLowerCase();

      // Revenue
      if(code.startsWith('4') || lowerName.includes('‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ') || lowerName.includes('income')){
        revenue += amt;
      }

      // Expenses
      if(code.startsWith('5') || code.startsWith('6') ||
         lowerName.includes('‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢') || lowerName.includes('expense')){
        expense += Math.abs(amt);
      }

      // Receivables
      if(lowerName.includes('‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ') || lowerName.includes('receiv')){
        ar += amt;
      }

      // Inventory
      if(lowerName.includes('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠') || lowerName.includes('inventory')){
        inventory += amt;
      }

      // Cash / bank
      if(lowerName.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') || lowerName.includes('‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å') || lowerName.includes('cash') || lowerName.includes('bank')){
        cash += amt;
      }

      // Liabilities
      if(code.startsWith('2') || lowerName.includes('‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô') || lowerName.includes('liabil')){
        liabilities += amt;
      }

      // Equity / net asset
      if(code.startsWith('3') || lowerName.includes('‡∏ó‡∏∏‡∏ô') || lowerName.includes('‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏∏‡∏ó‡∏ò‡∏¥') ||
         lowerName.includes('equity') || lowerName.includes('net asset')){
        equity += amt;
      }

      // Non-recurring
      if(lowerName.includes('‡∏û‡∏¥‡πÄ‡∏®‡∏©') || lowerName.includes('‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß') ||
         lowerName.includes('extraordinary') || lowerName.includes('one-off')){
        nonRecurring += amt;
      }
    });

    const netProfit = revenue - expense;
    const margin = revenue ? netProfit / revenue : 0;

    return {
      revenue,
      expense,
      netProfit,
      margin,
      ar,
      inventory,
      cash,
      liabilities,
      equity,
      nonRecurring
    };
  }

  function analyzeSlotFraud(slot, method){
    const m = slot.metrics || computeMetrics(slot.records || []);
    const flags = [];
    let riskScore = 20; // ‡∏ê‡∏≤‡∏ô (0‚Äì100)

    function addFlag(level, category, title, detail){
      flags.push({level, category, title, detail});
      if(level === 'HIGH') riskScore += 25;
      else if(level === 'MEDIUM') riskScore += 15;
      else riskScore += 8;
    }

    const rev = m.revenue;
    const exp = m.expense;
    const net = m.netProfit;
    const margin = m.margin;
    const ar = m.ar;
    const inv = m.inventory;
    const cash = m.cash;
    const liab = m.liabilities;
    const eq = m.equity;
    const nonRec = m.nonRecurring;

    if(method === 'ratio' || method === 'rule' || method === 'custom'){
      // Earnings quality
      if(rev > 0 && Math.abs(margin) > 0.35){
        addFlag('MEDIUM','Earnings Quality',
          '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥‡∏™‡∏π‡∏á/‡∏Ç‡∏≤‡∏î‡∏ó‡∏∏‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
          `Net margin ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${(margin*100).toFixed(1)}% ‡∏≠‡∏≤‡∏à‡∏ö‡πà‡∏á‡∏ä‡∏µ‡πâ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ/‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥`);
      }

      // Revenue vs AR
      if(rev > 0 && ar > rev * 1.5){
        addFlag('HIGH','Receivables',
          '‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
          `‡∏¢‡∏≠‡∏î‡∏•‡∏π‡∏Å‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏ß‡∏° ~ ${formatNumber(ar)} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ~ ${formatNumber(rev)} ‡∏ö‡∏≤‡∏ó (AR > 150% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ)`);
      }

      // Inventory vs revenue
      if(rev > 0 && inv > rev){
        addFlag('MEDIUM','Inventory',
          '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ',
          `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ~ ${formatNumber(inv)} ‡∏ö‡∏≤‡∏ó ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ ~ ${formatNumber(rev)} ‡∏ö‡∏≤‡∏ó`);
      }

      // Revenue = 0 but expenses positive
      if(rev === 0 && exp > 0){
        addFlag('MEDIUM','PL Structure',
          '‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ',
          '‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏á‡∏ö‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥');
      }

      // Positive profit but low cash
      if(net > 0 && cash < net * 0.2){
        addFlag('MEDIUM','Cash vs Profit',
          '‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏π‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏ï‡πà‡∏≥',
          `‡∏Å‡∏≥‡πÑ‡∏£‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ~ ${formatNumber(net)} ‡∏ö‡∏≤‡∏ó ‡πÅ‡∏ï‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î ~ ${formatNumber(cash)} ‡∏ö‡∏≤‡∏ó (‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤ 20% ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≥‡πÑ‡∏£) ‡∏≠‡∏≤‡∏à‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≥‡πÑ‡∏£‡πÄ‡∏ä‡∏¥‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ`);
      }

      // Debt vs equity
      if(eq > 0 && liab > eq * 2){
        addFlag('LOW','Leverage',
          '‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏™‡∏π‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏ô',
          `‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏£‡∏ß‡∏° ~ ${formatNumber(liab)} ‡∏ö‡∏≤‡∏ó ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏ô/‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ ~ ${formatNumber(eq)} ‡∏ö‡∏≤‡∏ó (D/E > 2 ‡πÄ‡∏ó‡πà‡∏≤)`);
      }

      // Non-recurring large
      if(rev > 0 && Math.abs(nonRec) > Math.abs(rev * 0.3)){
        addFlag('MEDIUM','Non-recurring',
          '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡πÄ‡∏®‡∏©/‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏°‡∏µ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏π‡∏á',
          `‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Non-recurring ~ ${formatNumber(nonRec)} ‡∏ö‡∏≤‡∏ó (> 30% ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ) ‡∏Ñ‡∏ß‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏á‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î`);
      }
    }

    // Clamp
    if(riskScore < 0) riskScore = 0;
    if(riskScore > 100) riskScore = 100;

    let levelText = '‡∏ï‡πà‡∏≥';
    let levelClass = 'risk-low';
    if(riskScore >= 61){
      levelText = '‡∏™‡∏π‡∏á';
      levelClass = 'risk-high';
    }else if(riskScore >= 31){
      levelText = '‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
      levelClass = 'risk-medium';
    }

    return {
      metrics:m,
      riskScore,
      levelText,
      levelClass,
      flags
    };
  }

  // ====== RUN ANALYSIS ======
  btnRunAnalysis.addEventListener('click', ()=>{
    runAnalysis();
  });

  btnClearResult.addEventListener('click', ()=>{
    clearAnalysis();
  });

  function runAnalysis(){
    const selectedIds = Array.from(analysisSlotList.querySelectorAll('input[type="checkbox"]:checked'))
      .map(cb=>cb.value);
    if(!selectedIds.length){
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡∏∏‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå');
      return;
    }

    const method = analysisMethodEl.value;
    const viewMode = viewModeEl.value;

    const results = [];
    selectedIds.forEach(id=>{
      const slot = slots.find(s=>s.id===id);
      if(!slot || !slot.records || !slot.records.length){
        return;
      }
      slot.metrics = slot.metrics || computeMetrics(slot.records);
      const res = analyzeSlotFraud(slot, method);
      slot.result = res;
      results.push({slot, res});
    });

    if(!results.length){
      alert('‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏î‡πâ ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå JSON');
      return;
    }

    // Summary
    updateDashboard(results);
    updateTables(results, viewMode);

    lastAnalysis = {
      timestamp: new Date().toISOString(),
      orgName: orgNameEl.value,
      orgCode: orgCodeEl.value,
      mainFiscalYear: mainYearEl.value,
      compareYear: compareYearEl.value,
      fraudFocus: fraudFocusEl.value,
      analysisMethod: method,
      viewMode,
      customRule: customRuleEl.value,
      contextNote: contextNoteEl.value,
      results: results.map(r=>serializeResult(r))
    };

    analysisStatus.textContent = '‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äì ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß';
    analysisStatus.className = 'status ok';
  }

  function serializeResult(r){
    return {
      slotName: r.slot.nameInput.value,
      year: r.slot.yearGuess,
      metrics: r.res.metrics,
      riskScore: r.res.riskScore,
      levelText: r.res.levelText,
      flags: r.res.flags
    };
  }

  function clearAnalysis(){
    overallScoreEl.textContent = '‚Äì';
    overallRiskBadge.textContent = 'üîç ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô';
    overallRiskBadge.className = 'risk-level-badge risk-low';
    dashboardContext.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏î ‚Äú‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‚Äù';
    summaryTableBody.innerHTML = '';
    flagsTableBody.innerHTML = '';
    metricsTableBody.innerHTML = '';
    rawPreviewEl.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á';
    lastAnalysis = null;
    analysisStatus.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ä‡∏∏‡∏î ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏Å‡∏î ‚Äú‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‚Äù';
    analysisStatus.className = 'status warn';
  }

  function updateDashboard(results){
    const scores = results.map(r=>r.res.riskScore);
    const avgScore = scores.reduce((a,b)=>a+b,0)/scores.length;
    overallScoreEl.textContent = avgScore.toFixed(0);

    let badgeClass = 'risk-low';
    let text = '';
    if(avgScore >= 61){
      badgeClass = 'risk-high';
      text = '‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°: ‡∏™‡∏π‡∏á';
    }else if(avgScore >= 31){
      badgeClass = 'risk-medium';
      text = '‚ö† ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°: ‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
    }else{
      badgeClass = 'risk-low';
      text = '‚úÖ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏∏‡∏à‡∏£‡∏¥‡∏ï‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°: ‡∏ï‡πà‡∏≥';
    }
    overallRiskBadge.className = 'risk-level-badge '+badgeClass;
    overallRiskBadge.textContent = text;

    const org = orgNameEl.value || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à)';
    const method = analysisMethodEl.value;
    const methodText =
      method === 'rule'  ? 'Rule-based Red Flags' :
      method === 'ratio' ? 'Ratio-based' :
                           'Custom / ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';

    dashboardContext.textContent =
      `${org} ¬∑ ‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ${results.length} ‡∏ä‡∏∏‡∏î ¬∑ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå: ${methodText}`;

    // Highlight tags loosely‡∏ï‡∏≤‡∏°‡πÇ‡∏ü‡∏Å‡∏±‡∏™
    Array.from(riskTagRow.children).forEach(tag=>{
      tag.style.borderColor = 'rgba(255,255,255,0.18)';
      tag.style.background = 'rgba(0,0,0,0.2)';
    });

    if(fraudFocusEl.value === 'fs' || fraudFocusEl.value === 'all'){
      riskTagRow.children[0].style.borderColor = '#ffd54f';
      riskTagRow.children[0].style.background = 'rgba(255,213,79,0.08)';
    }
    if(fraudFocusEl.value === 'asset' || fraudFocusEl.value === 'all'){
      riskTagRow.children[1].style.borderColor = '#66bb6a';
      riskTagRow.children[1].style.background = 'rgba(102,187,106,0.1)';
    }
    if(fraudFocusEl.value === 'corruption' || fraudFocusEl.value === 'all'){
      riskTagRow.children[2].style.borderColor = '#ef5350';
      riskTagRow.children[2].style.background = 'rgba(239,83,80,0.12)';
    }
  }

  function updateTables(results, viewMode){
    summaryTableBody.innerHTML = '';
    flagsTableBody.innerHTML = '';
    metricsTableBody.innerHTML = '';

    results.forEach(r=>{
      const s = r.slot;
      const res = r.res;
      const m = res.metrics;

      // Summary row
      const tr1 = document.createElement('tr');
      tr1.innerHTML = `
        <td>${escapeHtml(s.nameInput.value || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)')}</td>
        <td>${escapeHtml(s.yearGuess || '-')}</td>
        <td>${res.riskScore.toFixed(0)}</td>
        <td>${escapeHtml(res.levelText)}</td>
        <td>${res.flags.length}</td>
        <td>${res.flags.length ? escapeHtml(res.flags[0].title) : '‡πÑ‡∏°‡πà‡∏û‡∏ö Red Flags ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏ô‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô'}</td>
      `;
      summaryTableBody.appendChild(tr1);

      // Flags rows
      res.flags.forEach(f=>{
        const tr2 = document.createElement('tr');
        let levelClass = 'issue-low';
        if(f.level === 'HIGH') levelClass = 'issue-high';
        else if(f.level === 'MEDIUM') levelClass = 'issue-medium';

        tr2.innerHTML = `
          <td>${escapeHtml(s.nameInput.value || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)')}</td>
          <td>${escapeHtml(f.category || '-')}</td>
          <td class="${levelClass}">${escapeHtml(f.level)}</td>
          <td>${escapeHtml(f.title)} ‚Äì ${escapeHtml(f.detail)}</td>
        `;
        flagsTableBody.appendChild(tr2);
      });

      // Metrics row
      const tr3 = document.createElement('tr');
      const marginPercent = m.revenue ? (m.margin*100).toFixed(1)+'%' : '-';
      tr3.innerHTML = `
        <td>${escapeHtml(s.nameInput.value || '(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)')}</td>
        <td>${escapeHtml(s.yearGuess || '-')}</td>
        <td>${formatNumber(m.revenue)}</td>
        <td>${formatNumber(m.netProfit)}</td>
        <td>${marginPercent}</td>
        <td>${formatNumber(m.ar)}</td>
        <td>${formatNumber(m.inventory)}</td>
      `;
      metricsTableBody.appendChild(tr3);
    });

    // View mode (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô ‡πÅ‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏ô‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°)
    // dashboard / table / json ‚Äì ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á config logic ‡∏ù‡∏±‡πà‡∏á backend/export
  }

  // ====== EXPORT / SAVE ======
  btnExportCSV.addEventListener('click', ()=>{
    if(!lastAnalysis){
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export');
      return;
    }
    const rows = [];
    rows.push([
      'slotName','year','riskScore','riskLevel',
      'revenue','netProfit','margin','ar','inventory','cash','liabilities','equity',
      'flagsCount'
    ].join(','));

    lastAnalysis.results.forEach(r=>{
      const m = r.metrics;
      const margin = m.revenue ? (m.netProfit/m.revenue) : 0;
      rows.push([
        csvEscape(r.slotName),
        csvEscape(r.year || ''),
        r.riskScore.toFixed(0),
        csvEscape(r.levelText),
        m.revenue,
        m.netProfit,
        margin.toFixed(4),
        m.ar,
        m.inventory,
        m.cash,
        m.liabilities,
        m.equity,
        r.flags.length
      ].join(','));
    });

    const csv = rows.join('\n');
    downloadFile(csv, 'text/csv;charset=utf-8;', 'fa-fraud-analysis.csv');
  });

  btnExportJSON.addEventListener('click', ()=>{
    if(!lastAnalysis){
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export');
      return;
    }
    const json = JSON.stringify(lastAnalysis, null, 2);
    downloadFile(json, 'application/json;charset=utf-8;', 'fa-fraud-analysis.json');
  });

  btnPrint.addEventListener('click', ()=>{
    window.print();
  });

  btnSaveAPI.addEventListener('click', ()=>{
    if(!lastAnalysis){
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
      return;
    }
    console.log('FA Fraud Analysis ‚Äì payload for API:', lastAnalysis);
    alert('‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API: ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏µ‡∏¢‡∏á log ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô console\n‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ REST API / n8n / Database ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ');
  });

  function downloadFile(content, mimeType, fileName){
    const blob = new Blob([content], {type:mimeType});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function csvEscape(val){
    const s = String(val ?? '');
    if(s.includes(',') || s.includes('"') || s.includes('\n')){
      return `"${s.replace(/"/g,'""')}"`;
    }
    return s;
  }

  // ====== UTILS ======
  function formatNumber(num){
    const n = Number(num) || 0;
    return n.toLocaleString('th-TH', {maximumFractionDigits:2});
  }

  function escapeHtml(str){
    return String(str)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#039;');
  }
</script>

</body>
</html>
