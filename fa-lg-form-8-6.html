<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>FA ‚Äì LG Fieldwork | ‡∏≠‡∏õ‡∏ó. 8.6 ‚Äì ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#0d47a1;
      --primary-2:#42a5f5;
      --accent:#ffd54f;
      --bg:#060818;
      --bg-soft:#0b1024;
      --card:#11152b;
      --text:#f5f7ff;
      --muted:#a3acc7;
      --border:#262b46;
      --maroon:#7b1e3c;
      --pink:#f48fb1;
      --success:#66bb6a;
      --danger:#ef5350;
      --shadow-soft:0 10px 30px rgba(0,0,0,0.55);
    }
    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:"Segoe UI", Tahoma, sans-serif;
      background:
        radial-gradient(circle at 10% 0%, rgba(123,30,60,0.35) 0, transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(66,165,245,0.35) 0, transparent 55%),
        var(--bg);
      color:var(--text);
    }

    header{
      padding:14px 18px;
      border-bottom:1px solid rgba(255,255,255,0.1);
      background:linear-gradient(120deg,#7b1e3c,#0d47a1,#42a5f5);
      box-shadow:var(--shadow-soft);
      position:sticky;
      top:0;
      z-index:20;
    }
    .header-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .header-title{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .header-title h1{
      margin:0;
      font-size:20px;
      font-weight:700;
    }
    .header-title span{
      font-size:12px;
      opacity:0.9;
    }

    .header-actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:6px 14px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      letter-spacing:0.02em;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(120deg,var(--primary),var(--primary-2));
      color:#fff;
    }
    .btn-ghost{
      background:rgba(0,0,0,0.25);
      color:#fff;
      border:1px solid rgba(255,255,255,0.12);
    }
    .btn-danger{
      background:var(--danger);
      color:#fff;
    }
    .btn-sm{
      padding:4px 10px;
      font-size:11px;
    }
    .btn-icon{
      width:28px;
      height:28px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.16);
      cursor:pointer;
    }

    .header-bottom{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:12px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.16);
      font-size:11px;
      color:#f5f7ff;
    }
    .badge span{
      opacity:0.85;
    }

    main{
      padding:16px;
      max-width:1300px;
      margin:0 auto;
    }

    .layout{
      display:grid;
      grid-template-columns: minmax(0,2.1fr) minmax(280px,0.9fr);
      gap:16px;
      align-items:flex-start;
    }
    @media(max-width:960px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .card{
      background:rgba(7,11,32,0.94);
      border-radius:18px;
      border:1px solid var(--border);
      padding:14px 14px 12px;
      box-shadow:0 14px 40px rgba(0,0,0,0.65);
      backdrop-filter:blur(14px);
    }
    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
    }
    .card-title{
      font-size:14px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .card-sub{
      font-size:11px;
      color:var(--muted);
      margin-top:2px;
    }

    label{
      font-size:11px;
      color:var(--muted);
      display:block;
      margin-bottom:4px;
    }
    select,input[type="text"],input[type="date"],textarea{
      width:100%;
      border-radius:10px;
      border:1px solid var(--border);
      background:rgba(9,13,36,0.96);
      color:var(--text);
      font-size:12px;
      padding:6px 9px;
      font-family:inherit;
    }
    textarea{
      min-height:90px;
      resize:vertical;
    }
    input::placeholder,textarea::placeholder{
      color:rgba(163,172,199,0.8);
    }

    .form-row{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:10px;
      margin-bottom:8px;
    }
    @media(max-width:720px){
      .form-row{
        grid-template-columns:1fr 1fr;
      }
    }

    .pill{
      border-radius:999px;
      padding:2px 8px;
      font-size:10px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(255,255,255,0.03);
      color:var(--muted);
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    th,td{
      border-bottom:1px solid rgba(255,255,255,0.08);
      padding:4px 6px;
      text-align:left;
    }
    th{
      background:rgba(255,255,255,0.04);
      font-weight:600;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody tr:nth-child(even){
      background:rgba(255,255,255,0.01);
    }
    tbody tr:hover{
      background:rgba(66,165,245,0.08);
    }
    .text-right{text-align:right;}
    .text-center{text-align:center;}

    .attachments{
      margin-top:4px;
      font-size:11px;
    }
    .attach-list{
      margin-top:2px;
      font-size:10px;
      color:var(--muted);
    }

    .tag{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      border:1px solid rgba(244,143,177,0.7);
      background:rgba(244,143,177,0.12);
      font-size:10px;
      color:#f48fb1;
    }

    .side-section{
      margin-bottom:12px;
    }
    .side-section h3{
      margin:0 0 6px 0;
      font-size:13px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .side-section small{
      font-size:11px;
      color:var(--muted);
    }

    .preview-box{
      background:rgba(5,9,28,0.96);
      border-radius:12px;
      border:1px solid var(--border);
      padding:8px;
      max-height:180px;
      overflow:auto;
      font-family:"Cascadia Code","Consolas",monospace;
      font-size:10px;
      white-space:pre-wrap;
    }

    .qa-list{
      list-style:none;
      margin:4px 0 0;
      padding:0;
      font-size:11px;
    }
    .qa-item{
      display:flex;
      align-items:flex-start;
      gap:6px;
      padding:3px 0;
    }
    .qa-item span.icon{
      font-size:12px;
      margin-top:1px;
    }

    .checklist{
      list-style:none;
      padding:0;
      margin:6px 0 0;
      font-size:11px;
    }
    .checklist li{
      display:flex;
      align-items:flex-start;
      gap:6px;
      padding:3px 0;
    }
    .checklist input[type="checkbox"]{
      margin-top:2px;
      cursor:pointer;
    }

    .route-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:4px;
      font-size:11px;
    }
    .route-item{
      display:flex;
      align-items:center;
      gap:6px;
      padding:4px 6px;
      border-radius:8px;
      background:rgba(5,9,28,0.96);
      border:1px solid var(--border);
    }
    .route-item input[type="checkbox"]{
      cursor:pointer;
    }
    .route-console{
      margin-top:6px;
      font-size:10px;
      background:rgba(0,0,0,0.7);
      border-radius:8px;
      padding:6px;
      border:1px dashed rgba(255,255,255,0.15);
      max-height:80px;
      overflow:auto;
      font-family:"Cascadia Code","Consolas",monospace;
      white-space:pre-wrap;
    }

    .footer-meta{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:720px){
      .footer-meta{
        grid-template-columns:1fr;
      }
    }
    .signature-box{
      margin-top:10px;
      padding-top:22px;
      border-top:1px dashed rgba(255,255,255,0.35);
      text-align:center;
      font-size:11px;
      color:var(--muted);
    }

    .export-row{
      margin-top:8px;
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.75);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:50;
    }
    .modal{
      background:#0b1024;
      border-radius:18px;
      padding:16px 16px 14px;
      max-width:420px;
      width:100%;
      border:1px solid var(--border);
      box-shadow:var(--shadow-soft);
    }
    .modal h2{
      margin:0 0 6px 0;
      font-size:15px;
    }
    .modal p{
      margin:0 0 10px 0;
      font-size:12px;
      color:var(--muted);
    }
    .modal-actions{
      margin-top:10px;
      display:flex;
      justify-content:flex-end;
      gap:6px;
      flex-wrap:wrap;
    }

    /* Print tweaks */
    @media print{
      header, .btn, .btn-icon, .route-console{
        display:none !important;
      }
      body{
        background:#fff;
        color:#000;
      }
      .card{
        box-shadow:none;
        border-color:#ccc;
      }
      main{
        padding:8px;
      }
      .signature-box{
        margin-top:30px;
        border-color:#000;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="header-top">
    <div class="header-title">
      <h1>‡∏≠‡∏õ‡∏ó. 8.6 ‚Äì ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (Fieldwork)</h1>
      <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏≠‡∏õ‡∏ó. | Financial Audit ‚Äì Local Government</span>
    </div>
    <div class="header-actions">
      <button class="btn btn-ghost" onclick="window.location.href='fa-lg-fieldwork.html'">
        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö Fieldwork
      </button>
      <button class="btn btn-ghost" id="btnSaveDraft">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á</button>
      <button class="btn btn-danger" id="btnResetForm">üßπ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
    </div>
  </div>
  <div class="header-bottom">
    <span class="badge">
      üîó <span>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: fa-db-wp / a-lg-notes-2y / ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô / Cash Board</span>
    </span>
    <span class="badge">
      üß† <span>‡∏°‡∏µ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ + QA ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</span>
    </span>
    <span class="badge">
      ‚úÖ <span>Checklist 7 ‡∏Ç‡πâ‡∏≠ + Export ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö</span>
    </span>
  </div>
</header>

<main>
  <div class="layout">
    <!-- MAIN FORM -->
    <section>
      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ / ‡∏õ‡∏µ / ‡∏á‡∏ß‡∏î + ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à</div>
            <div class="card-sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ / ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì / ‡∏á‡∏ß‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‚Äì‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏õ‡∏ó. 8.6</div>
          </div>
          <button class="btn btn-primary btn-sm" id="btnLoadFromDB">
            ‚¨á ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </button>
        </div>

        <div class="form-row">
          <div>
            <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á)</label>
            <input type="text" id="unitName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏© / ‡∏≠‡∏ö‡∏ï. ‡∏Ø‡∏•‡∏Ø" />
          </div>
          <div>
            <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (auto-fill ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)</label>
            <input type="text" id="unitLocation" placeholder="‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" />
          </div>
          <div>
            <label>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏û.‡∏®.)</label>
            <select id="fiscalYear">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ --</option>
              <script>
                // ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏° option ‡∏ú‡πà‡∏≤‡∏ô JS ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
              </script>
            </select>
          </div>
          <div>
            <label>‡∏á‡∏ß‡∏î (‡∏õ‡∏¥‡∏î‡∏á‡∏ö)</label>
            <select id="period">
              <option value="30-09">30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
              <option value="31-12">31 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° (‡∏Å‡∏£‡∏ì‡∏µ‡∏û‡∏¥‡πÄ‡∏®‡∏©)</option>
            </select>
          </div>
        </div>

        <div style="font-size:11px;color:var(--muted);margin-top:2px;">
          Tip: ‡∏õ‡∏∏‡πà‡∏° ‚Äú‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API (‡πÄ‡∏ä‡πà‡∏ô <span class="pill">GET /api/fa/lg/8_6?unit=...&year=...</span>)
        </div>
      </div>

      <!-- SECTION A: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
      <div class="card" style="margin-top:12px;">
        <div class="card-header">
          <div>
            <div class="card-title">
              ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 ‚Äì ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å
              <span class="pill">Editor + Input + Attachments</span>
            </div>
            <div class="card-sub">‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° ‡∏≠‡∏õ‡∏ó. 8.6 ‡πÉ‡∏ô Excel ‡πÑ‡∏î‡πâ</div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn btn-ghost btn-sm" id="btnAddRow">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            <button class="btn btn-ghost btn-sm" id="btnAutoAttachWP">üìé ‡∏î‡∏∂‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å fa-db-wp</button>
          </div>
        </div>

        <div style="max-height:260px;overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,0.08);">
          <table id="itemsTable">
            <thead>
              <tr>
                <th style="width:40px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                <th style="width:120px;" class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                <th style="width:150px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                <th style="width:110px;" class="text-center">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</th>
                <th style="width:60px;"></th>
              </tr>
            </thead>
            <tbody>
              <!-- ‡πÅ‡∏ñ‡∏ß‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS -->
            </tbody>
          </table>
        </div>

        <div class="attachments">
          <button class="btn btn-ghost btn-sm" data-section-attach="main">
            üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1
          </button>
          <input type="file" multiple style="display:none;" id="fileMainSection" />
          <div class="attach-list" id="fileMainSectionList">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1)
          </div>
        </div>
      </div>

      <!-- SECTION B: ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• / ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô -->
      <div class="card" style="margin-top:12px;">
        <div class="card-header">
          <div>
            <div class="card-title">
              ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2 ‚Äì ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
              <span class="tag">AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ</span>
            </div>
            <div class="card-sub">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (2 ‡∏õ‡∏µ) ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô FA</div>
          </div>
          <button class="btn btn-primary btn-sm" id="btnAISummarize">
            ü§ñ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ
          </button>
        </div>

        <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ / Narrative (‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏≠‡∏á‡πÑ‡∏î‡πâ)</label>
        <textarea id="summaryText" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏ö ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°..."></textarea>

        <div class="attachments">
          <button class="btn btn-ghost btn-sm" data-section-attach="summary">
            üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2)
          </button>
          <input type="file" multiple style="display:none;" id="fileSummarySection" />
          <div class="attach-list" id="fileSummarySectionList">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2)
          </div>
        </div>
      </div>

      <!-- SECTION C: ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ -->
      <div class="card" style="margin-top:12px;">
        <div class="card-header">
          <div>
            <div class="card-title">
              ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3 ‚Äì ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ / ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
            </div>
            <div class="card-sub">‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à ‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</div>
          </div>
        </div>

        <label>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ / ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£</label>
        <textarea id="recommendText" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ò‡∏£‡∏£‡∏° ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î..."></textarea>

        <div class="attachments">
          <button class="btn btn-ghost btn-sm" data-section-attach="recommend">
            üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3)
          </button>
          <input type="file" multiple style="display:none;" id="fileRecommendSection" />
          <div class="attach-list" id="fileRecommendSectionList">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3)
          </div>
        </div>

        <!-- Meta / ‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô -->
        <div class="footer-meta">
          <div>
            <label>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ / ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label>
            <input type="text" id="auditorName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏™‡∏Å‡∏∏‡∏•" />
          </div>
          <div>
            <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label>
            <input type="text" id="auditorPosition" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô" />
          </div>
          <div>
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥</label>
            <input type="date" id="auditDate" />
          </div>
        </div>

        <div class="signature-box">
          ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå / Export PDF)
        </div>
      </div>
    </section>

    <!-- SIDE PANEL -->
    <aside>
      <!-- currentData + comment ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API -->
      <div class="card side-section">
        <h3>üì° currentData &amp; API Link</h3>
        <small>‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á backend / API (JSON) ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ä‡πà‡∏≠‡∏á comment ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dev</small>
        <div class="preview-box" id="currentDataPreview">
{ }
        </div>
        <label style="margin-top:6px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤ / ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API</label>
        <textarea id="apiComment" placeholder="‡πÄ‡∏ä‡πà‡∏ô POST /api/fa/lg/8_6/save, ‡πÉ‡∏ä‡πâ token ‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö login, ‡∏ú‡∏π‡∏Å audit_id ‡∏à‡∏≤‡∏Å fa-lg-fieldwork.html ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô"></textarea>
      </div>

      <!-- QA Panel -->
      <div class="card side-section">
        <div class="card-header" style="margin-bottom:4px;">
          <div>
            <div class="card-title">üîç ‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (QA)</div>
            <div class="card-sub">‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</div>
          </div>
          <button class="btn btn-primary btn-sm" id="btnRunQA">
            ‚úÖ ‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô
          </button>
        </div>

        <ul class="qa-list" id="qaList">
          <li class="qa-item">
            <span class="icon">‚ÑπÔ∏è</span>
            <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô QA ‚Äì ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° ‚Äú‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</span>
          </li>
        </ul>
      </div>

      <!-- Checklist -->
      <div class="card side-section">
        <div class="card-header" style="margin-bottom:4px;">
          <div>
            <div class="card-title">‚úÖ Checklist ‚Äì ‡∏≠‡∏õ‡∏ó. 8.6 (7 ‡∏Ç‡πâ‡∏≠)</div>
            <div class="card-sub">‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô Export &amp; ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ (‡πÄ‡∏ß‡πâ‡∏ô‡πÅ‡∏ï‡πà override)</div>
          </div>
        </div>

        <ul class="checklist" id="checklist">
          <li>
            <input type="checkbox" data-check="step1" />
            <span>1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à + ‡∏õ‡∏µ + ‡∏á‡∏ß‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
          </li>
          <li>
            <input type="checkbox" data-check="step2" />
            <span>2) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1) ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</span>
          </li>
          <li>
            <input type="checkbox" data-check="step3" />
            <span>3) ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2)</span>
          </li>
          <li>
            <input type="checkbox" data-check="step4" />
            <span>4) ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ / ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£ (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3)</span>
          </li>
          <li>
            <input type="checkbox" data-check="step5" />
            <span>5) ‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
          </li>
          <li>
            <input type="checkbox" data-check="step6" />
            <span>6) ‡∏£‡∏±‡∏ô ‚Äú‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (QA)‚Äù ‡πÅ‡∏•‡πâ‡∏ß</span>
          </li>
          <li>
            <input type="checkbox" data-check="step7" />
            <span>7) ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‚Äì‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span>
          </li>
        </ul>

        <div class="export-row">
          <div style="flex:1;">
            <label>‡∏ä‡∏ô‡∏¥‡∏î‡∏Å‡∏≤‡∏£ Export</label>
            <select id="exportType">
              <option value="print">Print / PDF</option>
              <option value="json">JSON (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backend / data lake)</option>
              <option value="docx">DOCX (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° backend)</option>
              <option value="xlsx">XLSX (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° backend)</option>
            </select>
          </div>
          <button class="btn btn-primary" id="btnExport">
            üì§ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Export &amp; ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠
          </button>
        </div>
      </div>

      <!-- Route Panel -->
      <div class="card side-section">
        <div class="card-header" style="margin-bottom:4px;">
          <div>
            <div class="card-title">üõ£ Route &amp; Integration Panel</div>
            <div class="card-sub">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏õ‡∏ó. 8.6</div>
          </div>
        </div>

        <div class="route-grid">
          <label class="route-item">
            <input type="checkbox" id="routeReview" checked />
            <span>‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô FA (fa-review-*.html)</span>
          </label>
          <label class="route-item">
            <input type="checkbox" id="routeDB" checked />
            <span>‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ ‚Üí ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á / Data Lake (fa-db-wp / fa-db-data-gov)</span>
          </label>
          <label class="route-item">
            <input type="checkbox" id="routeDashboard" checked />
            <span>‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ ‚Üí Cash Board / Dashboard ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•</span>
          </label>
          <label class="route-item">
            <input type="checkbox" id="routeNotes" />
            <span>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‚Üí ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô (2 ‡∏õ‡∏µ)</span>
          </label>
        </div>

        <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn btn-ghost btn-sm" onclick="window.open('a-lg-notes-2y.html','_blank')">
            üìÑ ‡πÄ‡∏õ‡∏¥‡∏î a-lg-notes-2y.html
          </button>
          <button class="btn btn-ghost btn-sm" onclick="logRouteConsole('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ backend routing...');">
            üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Route Console
          </button>
        </div>

        <div class="route-console" id="routeConsole">
Ready: ‡∏£‡∏≠‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• routing ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° Export...
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- Modal: ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏¥‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô -->
<div class="modal-backdrop" id="stepWarningModal">
  <div class="modal">
    <h2>‚ö†Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö</h2>
    <p id="stepWarningText">
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡∏°‡∏µ‡∏ö‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡πÄ‡∏ä‡πà‡∏ô Checklist ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ô QA
      ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ï‡πà‡∏≠?
    </p>
    <div class="modal-actions">
      <button class="btn btn-ghost btn-sm" id="btnBackToEdit">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <button class="btn btn-ghost btn-sm" id="btnAskForHelp">üí¨ ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</button>
      <button class="btn btn-primary btn-sm" id="btnOverrideProceed">
        ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ (Override)
      </button>
    </div>
  </div>
</div>

<!-- Modal: ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠ override ‚â• 3 -->
<div class="modal-backdrop" id="consultModal">
  <div class="modal">
    <h2>üí° ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</h2>
    <p>
      ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£ override ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç / Admin ‡∏£‡∏∞‡∏ö‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?
    </p>
    <div class="modal-actions">
      <button class="btn btn-primary btn-sm" id="btnNeedConsult">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</button>
      <button class="btn btn-ghost btn-sm" id="btnNoConsult">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</button>
    </div>
  </div>
</div>

<script>
  // ======= GLOBAL STATE =======
  const state = {
    items: [],           // rows ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1
    mainFiles: [],
    summaryFiles: [],
    recommendFiles: [],
    qaMessages: [],
    qaRan: false,
    overrideCount: 0
  };

  // ‡πÄ‡∏ï‡∏¥‡∏°‡∏õ‡∏µ 2565‚Äì2582
  (function fillYears(){
    const fy = document.getElementById('fiscalYear');
    if(!fy) return;
    const start = 2565, end = 2582;
    for(let y=start;y<=end;y++){
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      fy.appendChild(opt);
    }
  })();

  // Helper ‡∏™‡∏£‡πâ‡∏≤‡∏á row ‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á
  function addItemRow(data){
    const tbody = document.querySelector('#itemsTable tbody');
    const idx = (state.items.length || 0) + 1;

    const rowData = {
      id: Date.now() + '-' + idx,
      description: data?.description || '',
      amount: data?.amount || '',
      note: data?.note || '',
      attachments: []
    };
    state.items.push(rowData);

    const tr = document.createElement('tr');
    tr.dataset.id = rowData.id;

    tr.innerHTML = `
      <td class="text-center">${idx}</td>
      <td>
        <input type="text" class="item-desc" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" value="${rowData.description.replace(/"/g,'&quot;')}" />
      </td>
      <td class="text-right">
        <input type="text" class="item-amount" placeholder="0.00" value="${rowData.amount}" style="text-align:right;" />
      </td>
      <td>
        <input type="text" class="item-note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°" value="${rowData.note.replace(/"/g,'&quot;')}" />
      </td>
      <td class="text-center">
        <button class="btn btn-ghost btn-sm btn-row-attach">üìé ‡πÅ‡∏ô‡∏ö</button>
        <div class="attach-list row-attach-list">-</div>
        <input type="file" multiple style="display:none;" class="row-file-input" />
      </td>
      <td class="text-center">
        <button class="btn-icon btn-row-delete" title="‡∏•‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ô‡∏µ‡πâ">‚úñ</button>
      </td>
    `;

    tbody.appendChild(tr);
    bindRowEvents(tr, rowData.id);
    updateCurrentDataPreview();
  }

  function bindRowEvents(tr, id){
    const fileInput = tr.querySelector('.row-file-input');
    const btnAttach = tr.querySelector('.btn-row-attach');
    const attachList = tr.querySelector('.row-attach-list');
    const btnDelete = tr.querySelector('.btn-row-delete');

    btnAttach.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      const row = state.items.find(r => r.id === id);
      if(!row) return;
      row.attachments = files.map(f => f.name);
      attachList.textContent = row.attachments.length
        ? row.attachments.join(', ')
        : '-';
      updateCurrentDataPreview();
    });

    tr.querySelector('.item-desc').addEventListener('input', (e)=>{
      const row = state.items.find(r => r.id === id);
      if(row){ row.description = e.target.value; updateCurrentDataPreview(); }
    });
    tr.querySelector('.item-amount').addEventListener('input', (e)=>{
      const row = state.items.find(r => r.id === id);
      if(row){ row.amount = e.target.value; updateCurrentDataPreview(); }
    });
    tr.querySelector('.item-note').addEventListener('input', (e)=>{
      const row = state.items.find(r => r.id === id);
      if(row){ row.note = e.target.value; updateCurrentDataPreview(); }
    });

    btnDelete.addEventListener('click', ()=>{
      // remove from state
      const idx = state.items.findIndex(r => r.id === id);
      if(idx >= 0) state.items.splice(idx,1);
      tr.remove();
      // re-number
      document.querySelectorAll('#itemsTable tbody tr').forEach((row,i)=>{
        row.querySelector('td:first-child').textContent = i+1;
      });
      updateCurrentDataPreview();
    });
  }

  // Attachments per section
  function setupSectionAttachment(sectionKey, inputId, listId){
    const button = document.querySelector(`[data-section-attach="${sectionKey}"]`);
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);

    if(!button || !input || !list) return;

    button.addEventListener('click', ()=> input.click());

    input.addEventListener('change',(e)=>{
      const files = Array.from(e.target.files).map(f => f.name);
      state[sectionKey+'Files'] = files;
      list.textContent = files.length
        ? files.join(', ')
        : `‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà ${sectionKey === 'main' ? '1' : sectionKey==='summary'?'2':'3'})`;
      updateCurrentDataPreview();
    });
  }

  setupSectionAttachment('main','fileMainSection','fileMainSectionList');
  setupSectionAttachment('summary','fileSummarySection','fileSummarySectionList');
  setupSectionAttachment('recommend','fileRecommendSection','fileRecommendSectionList');

  // ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  document.getElementById('btnAddRow').addEventListener('click',()=>{
    addItemRow({});
  });

  // ‡∏î‡∏∂‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å fa-db-wp (autoAttachFromWP)
  document.getElementById('btnAutoAttachWP').addEventListener('click',()=>{
    autoAttachFromWP();
  });

  function autoAttachFromWP(){
    // ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° backend ‡∏à‡∏£‡∏¥‡∏á:
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: GET /api/fa/wp?unit=...&year=...&form=8_6
    // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á mock data
    const mockFiles = ['wp_8_6_support_01.pdf','wp_8_6_support_02.xlsx'];
    state.mainFiles = mockFiles;
    document.getElementById('fileMainSectionList').textContent = mockFiles.join(', ');
    logRouteConsole('autoAttachFromWP(): ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏à‡∏≤‡∏Å fa-db-wp ‚Üí ' + mockFiles.join(', '));
    updateCurrentDataPreview();
  }

  // ‡∏õ‡∏∏‡πà‡∏° Load ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
  document.getElementById('btnLoadFromDB').addEventListener('click',()=>{
    loadFromDatabase();
  });

  function loadFromDatabase(){
    const unit = document.getElementById('unitName').value.trim();
    const year = document.getElementById('fiscalYear').value;

    // ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API ‡∏à‡∏£‡∏¥‡∏á:
    // GET /api/fa/lg/8_6?unit=...&year=...&period=...
    // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á mock
    logRouteConsole(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${unit || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)'} ‡∏õ‡∏µ: ${year || '(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)'}`);

    // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏™‡πà sample 2 ‡πÅ‡∏ñ‡∏ß
    state.items = [];
    document.querySelector('#itemsTable tbody').innerHTML = '';
    addItemRow({description:'‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• #1', amount:'100000.00', note:'mock data'});
    addItemRow({description:'‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• #2', amount:'250000.00', note:'mock data'});
  }

  // ‡∏õ‡∏∏‡πà‡∏° AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ
  document.getElementById('btnAISummarize').addEventListener('click',()=>{
    aiSummarize();
  });

  function aiSummarize(){
    // ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° backend AI:
    // POST /api/ai/summarize  { items, summaryText, recommendText, ... }
    // ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏à‡∏≤‡∏Å state.items
    const items = state.items || [];
    if(!items.length){
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏™‡∏£‡∏∏‡∏õ‡πÑ‡∏î‡πâ‡∏°‡∏µ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó');
      return;
    }
    const total = items.reduce((sum,r)=>{
      const v = parseFloat((r.amount || '0').toString().replace(/,/g,'')) || 0;
      return sum + v;
    },0);
    const unit = document.getElementById('unitName').value || '‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à';
    const year = document.getElementById('fiscalYear').value || '‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ...';

    const autoText =
      `‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‡∏≠‡∏õ‡∏ó. 8.6 ‡∏Ç‡∏≠‡∏á ${unit} `+
      `‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${year} ‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ${items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ `+
      `‡∏£‡∏ß‡∏°‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${total.toLocaleString('th-TH',{minimumFractionDigits:2, maximumFractionDigits:2})} ‡∏ö‡∏≤‡∏ó `+
      `‡πÇ‡∏î‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÑ‡∏î‡πâ‡πÅ‡∏Å‡πà ‚Äú${items[0].description || '...' }‚Äù ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏ô `+
      `‡∏ã‡∏∂‡πà‡∏á‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏ï‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏à‡∏≤‡∏£‡∏ì‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏Ç‡∏≠‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß`;

    const area = document.getElementById('summaryText');
    if(area.value.trim()){
      area.value = area.value.trim() + '\n\n[AI ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡∏¥‡∏°]\n' + autoText;
    }else{
      area.value = autoText;
    }
    updateCurrentDataPreview();
  }

  // QA ‚Äì ‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  document.getElementById('btnRunQA').addEventListener('click',()=>{
    runQA();
  });

  function runQA(){
    const msgs = [];
    const unit = document.getElementById('unitName').value.trim();
    const year = document.getElementById('fiscalYear').value;
    const items = state.items || [];
    const summary = document.getElementById('summaryText').value.trim();
    const recommend = document.getElementById('recommendText').value.trim();
    const auditor = document.getElementById('auditorName').value.trim();
    const pos = document.getElementById('auditorPosition').value.trim();
    const date = document.getElementById('auditDate').value;

    if(!unit) msgs.push({type:'warn', text:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ ‚Äú‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‚Äù'});
    if(!year) msgs.push({type:'warn', text:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‚Äú‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‚Äù'});
    if(!items.length) msgs.push({type:'error', text:'‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏¢'});
    if(!summary) msgs.push({type:'warn', text:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‚Äú‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‚Äù (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2)'});
    if(!recommend) msgs.push({type:'warn', text:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏ ‚Äú‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ / ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‚Äù (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3)'});
    if(!auditor || !pos || !date) msgs.push({type:'warn', text:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á / ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'});

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
    const nonNumeric = items.filter(r => r.amount && isNaN(parseFloat(r.amount.toString().replace(/,/g,''))));
    if(nonNumeric.length){
      msgs.push({type:'error', text:`‡∏û‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ${nonNumeric.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πà‡∏≠‡∏á "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"`});
    }

    if(!msgs.length){
      msgs.push({type:'ok', text:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÑ‡∏î‡πâ'});
    }

    state.qaMessages = msgs;
    state.qaRan = true;

    const qaList = document.getElementById('qaList');
    qaList.innerHTML = '';
    msgs.forEach(m => {
      const li = document.createElement('li');
      li.className = 'qa-item';
      const icon = m.type === 'error' ? '‚õî' : (m.type === 'warn' ? '‚ö†Ô∏è' : '‚úÖ');
      li.innerHTML = `<span class="icon">${icon}</span><span>${m.text}</span>`;
      qaList.appendChild(li);
    });

    // auto tick checklist step6 ‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏ô QA ‡πÅ‡∏•‡πâ‡∏ß
    const checkbox = document.querySelector('[data-check="step6"]');
    if(checkbox) checkbox.checked = true;

    updateCurrentDataPreview();
  }

  // ‡πÅ‡∏™‡∏î‡∏á currentData (JSON preview)
  function updateCurrentDataPreview(){
    const preview = document.getElementById('currentDataPreview');
    const data = {
      meta:{
        unit: document.getElementById('unitName').value.trim(),
        location: document.getElementById('unitLocation').value.trim(),
        fiscalYear: document.getElementById('fiscalYear').value || null,
        period: document.getElementById('period').value,
        auditorName: document.getElementById('auditorName').value.trim(),
        auditorPosition: document.getElementById('auditorPosition').value.trim(),
        auditDate: document.getElementById('auditDate').value || null
      },
      section1:{
        items: state.items
      },
      sectionFiles:{
        main: state.mainFiles,
        summary: state.summaryFiles,
        recommend: state.recommendFiles
      },
      section2:{
        summaryText: document.getElementById('summaryText').value.trim()
      },
      section3:{
        recommendText: document.getElementById('recommendText').value.trim()
      },
      qa:{
        ran: state.qaRan,
        messages: state.qaMessages
      },
      checklist:getChecklistState(),
      apiComment: document.getElementById('apiComment').value.trim()
    };

    preview.textContent = JSON.stringify(data,null,2);
  }

  ['unitName','unitLocation','fiscalYear','period','summaryText','recommendText',
   'auditorName','auditorPosition','auditDate','apiComment'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', updateCurrentDataPreview);
    if(el && el.tagName === 'SELECT') el.addEventListener('change', updateCurrentDataPreview);
  });

  function getChecklistState(){
    const stateCheck = {};
    document.querySelectorAll('#checklist input[type="checkbox"]').forEach(cb=>{
      stateCheck[cb.dataset.check] = cb.checked;
    });
    return stateCheck;
  }

  // Export & Routing
  document.getElementById('btnExport').addEventListener('click',()=>{
    handleExportFlow();
  });

  function handleExportFlow(){
    const checklist = getChecklistState();
    const allChecked = Object.values(checklist).every(v => v === true);
    let needWarn = false;
    let warnMsg = [];

    if(!allChecked){
      needWarn = true;
      warnMsg.push('Checklist 7 ‡∏Ç‡πâ‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
    }
    if(!state.qaRan){
      needWarn = true;
      warnMsg.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ô ‚Äú‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (QA)‚Äù');
    }
    if((state.items || []).length === 0){
      needWarn = true;
      warnMsg.push('‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà');
    }

    if(needWarn){
      const text = document.getElementById('stepWarningText');
      text.textContent = '‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: ' + warnMsg.join(' / ');
      openModal('stepWarningModal');
    }else{
      // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚Üí export ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
      doExport(false);
    }
  }

  function doExport(isOverride){
    const exportType = document.getElementById('exportType').value;
    updateCurrentDataPreview(); // ensure latest
    const dataStr = document.getElementById('currentDataPreview').textContent || '{}';

    // Routing log
    const routing = {
      review: document.getElementById('routeReview').checked,
      db: document.getElementById('routeDB').checked,
      dashboard: document.getElementById('routeDashboard').checked,
      notes: document.getElementById('routeNotes').checked
    };
    logRouteConsole('‡πÄ‡∏£‡∏¥‡πà‡∏° Export type=' + exportType + ', override=' + isOverride + ', routing=' + JSON.stringify(routing));

    if(exportType === 'print'){
      window.print();
    }else if(exportType === 'json'){
      // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON ‡∏à‡∏£‡∏¥‡∏á
      const blob = new Blob([dataStr],{type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      const unit = (document.getElementById('unitName').value || 'unit').replace(/\s+/g,'_');
      const year = document.getElementById('fiscalYear').value || 'year';
      a.download = `fa_lg_8_6_${unit}_${year}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      alert('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå JSON ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° backend / data lake)');
    }else if(exportType === 'docx'){
      alert('‡πÇ‡∏´‡∏°‡∏î DOCX: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ backend (‡πÄ‡∏ä‡πà‡∏ô /api/fa/lg/8_6/export/docx) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .docx ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ');
    }else if(exportType === 'xlsx'){
      alert('‡πÇ‡∏´‡∏°‡∏î XLSX: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ backend (‡πÄ‡∏ä‡πà‡∏ô /api/fa/lg/8_6/export/xlsx) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå .xlsx ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ');
    }

    logRouteConsole('Export ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô (‡∏à‡∏≥‡∏•‡∏≠‡∏á) ‚Äì ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ backend ‡∏ï‡∏≤‡∏° routing');
  }

  function logRouteConsole(msg){
    const c = document.getElementById('routeConsole');
    const now = new Date();
    const time = now.toLocaleTimeString('th-TH',{hour12:false});
    c.textContent += `\n[${time}] ${msg}`;
    c.scrollTop = c.scrollHeight;
    console.log('[RouteConsole]', msg);
  }

  // Modals
  function openModal(id){
    const m = document.getElementById(id);
    if(m) m.style.display = 'flex';
  }
  function closeModal(id){
    const m = document.getElementById(id);
    if(m) m.style.display = 'none';
  }

  // ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô modal ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô
  document.getElementById('btnBackToEdit').addEventListener('click',()=>{
    closeModal('stepWarningModal');
  });
  document.getElementById('btnAskForHelp').addEventListener('click',()=>{
    alert('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô / FAQ / ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠ Admin ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏´‡∏ô‡πâ‡∏≤ help center ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)');
    closeModal('stepWarningModal');
  });
  document.getElementById('btnOverrideProceed').addEventListener('click',()=>{
    state.overrideCount++;
    closeModal('stepWarningModal');
    if(state.overrideCount >= 3){
      openModal('consultModal');
    }
    doExport(true);
  });

  // ‡∏õ‡∏∏‡πà‡∏° modal ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤
  document.getElementById('btnNeedConsult').addEventListener('click',()=>{
    alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏ß‡πâ (‡πÄ‡∏ä‡πà‡∏ô POST /api/support/ticket) ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á Admin/‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°‡πÉ‡∏´‡πâ‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö');
    closeModal('consultModal');
  });
  document.getElementById('btnNoConsult').addEventListener('click',()=>{
    closeModal('consultModal');
  });

  // ‡∏õ‡∏∏‡πà‡∏° Save Draft / Reset
  document.getElementById('btnSaveDraft').addEventListener('click',()=>{
    updateCurrentDataPreview();
    const data = document.getElementById('currentDataPreview').textContent || '{}';
    // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: localStorage ‡πÅ‡∏ó‡∏ô backend
    localStorage.setItem('fa_lg_8_6_draft', data);
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á‡∏•‡∏á‡πÉ‡∏ô browser (localStorage) ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Äì ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏´‡πâ‡∏¢‡∏¥‡∏á API /saveDraft');
  });

  document.getElementById('btnResetForm').addEventListener('click',()=>{
    if(!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;
    location.reload();
  });

  // ‡πÇ‡∏´‡∏•‡∏î draft ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
  (function loadDraftIfAny(){
    const draft = localStorage.getItem('fa_lg_8_6_draft');
    if(!draft) return;
    // ‡πÑ‡∏°‡πà auto-load ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÅ‡∏ï‡πà‡πÉ‡∏´‡πâ log ‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dev
    logRouteConsole('‡∏û‡∏ö draft ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage (fa_lg_8_6_draft) ‚Äì ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô logic ‡πÄ‡∏û‡∏∑‡πà‡∏≠ restore ‡πÑ‡∏î‡πâ');
  })();

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á 1 ‡πÅ‡∏ñ‡∏ß
  addItemRow({description:'‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£', amount:'0.00', note:''});
</script>
</body>
</html>

