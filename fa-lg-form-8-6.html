<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>FA ‚Äì LG Fieldwork | ‡∏≠‡∏õ‡∏ó. 8.6 ‚Äì ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (Lead)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary:#0d47a1; --primary-2:#42a5f5; --accent:#ffd54f;
      --bg:#060818; --card:#11152b; --border:#262b46;
      --text:#f5f7ff; --muted:#a3acc7; --danger:#ef5350;
      --shadow-soft:0 10px 30px rgba(0,0,0,0.55);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;font-family:"Segoe UI",Tahoma,sans-serif;
      background:
        radial-gradient(circle at 10% 0%, rgba(123,30,60,0.35) 0, transparent 55%),
        radial-gradient(circle at 90% 100%, rgba(66,165,245,0.35) 0, transparent 55%),
        var(--bg);color:var(--text);
    }
    header{
      padding:14px 18px;
      border-bottom:1px solid rgba(255,255,255,0.1);
      background:linear-gradient(120deg,#7b1e3c,#0d47a1,#42a5f5);
      box-shadow:var(--shadow-soft);
      position:sticky;top:0;z-index:20;
    }
    .header-top{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;}
    .header-title h1{margin:0;font-size:20px;font-weight:700;}
    .header-title span{font-size:12px;opacity:0.9;}
    .header-actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
    .btn{
      border:none;border-radius:999px;padding:6px 14px;font-size:12px;
      font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:6px;white-space:nowrap;
    }
    .btn-primary{background:linear-gradient(120deg,var(--primary),var(--primary-2));color:#fff;}
    .btn-ghost{background:rgba(0,0,0,0.25);color:#fff;border:1px solid rgba(255,255,255,0.12);}
    .btn-danger{background:var(--danger);color:#fff;}
    .btn-sm{padding:4px 10px;font-size:11px;}
    .header-bottom{margin-top:10px;display:flex;flex-wrap:wrap;gap:6px;font-size:11px;}
    .badge{
      display:inline-flex;align-items:center;gap:6px;padding:4px 10px;
      border-radius:999px;background:rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.16);
    }
    main{padding:16px;max-width:1300px;margin:0 auto;}
    .layout{display:grid;grid-template-columns:minmax(0,2.15fr) minmax(300px,0.85fr);gap:16px;align-items:flex-start;}
    @media(max-width:960px){.layout{grid-template-columns:1fr;}}
    .card{
      background:rgba(7,11,32,0.94);border-radius:18px;border:1px solid var(--border);
      padding:14px;box-shadow:0 14px 40px rgba(0,0,0,0.65);backdrop-filter:blur(14px);
    }
    .card-header{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-bottom:10px;}
    .card-title{font-size:14px;font-weight:700;display:flex;align-items:center;gap:6px;}
    .card-sub{font-size:11px;color:var(--muted);margin-top:2px;}
    label{font-size:11px;color:var(--muted);display:block;margin-bottom:4px;}
    input,select,textarea{
      width:100%;border-radius:10px;border:1px solid var(--border);
      background:rgba(9,13,36,0.96);color:var(--text);font-size:12px;padding:6px 9px;font-family:inherit;
    }
    textarea{min-height:90px;resize:vertical;}
    input::placeholder,textarea::placeholder{color:rgba(163,172,199,0.8);}
    .form-row{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;margin-bottom:8px;}
    @media(max-width:720px){.form-row{grid-template-columns:1fr 1fr;}}
    .pill{
      border-radius:999px;padding:2px 8px;font-size:10px;
      border:1px solid rgba(255,255,255,0.18);background:rgba(255,255,255,0.03);color:var(--muted);
    }
    table{width:100%;border-collapse:collapse;font-size:11px;}
    th,td{border-bottom:1px solid rgba(255,255,255,0.08);padding:4px 6px;text-align:left;}
    th{background:rgba(255,255,255,0.04);font-weight:600;position:sticky;top:0;z-index:1;}
    tbody tr:nth-child(even){background:rgba(255,255,255,0.01);}
    tbody tr:hover{background:rgba(66,165,245,0.08);}
    .text-right{text-align:right;} .text-center{text-align:center;}
    .attachments{margin-top:4px;font-size:11px;}
    .attach-list{margin-top:2px;font-size:10px;color:var(--muted);}
    .tag{
      display:inline-flex;align-items:center;gap:4px;padding:2px 7px;border-radius:999px;
      border:1px solid rgba(244,143,177,0.7);background:rgba(244,143,177,0.12);font-size:10px;color:#f48fb1;
    }
    .side-section{margin-bottom:12px;}
    .side-section h3{margin:0 0 6px 0;font-size:13px;font-weight:600;display:flex;align-items:center;gap:6px;}
    .side-section small{font-size:11px;color:var(--muted);}
    .preview-box{
      background:rgba(5,9,28,0.96);border-radius:12px;border:1px solid var(--border);
      padding:8px;max-height:180px;overflow:auto;font-family:"Cascadia Code","Consolas",monospace;font-size:10px;white-space:pre-wrap;
    }
    .qa-list{list-style:none;margin:4px 0 0;padding:0;font-size:11px;}
    .qa-item{display:flex;align-items:flex-start;gap:6px;padding:3px 0;}
    .qa-item .icon{font-size:12px;margin-top:1px;}
    .checklist{list-style:none;padding:0;margin:6px 0 0;font-size:11px;}
    .checklist li{display:flex;align-items:flex-start;gap:6px;padding:3px 0;}
    .checklist input{margin-top:2px;cursor:pointer;}
    .route-grid{display:grid;grid-template-columns:1fr;gap:4px;font-size:11px;}
    .route-item{
      display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:8px;
      background:rgba(5,9,28,0.96);border:1px solid var(--border);
    }
    .route-console{
      margin-top:6px;font-size:10px;background:rgba(0,0,0,0.7);border-radius:8px;
      padding:6px;border:1px dashed rgba(255,255,255,0.15);max-height:80px;overflow:auto;
      font-family:"Cascadia Code","Consolas",monospace;white-space:pre-wrap;
    }
    .footer-meta{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:10px;}
    @media(max-width:720px){.footer-meta{grid-template-columns:1fr;}}
    .signature-box{
      margin-top:10px;padding-top:22px;border-top:1px dashed rgba(255,255,255,0.35);
      text-align:center;font-size:11px;color:var(--muted);
    }
    .export-row{margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,0.75);
      display:none;justify-content:center;align-items:center;z-index:50;
    }
    .modal{
      background:#0b1024;border-radius:18px;padding:16px;max-width:420px;width:100%;
      border:1px solid var(--border);box-shadow:var(--shadow-soft);
    }
    .modal h2{margin:0 0 6px 0;font-size:15px;}
    .modal p{margin:0 0 10px 0;font-size:12px;color:var(--muted);}
    .modal-actions{margin-top:10px;display:flex;justify-content:flex-end;gap:6px;flex-wrap:wrap;}
    @media print{
      header,.btn,.route-console,#routeSearch{display:none!important;}
      body{background:#fff;color:#000;}
      .card{box-shadow:none;border-color:#ccc;}
      main{padding:8px;}
      .signature-box{margin-top:30px;border-color:#000;}
    }
  </style>
</head>
<body>
<header>
  <div class="header-top">
    <div class="header-title">
      <h1>‡∏≠‡∏õ‡∏ó. 8.6 ‚Äì ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ (Lead)</h1>
      <span>‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏≠‡∏õ‡∏ó. | Lead Sheet ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</span>
    </div>
    <div class="header-actions">
      <button class="btn btn-ghost btn-sm" onclick="window.location.href='fa-lg-form-8-6-1.html'">‚óÄ 8.6.1</button>
      <button class="btn btn-ghost btn-sm" onclick="window.location.href='fa-lg-form-8-6-2.html'">8.6.2 ‚ñ∂</button>
      <button class="btn btn-ghost btn-sm" onclick="window.location.href='index.html'">üè† ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å FA</button>
      <button class="btn btn-ghost btn-sm" onclick="window.location.href='fa-lg-fieldwork.html'">‚Üê Fieldwork</button>
      <button class="btn btn-ghost btn-sm" id="btnSaveDraft">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á</button>
      <button class="btn btn-danger btn-sm" id="btnResetForm">üßπ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
    </div>
  </div>
  <div class="header-bottom">
    <span class="badge">üîó <span>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° fa-db-wp / a-lg-notes-2y / ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô / Cash Board</span></span>
    <span class="badge">üß† <span>AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ + QA ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î</span></span>
    <span class="badge">‚úÖ <span>Checklist ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô Export</span></span>
    <span class="badge">üìÑ <span>FormCode: LG_8_6</span></span>
  </div>
</header>

<main>
  <div class="layout">
    <section>
      <!-- META -->
      <div class="card">
        <div class="card-header">
          <div>
            <div class="card-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à</div>
            <div class="card-sub">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢ / ‡∏õ‡∏µ / ‡∏á‡∏ß‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏õ‡∏ó. 8.6)</div>
          </div>
          <button class="btn btn-primary btn-sm" id="btnLoadFromDB">‚¨á ‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
        <div class="form-row">
          <div>
            <label>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à</label>
            <input id="unitName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏ó‡∏®‡∏ö‡∏≤‡∏•‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©" />
          </div>
          <div>
            <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î / ‡∏≠‡∏≥‡πÄ‡∏†‡∏≠</label>
            <input id="unitLocation" placeholder="‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á" />
          </div>
          <div>
            <label>‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡∏û.‡∏®.)</label>
            <select id="fiscalYear"></select>
          </div>
          <div>
            <label>‡∏á‡∏ß‡∏î‡∏õ‡∏¥‡∏î‡∏á‡∏ö</label>
            <select id="period">
              <option value="30-09">30 ‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
              <option value="31-12">31 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏° (‡∏û‡∏¥‡πÄ‡∏®‡∏©)</option>
            </select>
          </div>
        </div>
        <div style="font-size:11px;color:var(--muted);">
          API ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: <span class="pill">GET /api/fa/lg/8_6?unit=...&amp;year=...</span>
        </div>
      </div>

      <!-- SECTION 1 -->
      <div class="card" style="margin-top:12px;">
        <div class="card-header">
          <div>
            <div class="card-title">
              ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1 ‚Äì ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å (Lead Items)
              <span class="pill">Editor + Input + Attachments</span>
            </div>
            <div class="card-sub">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏≠‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢ ‡πÅ‡∏•‡∏∞‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</div>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn btn-ghost btn-sm" id="btnAddRow">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
            <button class="btn btn-ghost btn-sm" id="btnAutoAttachWP">üìé ‡∏î‡∏∂‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏à‡∏≤‡∏Å fa-db-wp</button>
          </div>
        </div>
        <div style="max-height:260px;overflow:auto;border-radius:12px;border:1px solid rgba(255,255,255,0.08);">
          <table id="itemsTable">
            <thead>
              <tr>
                <th style="width:40px;">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                <th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th>
                <th style="width:140px;" class="text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</th>
                <th style="width:180px;">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏ñ‡∏∂‡∏á‡πÅ‡∏ö‡∏ö (8.6.x)</th>
                <th style="width:120px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                <th style="width:110px;" class="text-center">‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö</th>
                <th style="width:60px;"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="attachments">
          <button class="btn btn-ghost btn-sm" data-section-attach="main">üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1</button>
          <input type="file" multiple id="fileMainSection" style="display:none;">
          <div class="attach-list" id="fileMainSectionList">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1)</div>
        </div>
      </div>

      <!-- SECTION 2 -->
      <div class="card" style="margin-top:12px;">
        <div class="card-header">
          <div>
            <div class="card-title">
              ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2 ‚Äì ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
              <span class="tag">AI Summary</span>
            </div>
            <div class="card-sub">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ 8.6.1 / 8.6.1.1 / 8.6.2 ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</div>
          </div>
          <button class="btn btn-primary btn-sm" id="btnAISummarize">ü§ñ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ</button>
        </div>
        <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ / Narrative</label>
        <textarea id="summaryText" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç..."></textarea>
        <div class="attachments">
          <button class="btn btn-ghost btn-sm" data-section-attach="summary">üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2)</button>
          <input type="file" multiple id="fileSummarySection" style="display:none;">
          <div class="attach-list" id="fileSummarySectionList">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2)</div>
        </div>
      </div>

      <!-- SECTION 3 -->
      <div class="card" style="margin-top:12px;">
        <div class="card-header">
          <div>
            <div class="card-title">‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3 ‚Äì ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ / ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</div>
            <div class="card-sub">‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏†‡∏≤‡∏¢‡πÉ‡∏ô ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á</div>
          </div>
        </div>
        <label>‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ / ‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£</label>
        <textarea id="recommendText" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏ò‡∏£‡∏£‡∏° ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î..."></textarea>
        <div class="attachments">
          <button class="btn btn-ghost btn-sm" data-section-attach="recommend">üìé ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3)</button>
          <input type="file" multiple id="fileRecommendSection" style="display:none;">
          <div class="attach-list" id="fileRecommendSectionList">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3)</div>
        </div>
        <div class="footer-meta">
          <div><label>‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥ / ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</label><input id="auditorName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏™‡∏Å‡∏∏‡∏•"></div>
          <div><label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</label><input id="auditorPosition" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏á‡∏¥‡∏ô‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô"></div>
          <div><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥</label><input type="date" id="auditDate"></div>
        </div>
        <div class="signature-box">‡∏ä‡πà‡∏≠‡∏á‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô (‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå / PDF)</div>
      </div>
    </section>

    <!-- SIDE -->
    <aside>
      <div class="card side-section">
        <h3>üì° currentData &amp; API</h3>
        <small>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• JSON ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏õ backend (FA Data Lake / API)</small>
        <div class="preview-box" id="currentDataPreview">{ }</div>
        <label style="margin-top:6px;">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö dev / ‡∏à‡∏∏‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° API</label>
        <textarea id="apiComment" placeholder="‡πÄ‡∏ä‡πà‡∏ô POST /api/fa/lg/8_6/save, bind audit_id ‡∏à‡∏≤‡∏Å fa-lg-fieldwork.html"></textarea>
      </div>

      <div class="card side-section">
        <div class="card-header" style="margin-bottom:4px;">
          <div>
            <div class="card-title">üîç ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</div>
            <div class="card-sub">‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ú‡∏¥‡∏î ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô</div>
          </div>
          <button class="btn btn-primary btn-sm" id="btnRunQA">‚úÖ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</button>
        </div>
        <ul class="qa-list" id="qaList">
          <li class="qa-item"><span class="icon">‚ÑπÔ∏è</span><span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ô QA ‚Äì ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô</span></li>
        </ul>
      </div>

      <div class="card side-section">
        <div class="card-header" style="margin-bottom:4px;">
          <div>
            <div class="card-title">‚úÖ Checklist ‚Äì ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô (7 ‡∏Ç‡πâ‡∏≠)</div>
            <div class="card-sub">‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô Export &amp; ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô override)</div>
          </div>
        </div>
        <ul class="checklist" id="checklist">
          <li><input type="checkbox" data-check="step1"> <span>1) ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à + ‡∏õ‡∏µ + ‡∏á‡∏ß‡∏î‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</span></li>
          <li><input type="checkbox" data-check="step2"> <span>2) ‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á Lead (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1) ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</span></li>
          <li><input type="checkbox" data-check="step3"> <span>3) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2)</span></li>
          <li><input type="checkbox" data-check="step4"> <span>4) ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞ (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3)</span></li>
          <li><input type="checkbox" data-check="step5"> <span>5) ‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span></li>
          <li><input type="checkbox" data-check="step6"> <span>6) ‡∏£‡∏±‡∏ô QA ‡πÅ‡∏•‡πâ‡∏ß</span></li>
          <li><input type="checkbox" data-check="step7"> <span>7) ‡∏ï‡∏£‡∏ß‡∏à‡∏ä‡∏∑‡πà‡∏≠‚Äì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‚Äì‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢</span></li>
        </ul>
        <div class="export-row">
          <div style="flex:1;">
            <label>‡∏ä‡∏ô‡∏¥‡∏î‡∏Å‡∏≤‡∏£ Export</label>
            <select id="exportType">
              <option value="print">Print / PDF</option>
              <option value="json">JSON</option>
              <option value="docx">DOCX</option>
              <option value="xlsx">XLSX</option>
            </select>
          </div>
          <button class="btn btn-primary" id="btnExport">üì§ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Export &amp; ‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠</button>
        </div>
      </div>

      <div class="card side-section">
        <div class="card-header" style="margin-bottom:4px;">
          <div>
            <div class="card-title">üõ£ Route &amp; Integration</div>
            <div class="card-sub">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô / ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• / Dashboard / Notes</div>
          </div>
        </div>
        <div style="margin-bottom:6px;">
          <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á</label>
          <input id="routeSearch" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô, ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, dashboard, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏...">
        </div>
        <div class="route-grid" id="routeGrid">
          <label class="route-item" data-route-label="‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô fa review ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô">
            <input type="checkbox" id="routeReview" checked> <span>‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ ‚Üí ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≠‡∏ö‡∏ó‡∏≤‡∏ô FA</span>
          </label>
          <label class="route-item" data-route-label="‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• data lake fa-db-wp fa-db-data-gov">
            <input type="checkbox" id="routeDB" checked> <span>‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ ‚Üí ‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏≤‡∏á / Data Lake</span>
          </label>
          <label class="route-item" data-route-label="cash board dashboard ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏ú‡∏•">
            <input type="checkbox" id="routeDashboard" checked> <span>‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠ ‚Üí Cash Board / Dashboard</span>
          </label>
          <label class="route-item" data-route-label="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ notes a-lg-notes-2y">
            <input type="checkbox" id="routeNotes"> <span>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ ‚Üí ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏á‡∏ö (2 ‡∏õ‡∏µ)</span>
          </label>
        </div>
        <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
          <button class="btn btn-ghost btn-sm" onclick="window.open('a-lg-notes-2y.html','_blank')">üìÑ ‡πÄ‡∏õ‡∏¥‡∏î a-lg-notes-2y.html</button>
          <button class="btn btn-ghost btn-sm" onclick="logRouteConsole('‡∏ó‡∏î‡∏™‡∏≠‡∏ö routing...');">üß™ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö Route</button>
        </div>
        <div class="route-console" id="routeConsole">Ready: ‡∏£‡∏≠ Export ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
      </div>
    </aside>
  </div>
</main>

<!-- MODALS -->
<div class="modal-backdrop" id="stepWarningModal">
  <div class="modal">
    <h2>‚ö†Ô∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö / ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á</h2>
    <p id="stepWarningText">‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ö‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£?</p>
    <div class="modal-actions">
      <button class="btn btn-ghost btn-sm" id="btnBackToEdit">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
      <button class="btn btn-ghost btn-sm" id="btnAskForHelp">üí¨ ‡∏Ç‡∏≠‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</button>
      <button class="btn btn-primary btn-sm" id="btnOverrideProceed">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠ (Override)</button>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="consultModal">
  <div class="modal">
    <h2>üí° ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</h2>
    <p>‡∏°‡∏µ‡∏Å‡∏≤‡∏£ Override ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
    <div class="modal-actions">
      <button class="btn btn-primary btn-sm" id="btnNeedConsult">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤</button>
      <button class="btn btn-ghost btn-sm" id="btnNoConsult">‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</button>
    </div>
  </div>
</div>

<script>
  const FORM_CODE = "LG_8_6";
  const state = {
    items: [],
    mainFiles: [],
    summaryFiles: [],
    recommendFiles: [],
    qaMessages: [],
    qaRan: false,
    overrideCount: 0
  };

  function initYears(){
    const fy = document.getElementById('fiscalYear');
    fy.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ --</option>';
    for(let y=2565;y<=2582;y++){
      const o=document.createElement('option');o.value=y;o.textContent=y;fy.appendChild(o);
    }
  }

  function addItemRow(data={}){
    const tbody = document.querySelector('#itemsTable tbody');
    const idx = state.items.length+1;
    const id = Date.now()+"-"+idx;
    const row = {
      id,
      description:data.description||'',
      amount:data.amount||'',
      linkTo:data.linkTo||'',
      note:data.note||'',
      attachments:[]
    };
    state.items.push(row);

    const tr=document.createElement('tr');tr.dataset.id=id;
    tr.innerHTML = `
      <td class="text-center">${idx}</td>
      <td><input class="i-desc" placeholder="‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" value="${row.description.replace(/"/g,'&quot;')}"></td>
      <td class="text-right"><input class="i-amt" placeholder="0.00" value="${row.amount}" style="text-align:right;"></td>
      <td><input class="i-link" placeholder="‡πÄ‡∏ä‡πà‡∏ô 8.6.1 / 8.6.2 / ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..." value="${row.linkTo.replace(/"/g,'&quot;')}"></td>
      <td><input class="i-note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" value="${row.note.replace(/"/g,'&quot;')}"></td>
      <td class="text-center">
        <button class="btn btn-ghost btn-sm btn-row-attach">üìé ‡πÅ‡∏ô‡∏ö</button>
        <div class="attach-list row-attach-list">-</div>
        <input type="file" multiple class="row-file-input" style="display:none;">
      </td>
      <td class="text-center"><button class="btn btn-ghost btn-sm btn-row-del">‚úñ</button></td>
    `;
    tbody.appendChild(tr);
    bindRowEvents(tr,id);
    updatePreview();
  }

  function bindRowEvents(tr,id){
    const row = ()=>state.items.find(r=>r.id===id);
    tr.querySelector('.i-desc').addEventListener('input',e=>{row().description=e.target.value;updatePreview();});
    tr.querySelector('.i-amt').addEventListener('input',e=>{row().amount=e.target.value;updatePreview();});
    tr.querySelector('.i-link').addEventListener('input',e=>{row().linkTo=e.target.value;updatePreview();});
    tr.querySelector('.i-note').addEventListener('input',e=>{row().note=e.target.value;updatePreview();});
    const fi = tr.querySelector('.row-file-input');
    const al = tr.querySelector('.row-attach-list');
    tr.querySelector('.btn-row-attach').onclick = ()=>fi.click();
    fi.onchange = e=>{
      const names = Array.from(e.target.files).map(f=>f.name);
      row().attachments = names;
      al.textContent = names.length?names.join(', '):'-';
      updatePreview();
    };
    tr.querySelector('.btn-row-del').onclick = ()=>{
      const idx = state.items.findIndex(r=>r.id===id);
      if(idx>=0) state.items.splice(idx,1);
      tr.remove();
      document.querySelectorAll('#itemsTable tbody tr').forEach((r,i)=>r.querySelector('td').textContent=i+1);
      updatePreview();
    };
  }

  function setupSectionAttach(key,inputId,listId){
    const btn = document.querySelector(`[data-section-attach="${key}"]`);
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);
    if(!btn||!input||!list) return;
    btn.onclick = ()=>input.click();
    input.onchange = e=>{
      const names = Array.from(e.target.files).map(f=>f.name);
      state[key+'Files']=names;
      list.textContent = names.length?names.join(', '):`‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÅ‡∏ô‡∏ö (‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà ${key==='main'?'1':key==='summary'?'2':'3'})`;
      updatePreview();
    };
  }

  function autoAttachFromWP(){
    const mock = [`${FORM_CODE.toLowerCase()}_wp_01.pdf`,`${FORM_CODE.toLowerCase()}_wp_02.xlsx`];
    state.mainFiles = mock;
    document.getElementById('fileMainSectionList').textContent = mock.join(', ');
    logRouteConsole('autoAttachFromWP(): mock '+mock.join(', '));
    updatePreview();
  }

  function loadFromDB(){
    const unit=document.getElementById('unitName').value||'(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)';
    const year=document.getElementById('fiscalYear').value||'(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)';
    logRouteConsole(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏•‡∏≠‡∏á: unit=${unit}, year=${year}, form=${FORM_CODE}`);
    state.items=[];document.querySelector('#itemsTable tbody').innerHTML='';
    addItemRow({description:'‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏™‡∏¥‡∏ô‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏£‡∏ß‡∏°',amount:'1000000.00',linkTo:'8.6.1',note:'mock'});
    addItemRow({description:'‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô‡∏£‡∏ß‡∏°',amount:'500000.00',linkTo:'8.6.2',note:'mock'});
  }

  function aiSummarize(){
    const items = state.items||[];
    if(!items.length){alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô Lead ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô');return;}
    let total=0;items.forEach(r=>{
      const v=parseFloat((r.amount||'0').toString().replace(/,/g,''))||0;total+=v;
    });
    const unit=document.getElementById('unitName').value||'‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à';
    const year=document.getElementById('fiscalYear').value||'‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ...';
    const txt =
      `‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡∏≥‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ ‡∏≠‡∏õ‡∏ó. 8.6 ‡∏Ç‡∏≠‡∏á ${unit} ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${year} `+
      `‡∏û‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ï‡∏≤‡∏° Lead Sheet ‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì `+
      `${total.toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2})} ‡∏ö‡∏≤‡∏ó `+
      `‡πÇ‡∏î‡∏¢‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ï‡∏≤‡∏°‡πÅ‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö 8.6.1, 8.6.1.1 ‡πÅ‡∏•‡∏∞ 8.6.2 ‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß`;
    const area=document.getElementById('summaryText');
    area.value = area.value.trim()?area.value.trim()+`\n\n[AI ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏™‡∏£‡∏¥‡∏°]\n`+txt:txt;
    updatePreview();
  }

  function runQA(){
    const msgs=[];
    const unit=document.getElementById('unitName').value.trim();
    const year=document.getElementById('fiscalYear').value;
    const items=state.items||[];
    const summary=document.getElementById('summaryText').value.trim();
    const recommend=document.getElementById('recommendText').value.trim();
    const auditor=document.getElementById('auditorName').value.trim();
    const pos=document.getElementById('auditorPosition').value.trim();
    const date=document.getElementById('auditDate').value;

    if(!unit) msgs.push({type:'warn',text:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à'});
    if(!year) msgs.push({type:'warn',text:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì'});
    if(!items.length) msgs.push({type:'error',text:'‡∏ï‡∏≤‡∏£‡∏≤‡∏á Lead ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢'});
    if(!summary) msgs.push({type:'warn',text:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2'});
    if(!recommend) msgs.push({type:'warn',text:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3'});
    if(!auditor||!pos||!date) msgs.push({type:'warn',text:'‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö / ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á / ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö'});

    const nonNum = items.filter(r=>r.amount && isNaN(parseFloat(r.amount.toString().replace(/,/g,''))));
    if(nonNum.length) msgs.push({type:'error',text:`‡∏û‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô ${nonNum.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç`});

    if(!msgs.length) msgs.push({type:'ok',text:'‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏ä‡∏¥‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ô ‡∏≠‡∏õ‡∏ó. 8.6 ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô'});

    state.qaMessages=msgs;state.qaRan=true;
    const list=document.getElementById('qaList');list.innerHTML='';
    msgs.forEach(m=>{
      const li=document.createElement('li');li.className='qa-item';
      const icon=m.type==='error'?'‚õî':m.type==='warn'?'‚ö†Ô∏è':'‚úÖ';
      li.innerHTML=`<span class="icon">${icon}</span><span>${m.text}</span>`;
      list.appendChild(li);
    });
    const cb=document.querySelector('[data-check="step6"]');if(cb) cb.checked=true;
    updatePreview();
  }

  function checklistState(){
    const o={};document.querySelectorAll('#checklist input').forEach(cb=>o[cb.dataset.check]=cb.checked);return o;
  }

  function updatePreview(){
    const data={
      formCode:FORM_CODE,
      meta:{
        unit:document.getElementById('unitName').value.trim(),
        location:document.getElementById('unitLocation').value.trim(),
        fiscalYear:document.getElementById('fiscalYear').value||null,
        period:document.getElementById('period').value,
        auditorName:document.getElementById('auditorName').value.trim(),
        auditorPosition:document.getElementById('auditorPosition').value.trim(),
        auditDate:document.getElementById('auditDate').value||null
      },
      section1:{items:state.items},
      sectionFiles:{
        main:state.mainFiles,
        summary:state.summaryFiles,
        recommend:state.recommendFiles
      },
      section2:{summaryText:document.getElementById('summaryText').value.trim()},
      section3:{recommendText:document.getElementById('recommendText').value.trim()},
      qa:{ran:state.qaRan,messages:state.qaMessages},
      checklist:checklistState(),
      routing:{
        review:document.getElementById('routeReview').checked,
        db:document.getElementById('routeDB').checked,
        dashboard:document.getElementById('routeDashboard').checked,
        notes:document.getElementById('routeNotes').checked
      },
      apiComment:document.getElementById('apiComment').value.trim()
    };
    document.getElementById('currentDataPreview').textContent = JSON.stringify(data,null,2);
  }

  function handleExport(){
    const ck = checklistState();
    const allOK = Object.values(ck).every(v=>v);
    const msgs=[];
    if(!allOK) msgs.push('Checklist ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö');
    if(!state.qaRan) msgs.push('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏£‡∏±‡∏ô QA');
    if((state.items||[]).length===0) msgs.push('‡∏ï‡∏≤‡∏£‡∏≤‡∏á Lead ‡∏ß‡πà‡∏≤‡∏á');

    if(msgs.length){
      document.getElementById('stepWarningText').textContent =
        '‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î: '+msgs.join(' / ');
      openModal('stepWarningModal');
    }else doExport(false);
  }

  function doExport(override){
    updatePreview();
    const type=document.getElementById('exportType').value;
    const dataStr=document.getElementById('currentDataPreview').textContent||'{}';
    const routing={
      review:document.getElementById('routeReview').checked,
      db:document.getElementById('routeDB').checked,
      dashboard:document.getElementById('routeDashboard').checked,
      notes:document.getElementById('routeNotes').checked
    };
    logRouteConsole(`Export type=${type}, override=${override}, routing=${JSON.stringify(routing)}`);

    if(type==='print'){
      window.print();
    }else if(type==='json'){
      const blob=new Blob([dataStr],{type:'application/json'});
      const a=document.createElement('a');
      const unit=(document.getElementById('unitName').value||'unit').replace(/\s+/g,'_');
      const yr=document.getElementById('fiscalYear').value||'year';
      a.href=URL.createObjectURL(blob);a.download=`${FORM_CODE.toLowerCase()}_${unit}_${yr}.json`;a.click();
      URL.revokeObjectURL(a.href);alert('‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö backend)');
    }else if(type==='docx'){
      alert('DOCX: ‡πÉ‡∏´‡πâ backend ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å JSON ‡∏ô‡∏µ‡πâ (‡πÄ‡∏ä‡πà‡∏ô /api/fa/lg/8_6/export/docx)');
    }else if(type==='xlsx'){
      alert('XLSX: ‡πÉ‡∏´‡πâ backend ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å JSON ‡∏ô‡∏µ‡πâ (‡πÄ‡∏ä‡πà‡∏ô /api/fa/lg/8_6/export/xlsx)');
    }
  }

  function logRouteConsole(msg){
    const c=document.getElementById('routeConsole');
    const t=new Date().toLocaleTimeString('th-TH',{hour12:false});
    c.textContent+=`\n[${t}] ${msg}`;c.scrollTop=c.scrollHeight;
  }

  function openModal(id){const m=document.getElementById(id);if(m)m.style.display='flex';}
  function closeModal(id){const m=document.getElementById(id);if(m)m.style.display='none';}

  function saveDraft(){
    updatePreview();
    const d=document.getElementById('currentDataPreview').textContent||'{}';
    localStorage.setItem('fa_draft_'+FORM_CODE,d);
    alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡πà‡∏≤‡∏á‡∏•‡∏á browser (localStorage) ‡πÅ‡∏•‡πâ‡∏ß ‚Äì ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏¢‡∏¥‡∏á API /saveDraft ‡πÅ‡∏ó‡∏ô‡πÑ‡∏î‡πâ');
  }
  function loadDraftIfAny(){
    const d=localStorage.getItem('fa_draft_'+FORM_CODE);
    if(d) logRouteConsole('‡∏û‡∏ö draft ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏ô localStorage (‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ auto-restore)');
  }

  // init
  initYears();
  addItemRow({});
  setupSectionAttach('main','fileMainSection','fileMainSectionList');
  setupSectionAttach('summary','fileSummarySection','fileSummarySectionList');
  setupSectionAttach('recommend','fileRecommendSection','fileRecommendSectionList');
  document.getElementById('btnAddRow').onclick=()=>addItemRow({});
  document.getElementById('btnAutoAttachWP').onclick=autoAttachFromWP;
  document.getElementById('btnLoadFromDB').onclick=loadFromDB;
  document.getElementById('btnAISummarize').onclick=aiSummarize;
  document.getElementById('btnRunQA').onclick=runQA;
  document.getElementById('btnExport').onclick=handleExport;
  document.getElementById('btnSaveDraft').onclick=saveDraft;
  document.getElementById('btnResetForm').onclick=()=>{if(confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) location.reload();};
  document.getElementById('btnBackToEdit').onclick=()=>closeModal('stepWarningModal');
  document.getElementById('btnAskForHelp').onclick=()=>{alert('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÄ‡∏õ‡∏¥‡∏î‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠ / FAQ ‡∏´‡∏£‡∏∑‡∏≠ chat ‡∏Å‡∏±‡∏ö Admin');closeModal('stepWarningModal');};
  document.getElementById('btnOverrideProceed').onclick=()=>{
    state.overrideCount++;closeModal('stepWarningModal');
    if(state.overrideCount>=3) openModal('consultModal');
    doExport(true);
  };
  document.getElementById('btnNeedConsult').onclick=()=>{alert('‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏Ñ‡∏≥‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç/‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡∏°');closeModal('consultModal');};
  document.getElementById('btnNoConsult').onclick=()=>closeModal('consultModal');

  document.getElementById('routeSearch').addEventListener('input',e=>{
    const q=e.target.value.toLowerCase().trim();
    document.querySelectorAll('#routeGrid .route-item').forEach(it=>{
      const label=(it.dataset.routeLabel||it.textContent||'').toLowerCase();
      it.style.display=q?(label.includes(q)?'':''):'';});
  });

  ['unitName','unitLocation','fiscalYear','period','summaryText','recommendText',
   'auditorName','auditorPosition','auditDate','apiComment'
  ].forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    const ev=(el.tagName==='SELECT'||el.type==='date')?'change':'input';
    el.addEventListener(ev,updatePreview);
  });

  loadDraftIfAny();
  updatePreview();
</script>
</body>
</html>
