<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>FA DB | ระบบค้นหาข้อมูล อปท. (Advanced)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
  :root{
    --bg:#0f172a;
    --card:#1e293b;
    --border:#334155;
    --accent:#3b82f6;
    --accent-hover:#2563eb;
    --text:#f1f5f9;
    --muted:#94a3b8;
    --success:#22c55e;
    --warning:#eab308;
    --danger:#ef4444;
  }
  *{box-sizing:border-box;}

  body{
    margin:0;
    font-family:"Sarabun", "Segoe UI", Tahoma, sans-serif;
    background:var(--bg);
    color:var(--text);
    font-size: 14px;
  }

  header{
    padding:20px 16px;
    background:linear-gradient(135deg,#1e1b4b,#312e81);
    border-bottom:1px solid var(--border);
    box-shadow:0 4px 20px rgba(0,0,0,0.5);
  }
  header h1{margin:0;font-size:24px;font-weight:700;color:#fff;}
  header p{margin:5px 0 0;font-size:14px;color:var(--muted);}

  .wrap{
    max-width:1280px;
    margin:20px auto;
    padding:0 16px;
  }

  .card{
    background:var(--card);
    border-radius:12px;
    border:1px solid var(--border);
    padding:20px;
    margin-bottom:20px;
    box-shadow:0 4px 6px -1px rgba(0,0,0,0.3);
  }

  h2{
    margin:0 0 15px;
    font-size:18px;
    color:var(--accent);
    display:flex;
    align-items:center;
    gap:10px;
  }

  /* Grid Layouts */
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:15px;
  }

  /* Inputs */
  label{display:block;margin-bottom:6px;font-size:13px;color:var(--muted);}
  input,select{
    width:100%;
    padding:10px;
    border-radius:6px;
    background:#0f172a;
    border:1px solid var(--border);
    color:var(--text);
    font-size:14px;
    transition:0.2s;
  }
  input:focus,select:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 0 2px rgba(59,130,246,0.2);
  }

  /* Advanced Section */
  .advanced-panel{
    margin-top:15px;
    padding-top:15px;
    border-top:1px dashed var(--border);
    display:none; /* Hidden by default */
  }
  .advanced-panel.show{
    display:block;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from{opacity:0;transform:translateY(-10px);} to{opacity:1;transform:translateY(0);} }

  /* Buttons */
  .btn-row{
    margin-top:20px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  button{
    border:none;
    padding:10px 18px;
    border-radius:6px;
    cursor:pointer;
    font-size:14px;
    font-weight:600;
    transition:0.2s;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }
  button:hover{transform:translateY(-1px);filter:brightness(1.1);}
  
  .btn-primary{background:var(--accent);color:#fff;}
  .btn-success{background:var(--success);color:#052e16;}
  .btn-secondary{background:#334155;color:#e2e8f0;}
  .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted);}
  .btn-ghost:hover{background:var(--border);color:#fff;}

  /* Table */
  .table-responsive{overflow-x:auto;}
  table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    white-space:nowrap;
  }
  th,td{
    padding:12px 10px;
    border-bottom:1px solid var(--border);
    text-align:left;
  }
  th{
    background:#0f172a;
    color:var(--accent);
    font-weight:600;
    text-transform:uppercase;
    font-size:12px;
  }
  tr:hover{background:rgba(59,130,246,0.05);}

  /* Tags & Links */
  .tag{
    padding:2px 8px;
    border-radius:4px;
    font-size:11px;
    background:#334155;
    color:#cbd5e1;
  }
  .tag.audit-ok{background:rgba(34,197,94,0.2);color:var(--success);}
  .tag.audit-pending{background:rgba(234,179,8,0.2);color:var(--warning);}

  .btn-link-group{
    display:flex;
    gap:4px;
  }
  .action-btn{
    text-decoration:none;
    font-size:11px;
    padding:4px 8px;
    border-radius:4px;
    background:#334155;
    color:#94a3b8;
    transition:0.2s;
  }
  .action-btn:hover{background:var(--accent);color:#fff;}
  .action-btn.web{border:1px solid var(--accent);color:var(--accent);background:transparent;}
  .action-btn.web:hover{background:var(--accent);color:#fff;}

  /* Auto Suggest */
  .suggest-box{
    position:absolute;
    background:#1e293b;
    border:1px solid var(--accent);
    width:100%;
    max-height:250px;
    overflow-y:auto;
    z-index:100;
    border-radius:0 0 8px 8px;
    box-shadow:0 10px 25px rgba(0,0,0,0.5);
    display:none;
  }
  .suggest-item{
    padding:10px;
    cursor:pointer;
    border-bottom:1px solid var(--border);
    color:var(--text);
  }
  .suggest-item:hover{background:var(--accent);color:#fff;}
  .suggest-highlight{color:var(--accent2);font-weight:bold;}

  .stat-text{font-size:13px;color:var(--muted);margin-left:auto;}
</style>
</head>
<body>

<header>
  <div class="wrap" style="margin:0 auto; padding:0;">
    <h1><i class="fas fa-database"></i> ระบบค้นหาข้อมูล อปท. แบบบูรณาการ</h1>
    <p>เชื่อมโยงข้อมูล ฐานข้อมูลกลาง, งบการเงิน, และรายงานภายนอก</p>
  </div>
</header>

<div class="wrap">

  <div class="card">
    <h2><i class="fas fa-search"></i> ค้นหาข้อมูล</h2>

    <div class="grid">
      <div style="position:relative;">
        <label>ชื่อหน่วยงาน / หน่วยรับตรวจ</label>
        <input id="q-unit" placeholder="พิมพ์ชื่อ เช่น เทศบาลเมืองศรีสะเกษ..." autocomplete="off">
        <div id="suggest-box" class="suggest-box"></div>
      </div>

      <div>
        <label>จังหวัด</label>
        <select id="q-province">
          <option value="">-- ทุกจังหวัด --</option>
        </select>
      </div>

      <div>
        <label>อำเภอ</label>
        <input id="q-district" placeholder="ระบุอำเภอ">
      </div>
      
      <div>
        <label>ประเภท อปท.</label>
        <select id="q-type">
            <option value="">-- ทั้งหมด --</option>
            <option value="อบจ.">องค์การบริหารส่วนจังหวัด (อบจ.)</option>
            <option value="เทศบาลนคร">เทศบาลนคร</option>
            <option value="เทศบาลเมือง">เทศบาลเมือง</option>
            <option value="เทศบาลตำบล">เทศบาลตำบล</option>
            <option value="อบต.">องค์การบริหารส่วนตำบล (อบต.)</option>
        </select>
      </div>
    </div>

    <div style="margin-top:15px;">
        <button class="btn-ghost" id="btnToggleAdv" style="width:100%; justify-content:center; padding:5px;">
            <i class="fas fa-chevron-down"></i> ตัวเลือกการค้นหาขั้นสูง (งบการเงิน / สถานะ)
        </button>
    </div>

    <div class="advanced-panel" id="advPanel">
        <div class="grid">
            <div>
                <label>ปีงบประมาณ</label>
                <select id="q-year">
                    <option value="">ทั้งหมด</option>
                    <option value="2568">2568</option>
                    <option value="2567">2567</option>
                    <option value="2566">2566</option>
                </select>
            </div>
            <div>
                <label>สถานะการส่งงบการเงิน</label>
                <select id="q-finance-status">
                    <option value="">-- ทั้งหมด --</option>
                    <option value="sent">ส่งแล้ว</option>
                    <option value="pending">ยังไม่ส่ง</option>
                </select>
            </div>
            <div>
                <label>สถานะการตรวจสอบ</label>
                <select id="q-audit-status">
                    <option value="">-- ทั้งหมด --</option>
                    <option value="done">ตรวจสอบแล้ว</option>
                    <option value="process">อยู่ระหว่างตรวจสอบ</option>
                </select>
            </div>
            <div>
                <label>สถานะการติดตาม</label>
                <select id="q-tracking">
                    <option value="">-- ทั้งหมด --</option>
                    <option value="normal">ปกติ</option>
                    <option value="watch">ต้องติดตามพิเศษ</option>
                </select>
            </div>
        </div>
    </div>

    <div class="btn-row">
      <button class="btn-primary" id="btnSearch"><i class="fas fa-search"></i> ค้นหา</button>
      <button class="btn-success" id="btnShowAll"><i class="fas fa-list"></i> แสดงทั้งหมดในระบบ</button>
      <button class="btn-secondary" id="btnClear"><i class="fas fa-undo"></i> ล้างค่า</button>
      <button class="btn-secondary" id="btnExport"><i class="fas fa-file-csv"></i> Export CSV</button>
      
      <div class="stat-text" id="searchStat">พร้อมใช้งาน (กด "แสดงทั้งหมด" เพื่อดูข้อมูล)</div>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h2><i class="fas fa-table"></i> ผลการค้นหา</h2>
        <span style="font-size:12px;color:var(--muted);" id="lastUpdate"></span>
    </div>
    
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th style="width:50px;">#</th>
            <th>ชื่อหน่วยงาน</th>
            <th>จังหวัด</th>
            <th>อำเภอ</th>
            <th>ประเภท</th>
            <th>สถานะตรวจสอบ</th>
            <th>เครื่องมือเชื่อมโยงข้อมูลภายนอก (Web Services)</th>
          </tr>
        </thead>
        <tbody id="dataBody">
            </tbody>
      </table>
    </div>
  </div>

</div>

<script>
/* ===== 1. MOCK DATA (จำลองข้อมูลสำหรับทดสอบ) ===== */
/* ในการใช้งานจริง ข้อมูลจะมาจาก localStorage หรือ API */
const MOCK_DATA = [
    { code: "1001", name: "เทศบาลเมืองศรีสะเกษ", unit: "เทศบาลเมืองศรีสะเกษ", province: "ศรีสะเกษ", district: "เมืองศรีสะเกษ", type: "เทศบาลเมือง", website: "http://www.musisaket.go.th", auditStatus: "done", financeStatus: "sent" },
    { code: "1002", name: "อบต.หนองไผ่", unit: "องค์การบริหารส่วนตำบลหนองไผ่", province: "ศรีสะเกษ", district: "เมืองศรีสะเกษ", type: "อบต.", website: "", auditStatus: "process", financeStatus: "pending" },
    { code: "1003", name: "อบต.โพธิ์", unit: "องค์การบริหารส่วนตำบลโพธิ์", province: "ศรีสะเกษ", district: "เมืองศรีสะเกษ", type: "อบต.", website: "http://www.pho.go.th", auditStatus: "done", financeStatus: "sent" },
    { code: "2001", name: "เทศบาลนครอุบลราชธานี", unit: "เทศบาลนครอุบลราชธานี", province: "อุบลราชธานี", district: "เมืองอุบลราชธานี", type: "เทศบาลนคร", website: "http://www.cityub.go.th", auditStatus: "done", financeStatus: "sent" },
    { code: "2002", name: "อบต.ไร่น้อย", unit: "องค์การบริหารส่วนตำบลไร่น้อย", province: "อุบลราชธานี", district: "เมืองอุบลราชธานี", type: "อบต.", website: "", auditStatus: "process", financeStatus: "pending" }
];

// Load Data Function
const KEY = "fa-db-data-gov";
let DB = [];

function loadDB(){
    // พยายามโหลดจาก LocalStorage ก่อน ถ้าไม่มีให้ใช้ Mock Data
    const stored = localStorage.getItem(KEY);
    if(stored){
        DB = JSON.parse(stored);
    } else {
        DB = MOCK_DATA; // ใช้ข้อมูลจำลองถ้าไม่มี DB จริง
        // บันทึก Mock data ลง LocalStorage เพื่อให้ระบบทำงานต่อได้
        localStorage.setItem(KEY, JSON.stringify(DB)); 
    }
}

/* ===== 2. RENDER TABLE & LOGIC ===== */

// Helper: สร้าง Google Search Link (Dorking)
function getSearchLink(keyword, siteUrl, textBtn, icon){
    // ถ้ามีเว็บ ให้ใช้ site:domain ถ้าไม่มีให้ค้นชื่อหน่วยงานแทน
    const query = siteUrl 
        ? `${keyword} site:${new URL(siteUrl).hostname}` 
        : `${keyword}`;
    
    const url = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
    
    return `<a href="${url}" target="_blank" class="action-btn" title="ค้นหา ${keyword}"><i class="${icon}"></i> ${textBtn}</a>`;
}

function renderTable(rows){
  const tb = document.getElementById("dataBody");
  tb.innerHTML = "";

  if(rows.length === 0){
    tb.innerHTML = `<tr><td colspan="7" style="text-align:center;padding:30px;color:var(--muted);">ไม่พบข้อมูลที่ค้นหา</td></tr>`;
    return;
  }

  rows.forEach((r,i)=>{
    const tr = document.createElement("tr");
    
    // Status Tag Logic
    let statusBadge = r.auditStatus === 'done' 
        ? `<span class="tag audit-ok"><i class="fas fa-check-circle"></i> ตรวจแล้ว</span>` 
        : `<span class="tag audit-pending"><i class="fas fa-clock"></i> รอตรวจ</span>`;

    // Website Logic
    let webBtn = "";
    let cleanUrl = r.website;
    
    // External Data Buttons (เชื่อมข้อมูลภายนอก)
    // 1. ปุ่มเข้าเว็บหลัก
    if(r.website && r.website.length > 5) {
        webBtn = `<a href="${r.website}" target="_blank" class="action-btn web"><i class="fas fa-globe"></i> เว็บไซต์</a>`;
    } else {
        // ถ้าไม่มีเว็บ ให้ปุ่มเป็นค้นหาเว็บ
        webBtn = `<a href="https://www.google.com/search?q=${encodeURIComponent(r.name)}" target="_blank" class="action-btn"><i class="fab fa-google"></i> หาเว็บ</a>`;
    }

    // 2. สร้างปุ่มค้นหาเฉพาะทาง (งบการเงิน, แผน, รายงาน)
    // ใช้เทคนิค Google Dorking เพื่อเจาะจงหาไฟล์ PDF/Doc ในเว็บหน่วยงานนั้น
    const siteRef = r.website || r.name; // ถ้ามีเว็บใช้เว็บ ถ้าไม่มีใช้ชื่อค้นหา
    const btnFinance = getSearchLink("งบการเงิน " + r.name, r.website, "งบฯ", "fas fa-file-invoice-dollar");
    const btnPlan    = getSearchLink("แผนพัฒนาท้องถิ่น " + r.name, r.website, "แผนฯ", "fas fa-project-diagram");
    const btnRule    = getSearchLink("เทศบัญญัติ " + r.name, r.website, "บัญญัติ", "fas fa-gavel");

    tr.innerHTML = `
      <td>${i+1}</td>
      <td>
        <div style="font-weight:600;color:#fff;">${r.name}</div>
        <div style="font-size:12px;color:var(--muted);">${r.code || '-'}</div>
      </td>
      <td>${r.province || '-'}</td>
      <td>${r.district || '-'}</td>
      <td>${r.type || '-'}</td>
      <td>${statusBadge}</td>
      <td>
        <div class="btn-link-group">
            ${webBtn}
            ${btnFinance}
            ${btnPlan}
            ${btnRule}
            <a href="fa-lg-view.html?code=${r.code}" class="action-btn" style="background:var(--accent);color:#fff;"><i class="fas fa-search-plus"></i> รายละเอียด</a>
        </div>
      </td>
    `;
    tb.appendChild(tr);
  });
}

/* ===== 3. SEARCH LOGIC ===== */
function normalize(t){ return (t||"").toLowerCase().trim(); }

function doSearch(showAll=false){
  let result = DB;

  if(!showAll){
    // Basic Fields
    const qUnit = normalize(document.getElementById("q-unit").value);
    const qProv = document.getElementById("q-province").value; // ไม่ normalize เพราะ value มาจาก option ที่ตรงกัน
    const qDist = normalize(document.getElementById("q-district").value);
    const qType = document.getElementById("q-type").value;

    // Advanced Fields
    const qAudit = document.getElementById("q-audit-status").value;
    const qFinance = document.getElementById("q-finance-status").value;

    // Filter Logic
    result = result.filter(r => {
        // Name Check
        const matchName = !qUnit || normalize(r.name).includes(qUnit) || normalize(r.unit).includes(qUnit);
        
        // Province Check (แก้ไข Bug: ใช้ includes หรือ exact match ก็ได้เพื่อความชัวร์)
        const matchProv = !qProv || (r.province && r.province.includes(qProv));

        // District Check
        const matchDist = !qDist || normalize(r.district).includes(qDist);

        // Type Check
        const matchType = !qType || normalize(r.type).includes(normalize(qType));

        // Advanced Checks (Mock Logic: ถ้าไม่มี field ใน DB ถือว่าผ่าน)
        const matchAudit = !qAudit || (r.auditStatus === qAudit);
        const matchFinance = !qFinance || (r.financeStatus === qFinance);

        return matchName && matchProv && matchDist && matchType && matchAudit && matchFinance;
    });
  }

  renderTable(result);
  
  const statText = showAll 
    ? `แสดงข้อมูลทั้งหมด ${result.length} รายการ`
    : `ค้นหาพบ ${result.length} รายการ`;
  
  document.getElementById("searchStat").innerHTML = statText;
}

/* ===== 4. SETUP & UTILS ===== */
function fillProvinces(){
  const sel = document.getElementById("q-province");
  const provs = new Set();
  DB.forEach(r=>{ if(r.province) provs.add(r.province.trim()); });
  
  [...provs].sort().forEach(p=>{
    const o = document.createElement("option");
    o.value = p;
    o.textContent = p;
    sel.appendChild(o);
  });
}

function clearForm(){
  document.querySelectorAll("input, select").forEach(el => el.value = "");
  document.getElementById("dataBody").innerHTML = "";
  document.getElementById("searchStat").textContent = "ล้างค่าเรียบร้อย";
}

function toggleAdvanced(){
    const panel = document.getElementById("advPanel");
    const btn = document.getElementById("btnToggleAdv");
    if(panel.style.display === "block"){
        panel.style.display = "none";
        panel.classList.remove("show");
        btn.innerHTML = `<i class="fas fa-chevron-down"></i> ตัวเลือกการค้นหาขั้นสูง (งบการเงิน / สถานะ)`;
    } else {
        panel.style.display = "block";
        setTimeout(()=>panel.classList.add("show"), 10);
        btn.innerHTML = `<i class="fas fa-chevron-up"></i> ซ่อนตัวเลือกขั้นสูง`;
    }
}

// Export CSV
function exportCSV(){
    if(document.querySelectorAll("#dataBody tr").length === 0) { alert("ไม่มีข้อมูลให้ Export"); return; }
    // (Logic เดิมที่ปรับปรุงเล็กน้อย)
    const rows = DB; 
    const header = ["Code","Name","Province","Type","Website"];
    let csvContent = "data:text/csv;charset=utf-8," + header.join(",") + "\n";
    rows.forEach(r => {
        csvContent += `${r.code},"${r.name}","${r.province}","${r.type}","${r.website}"\n`;
    });
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "fa_db_export.csv");
    document.body.appendChild(link);
    link.click();
}

/* ===== 5. AUTO SUGGEST (FIXED) ===== */
const inputUnit = document.getElementById("q-unit");
const suggestBox = document.getElementById("suggest-box");

inputUnit.addEventListener("input", function(){
    const val = this.value.toLowerCase();
    suggestBox.innerHTML = "";
    if(!val) { suggestBox.style.display = "none"; return; }

    // ใช้ DB ตัวใหญ่ (แก้ Bug เดิมที่ใช้ db ตัวเล็ก)
    const matches = DB.filter(r => normalize(r.name).includes(val)).slice(0, 10);

    if(matches.length > 0){
        suggestBox.style.display = "block";
        matches.forEach(r => {
            const div = document.createElement("div");
            div.className = "suggest-item";
            // Highlight text
            const text = r.name.replace(new RegExp(val, "gi"), (match) => `<span class="suggest-highlight">${match}</span>`);
            div.innerHTML = `${text} <small style="color:var(--muted)">(${r.province})</small>`;
            div.addEventListener("click", () => {
                inputUnit.value = r.name;
                document.getElementById("q-province").value = r.province; // Auto fill province
                suggestBox.style.display = "none";
                doSearch(); // Auto search
            });
            suggestBox.appendChild(div);
        });
    } else {
        suggestBox.style.display = "none";
    }
});

// Close suggest when click outside
document.addEventListener("click", function(e){
    if(e.target !== inputUnit && e.target !== suggestBox){
        suggestBox.style.display = "none";
    }
});

/* ===== INIT ===== */
window.onload = () => {
    loadDB();
    fillProvinces();
    
    // Events
    document.getElementById("btnSearch").onclick = () => doSearch(false);
    document.getElementById("btnShowAll").onclick = () => doSearch(true); // ปุ่มแสดงทั้งหมด
    document.getElementById("btnClear").onclick = clearForm;
    document.getElementById("btnToggleAdv").onclick = toggleAdvanced;
    document.getElementById("btnExport").onclick = exportCSV;

    // ถ้าเปิดมาอยากให้แสดงทั้งหมดเลยให้เปิดบรรทัดนี้:
    // doSearch(true);
};

</script>

</body>
</html>
